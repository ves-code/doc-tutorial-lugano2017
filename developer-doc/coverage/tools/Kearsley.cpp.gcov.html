<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - plumed test coverage - tools/Kearsley.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">tools</a> - Kearsley.cpp<span style="font-size: 80%;"> (source / <a href="Kearsley.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">plumed test coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">1</td>
            <td class="headerCovTableEntry">486</td>
            <td class="headerCovTableEntryLo">0.2 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-02-14</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">2</td>
            <td class="headerCovTableEntry">8</td>
            <td class="headerCovTableEntryLo">25.0 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</a>
<span class="lineNum">       2 </span>            :    Copyright (c) 2011-2016 The plumed team
<span class="lineNum">       3 </span>            :    (see the PEOPLE file at the root of the distribution for a list of names)
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            :    See http://www.plumed.org for more information.
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            :    This file is part of plumed, version 2.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :    plumed is free software: you can redistribute it and/or modify
<span class="lineNum">      10 </span>            :    it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      11 </span>            :    the Free Software Foundation, either version 3 of the License, or
<span class="lineNum">      12 </span>            :    (at your option) any later version.
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            :    plumed is distributed in the hope that it will be useful,
<span class="lineNum">      15 </span>            :    but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      16 </span>            :    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      17 </span>            :    GNU Lesser General Public License for more details.
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            :    You should have received a copy of the GNU Lesser General Public License
<span class="lineNum">      20 </span>            :    along with plumed.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
<span class="lineNum">      21 </span>            : +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
<span class="lineNum">      22 </span>            : #include &quot;Kearsley.h&quot;
<span class="lineNum">      23 </span>            : #include &lt;cmath&gt;
<span class="lineNum">      24 </span>            : #include &lt;iostream&gt;
<span class="lineNum">      25 </span>            : #include &lt;cstdlib&gt;
<span class="lineNum">      26 </span>            : #include &quot;Matrix.h&quot;
<span class="lineNum">      27 </span>            : #include &quot;Tensor.h&quot;
<span class="lineNum">      28 </span>            : #include &quot;Log.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;Matrix.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;Random.h&quot;
<span class="lineNum">      31 </span>            : 
<span class="lineNum">      32 </span>            : using namespace std;
<span class="lineNum">      33 </span>            : namespace PLMD{
<span class="lineNum">      34 </span>            : 
<a name="35"><span class="lineNum">      35 </span>            : // put some notes</a>
<span class="lineNum">      36 </span>            : 
<span class="lineNum">      37 </span><span class="lineNoCov">          0 : Kearsley::Kearsley(const vector&lt;Vector&gt; &amp;p0, const vector&lt;Vector&gt; &amp;p1, const vector&lt;double&gt; &amp;align, Log* &amp;log):</span>
<span class="lineNum">      38 </span>            :         log(log),
<span class="lineNum">      39 </span>            :         p0(p0),
<span class="lineNum">      40 </span>            :         p1(p1),
<span class="lineNum">      41 </span>            :         align(align),
<span class="lineNum">      42 </span>            :         com0_is_removed(false),
<span class="lineNum">      43 </span>            :         com1_is_removed(false),
<span class="lineNum">      44 </span><span class="lineNoCov">          0 :         err(0.0)</span>
<span class="lineNum">      45 </span>            : {
<span class="lineNum">      46 </span>            :         // now make an initial allocation
<span class="lineNum">      47 </span>            : //      int n=p0.size();
<span class="lineNum">      48 </span>            :         // eventually here one should make a &quot;hard&quot; resize of all the structures
<span class="lineNum">      49 </span>            : //      log-&gt;printf(&quot;Reallocating a size of %d atoms to kearsley structure\n&quot;,n);
<span class="lineNum">      50 </span>            : 
<span class="lineNum">      51 </span>            : //      try{
<span class="lineNum">      52 </span>            : //              diff.resize(n);
<span class="lineNum">      53 </span>            : //      }catch(bad_alloc&amp;) {
<span class="lineNum">      54 </span>            : //              cerr&lt;&lt;&quot;Cannot allocate the vector in Kearsley&quot;&lt;&lt;endl;
<span class="lineNum">      55 </span>            : //      }
<span class="lineNum">      56 </span>            : //      try{
<span class="lineNum">      57 </span>            : //              diff.resize(n);
<span class="lineNum">      58 </span>            : //      }catch(bad_alloc&amp;) {
<span class="lineNum">      59 </span>            : //              cerr&lt;&lt;&quot;Cannot allocate the vector in Kearsley&quot;&lt;&lt;endl;
<span class="lineNum">      60 </span>            : //      }
<span class="lineNum">      61 </span>            : 
<span class="lineNum">      62 </span><span class="lineNoCov">          0 : }</span>
<a name="63"><span class="lineNum">      63 </span>            : // do the alignment</a>
<span class="lineNum">      64 </span>            : 
<span class="lineNum">      65 </span><span class="lineNoCov">          0 : double Kearsley::calculate(bool rmsd) {</span>
<span class="lineNum">      66 </span>            :         // just an ad-hoc scaling factor
<span class="lineNum">      67 </span><span class="lineNoCov">          0 :         double myscale=1.;</span>
<span class="lineNum">      68 </span>            :         // basic sanity check
<span class="lineNum">      69 </span><span class="lineNoCov">          0 :         if(p0.size()!=p1.size() || p1.size()!=align.size()){</span>
<span class="lineNum">      70 </span><span class="lineNoCov">          0 :                         cerr&lt;&lt;&quot;Kearsley: looks like you have not properly allocated the vectors: the two frames have different size&quot;&lt;&lt;endl;</span>
<span class="lineNum">      71 </span><span class="lineNoCov">          0 :                         cerr&lt;&lt;&quot;size of p0 is :&quot;&lt;&lt;p0.size()&lt;&lt;endl;</span>
<span class="lineNum">      72 </span><span class="lineNoCov">          0 :                         cerr&lt;&lt;&quot;size of p1 is :&quot;&lt;&lt;p1.size()&lt;&lt;endl;</span>
<span class="lineNum">      73 </span><span class="lineNoCov">          0 :                         cerr&lt;&lt;&quot;size of align is :&quot;&lt;&lt;align.size()&lt;&lt;endl;</span>
<span class="lineNum">      74 </span><span class="lineNoCov">          0 :                         exit(0);</span>
<span class="lineNum">      75 </span>            :         }
<span class="lineNum">      76 </span><span class="lineNoCov">          0 :         if(p0.empty() || p1.empty()  ){</span>
<span class="lineNum">      77 </span><span class="lineNoCov">          0 :                 cerr&lt;&lt;&quot;Kearsley: looks like you have not properly allocated the vectors: they do not contain anything&quot;&lt;&lt;endl;</span>
<span class="lineNum">      78 </span><span class="lineNoCov">          0 :                 exit(0);</span>
<span class="lineNum">      79 </span>            :         }
<span class="lineNum">      80 </span><span class="lineNoCov">          0 :         Vector rr1,rr0;</span>
<span class="lineNum">      81 </span><span class="lineNoCov">          0 :         Vector4d q;</span>
<span class="lineNum">      82 </span>            :         double dddq[4][4][4],gamma[3][3][3],rrsq;
<span class="lineNum">      83 </span><span class="lineNoCov">          0 :         Matrix&lt;double&gt; m=Matrix&lt;double&gt;(4,4);</span>
<span class="lineNum">      84 </span>            : //      double dm_r1[4][4][3],dm_r0[4][4][3];
<span class="lineNum">      85 </span><span class="lineNoCov">          0 :         Vector dm_r1[4][4];</span>
<span class="lineNum">      86 </span><span class="lineNoCov">          0 :         Vector dm_r0[4][4];</span>
<span class="lineNum">      87 </span><span class="lineNoCov">          0 :         Tensor pi1,pi0;</span>
<span class="lineNum">      88 </span><span class="lineNoCov">          0 :         Tensor d;</span>
<span class="lineNum">      89 </span><span class="lineNoCov">          0 :         Tensor dinv;</span>
<span class="lineNum">      90 </span><span class="lineNoCov">          0 :         Vector xx;</span>
<span class="lineNum">      91 </span><span class="lineNoCov">          0 :         double totalign=0.,  s, tmp1, err;</span>
<span class="lineNum">      92 </span>            :         unsigned  i,j,k,l,ii,ll,jj,mm,n,nn,iii;
<span class="lineNum">      93 </span><span class="lineNoCov">          0 :         bool verbose=false;</span>
<span class="lineNum">      94 </span>            : 
<span class="lineNum">      95 </span><span class="lineNoCov">          0 :         vector&lt;int&gt; alignmap; // on the fly map done for optimization</span>
<span class="lineNum">      96 </span>            : 
<span class="lineNum">      97 </span><span class="lineNoCov">          0 :         unsigned natoms=p0.size();</span>
<span class="lineNum">      98 </span>            : 
<span class="lineNum">      99 </span>            : 
<span class="lineNum">     100 </span>            :         // calculate coms
<span class="lineNum">     101 </span>            : 
<span class="lineNum">     102 </span><span class="lineNoCov">          0 :         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     103 </span><span class="lineNoCov">          0 :                 if (align[i]&gt;0.){</span>
<span class="lineNum">     104 </span><span class="lineNoCov">          0 :                         alignmap.push_back(i);</span>
<span class="lineNum">     105 </span><span class="lineNoCov">          0 :                         totalign+=align[i];</span>
<span class="lineNum">     106 </span>            :                 }
<span class="lineNum">     107 </span><span class="lineNoCov">          0 :                 if (align[i]&lt;0.){cerr&lt;&lt;&quot;FOUND ALIGNMENT WEIGHT NEGATIVE!&quot;&lt;&lt;endl;exit(0);};</span>
<span class="lineNum">     108 </span>            : 
<span class="lineNum">     109 </span>            :         }
<span class="lineNum">     110 </span>            : 
<span class="lineNum">     111 </span>            : 
<span class="lineNum">     112 </span>            :         // later will be implemented something for optimizing this piece of crap
<span class="lineNum">     113 </span>            : 
<span class="lineNum">     114 </span><span class="lineNoCov">          0 :         com0_is_removed=false;</span>
<span class="lineNum">     115 </span><span class="lineNoCov">          0 :         com1_is_removed=false;</span>
<span class="lineNum">     116 </span>            : 
<span class="lineNum">     117 </span><span class="lineNoCov">          0 :         bool do_center=true; // keep it for legacy code compatibility</span>
<span class="lineNum">     118 </span>            : 
<span class="lineNum">     119 </span><span class="lineNoCov">          0 :         if(com0_is_removed==false){</span>
<span class="lineNum">     120 </span>            : 
<span class="lineNum">     121 </span><span class="lineNoCov">          0 :                 xx.zero();</span>
<span class="lineNum">     122 </span>            : 
<span class="lineNum">     123 </span><span class="lineNoCov">          0 :                 if(do_center) {// if you dont need to center no prob...</span>
<span class="lineNum">     124 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;alignmap.size();i++){</span>
<span class="lineNum">     125 </span><span class="lineNoCov">          0 :                                 xx+=p0[alignmap[i]]*align[alignmap[i]];</span>
<span class="lineNum">     126 </span>            :                         }
<span class="lineNum">     127 </span><span class="lineNoCov">          0 :                         xx/=(totalign);</span>
<span class="lineNum">     128 </span>            :                 }
<span class="lineNum">     129 </span>            : 
<span class="lineNum">     130 </span><span class="lineNoCov">          0 :                 com0=xx;</span>
<span class="lineNum">     131 </span>            : 
<span class="lineNum">     132 </span><span class="lineNoCov">          0 :                 if (p0reset.empty()){p0reset.resize(natoms);}</span>
<span class="lineNum">     133 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     134 </span><span class="lineNoCov">          0 :                         p0reset[i]=p0[i]-xx;</span>
<span class="lineNum">     135 </span>            :                 }
<span class="lineNum">     136 </span><span class="lineNoCov">          0 :                 com0_is_removed=true;</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span><span class="lineNoCov">          0 :                 if (verbose){</span>
<span class="lineNum">     139 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P0 RESET\n&quot;);</span>
<span class="lineNum">     140 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     141 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     1    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p0reset[i][0]/myscale,p0reset[i][1]/myscale,p0reset[i][2]/myscale);</span>
<span class="lineNum">     142 </span>            :                         }
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     144 </span>            :                 }
<span class="lineNum">     145 </span>            : 
<span class="lineNum">     146 </span>            :         }
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span><span class="lineNoCov">          0 :         if(com1_is_removed==false){</span>
<span class="lineNum">     149 </span>            : 
<span class="lineNum">     150 </span><span class="lineNoCov">          0 :                 xx.zero();</span>
<span class="lineNum">     151 </span>            : 
<span class="lineNum">     152 </span><span class="lineNoCov">          0 :                 if(do_center) {// if you dont need to center no prob...</span>
<span class="lineNum">     153 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;alignmap.size();i++){</span>
<span class="lineNum">     154 </span><span class="lineNoCov">          0 :                                 xx+=p1[alignmap[i]]*align[alignmap[i]];</span>
<span class="lineNum">     155 </span>            :                         }
<span class="lineNum">     156 </span><span class="lineNoCov">          0 :                         xx/=(totalign);</span>
<span class="lineNum">     157 </span>            :                 }
<span class="lineNum">     158 </span>            : 
<span class="lineNum">     159 </span><span class="lineNoCov">          0 :                 com1=xx;</span>
<span class="lineNum">     160 </span>            : 
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :                 if (p1reset.empty()){p1reset.resize(natoms);}</span>
<span class="lineNum">     162 </span>            : 
<span class="lineNum">     163 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     164 </span><span class="lineNoCov">          0 :                                 p1reset[i]=p1[i]-xx;</span>
<span class="lineNum">     165 </span>            :                 }
<span class="lineNum">     166 </span><span class="lineNoCov">          0 :                 com1_is_removed=true;</span>
<span class="lineNum">     167 </span>            : 
<span class="lineNum">     168 </span><span class="lineNoCov">          0 :                 if(verbose){</span>
<span class="lineNum">     169 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P1 RESET\n&quot;);</span>
<span class="lineNum">     170 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     1    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p1reset[i][0]/myscale,p1reset[i][1]/myscale,p1reset[i][2]/myscale);</span>
<span class="lineNum">     172 </span>            :                         }
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     174 </span>            :                 }
<span class="lineNum">     175 </span>            : 
<span class="lineNum">     176 </span>            :         }
<span class="lineNum">     177 </span>            : 
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :         bool fake=false;</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :         if(fake){</span>
<span class="lineNum">     180 </span>            :         // case of trivial alignment
<span class="lineNum">     181 </span>            :          // set rotmat
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :                 rotmat0on1=Tensor::identity();</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :                 if (p0reset.size()==0){p0reset.resize(natoms);}</span>
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :                 if (p1reset.size()==0){p1reset.resize(natoms);}</span>
<span class="lineNum">     185 </span>            : 
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :                 derrdp0.resize(natoms);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :                 derrdp1.resize(natoms);</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :                 dmatdp0.resize(3*3*3*natoms);for(i=0;i&lt;dmatdp0.size();i++)dmatdp0[i]=0.;</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :                 dmatdp1.resize(3*3*3*natoms);for(i=0;i&lt;dmatdp1.size();i++)dmatdp1[i]=0.;</span>
<span class="lineNum">     190 </span>            : 
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :                 err=0.;</span>
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     193 </span><span class="lineNoCov">          0 :                         if(align[i]&gt;0.)err+=align[i]*modulo2(p0reset[i]-p1reset[i]);</span>
<span class="lineNum">     194 </span>            :                 }
<span class="lineNum">     195 </span>            : 
<span class="lineNum">     196 </span><span class="lineNoCov">          0 :                 return 0.;</span>
<span class="lineNum">     197 </span>            :         }
<span class="lineNum">     198 </span>            :         //
<span class="lineNum">     199 </span>            :         // CLEAN M MATRIX
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span><span class="lineNoCov">          0 :         m=0.;</span>
<span class="lineNum">     202 </span>            : 
<span class="lineNum">     203 </span>            :         // ASSIGN MATRIX ELEMENTS USING ONLY THE ATOMS INVOLVED IN ALIGNMENT
<span class="lineNum">     204 </span>            : 
<span class="lineNum">     205 </span><span class="lineNoCov">          0 :         for(i=0;i&lt;alignmap.size();i++){</span>
<span class="lineNum">     206 </span>            : 
<span class="lineNum">     207 </span><span class="lineNoCov">          0 :                 k=alignmap[i];</span>
<span class="lineNum">     208 </span><span class="lineNoCov">          0 :                 tmp1=sqrt(align[k]/totalign);</span>
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span>            :                 // adopt scaled coordinates
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span><span class="lineNoCov">          0 :                 rr1=p1reset[k]*tmp1;</span>
<span class="lineNum">     213 </span><span class="lineNoCov">          0 :                 rr0=p0reset[k]*tmp1;</span>
<span class="lineNum">     214 </span>            : 
<span class="lineNum">     215 </span><span class="lineNoCov">          0 :                 rrsq=modulo2(rr0)+modulo2(rr1);</span>
<span class="lineNum">     216 </span>            : 
<span class="lineNum">     217 </span><span class="lineNoCov">          0 :                 m[0][0] +=  rrsq+2.*(-rr0[0]*rr1[0]-rr0[1]*rr1[1]-rr0[2]*rr1[2]);</span>
<span class="lineNum">     218 </span><span class="lineNoCov">          0 :                 m[1][1] +=  rrsq+2.*(-rr0[0]*rr1[0]+rr0[1]*rr1[1]+rr0[2]*rr1[2]);</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :                 m[2][2] +=  rrsq+2.*(+rr0[0]*rr1[0]-rr0[1]*rr1[1]+rr0[2]*rr1[2]);</span>
<span class="lineNum">     220 </span><span class="lineNoCov">          0 :                 m[3][3] +=  rrsq+2.*(+rr0[0]*rr1[0]+rr0[1]*rr1[1]-rr0[2]*rr1[2]);</span>
<span class="lineNum">     221 </span><span class="lineNoCov">          0 :                 m[0][1] += 2.*(-rr0[1]*rr1[2]+rr0[2]*rr1[1]);</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :                 m[0][2] += 2.*( rr0[0]*rr1[2]-rr0[2]*rr1[0]);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :                 m[0][3] += 2.*(-rr0[0]*rr1[1]+rr0[1]*rr1[0]);</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :                 m[1][2] -= 2.*( rr0[0]*rr1[1]+rr0[1]*rr1[0]);</span>
<span class="lineNum">     225 </span><span class="lineNoCov">          0 :                 m[1][3] -= 2.*( rr0[0]*rr1[2]+rr0[2]*rr1[0]);</span>
<span class="lineNum">     226 </span><span class="lineNoCov">          0 :                 m[2][3] -= 2.*( rr0[1]*rr1[2]+rr0[2]*rr1[1]);</span>
<span class="lineNum">     227 </span>            : 
<span class="lineNum">     228 </span>            :         };
<span class="lineNum">     229 </span><span class="lineNoCov">          0 :         m[1][0] = m[0][1];</span>
<span class="lineNum">     230 </span><span class="lineNoCov">          0 :         m[2][0] = m[0][2];</span>
<span class="lineNum">     231 </span><span class="lineNoCov">          0 :         m[2][1] = m[1][2];</span>
<span class="lineNum">     232 </span><span class="lineNoCov">          0 :         m[3][0] = m[0][3];</span>
<span class="lineNum">     233 </span><span class="lineNoCov">          0 :         m[3][1] = m[1][3];</span>
<span class="lineNum">     234 </span><span class="lineNoCov">          0 :         m[3][2] = m[2][3];</span>
<span class="lineNum">     235 </span>            : 
<span class="lineNum">     236 </span>            :         // diagonalize the 4x4 matrix
<span class="lineNum">     237 </span>            : 
<span class="lineNum">     238 </span><span class="lineNoCov">          0 :         vector&lt;double&gt; eigenvals;</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :         Matrix&lt;double&gt; eigenvecs;</span>
<span class="lineNum">     240 </span>            : 
<span class="lineNum">     241 </span><span class="lineNoCov">          0 :         int diagerror=diagMat(m, eigenvals, eigenvecs );</span>
<span class="lineNum">     242 </span>            : 
<span class="lineNum">     243 </span><span class="lineNoCov">          0 :         if (diagerror!=0){cerr&lt;&lt;&quot;DIAGONALIZATION FAILED WITH ERROR CODE &quot;&lt;&lt;diagerror&lt;&lt;endl;exit(0);}</span>
<span class="lineNum">     244 </span>            : 
<span class="lineNum">     245 </span><span class="lineNoCov">          0 :         s=1.0;</span>
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         if(eigenvecs(0,0)&lt;0.)s=-1.;//correct for negative values (?)</span>
<span class="lineNum">     247 </span>            :         // eigenvecs are in rows!!
<span class="lineNum">     248 </span>            : 
<span class="lineNum">     249 </span><span class="lineNoCov">          0 :         q[0]=s*eigenvecs(0,0);</span>
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         q[1]=s*eigenvecs(0,1);</span>
<span class="lineNum">     251 </span><span class="lineNoCov">          0 :         q[2]=s*eigenvecs(0,2);</span>
<span class="lineNum">     252 </span><span class="lineNoCov">          0 :         q[3]=s*eigenvecs(0,3);</span>
<span class="lineNum">     253 </span><span class="lineNoCov">          0 :         err=eigenvals[0];</span>
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span>            :         //log-&gt;printf(&quot; ERR: %20.10f \n&quot;,err);
<span class="lineNum">     256 </span>            : 
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :         if(verbose){</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot; ERR: %f \n&quot;,err);</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :                 for (i=0;i&lt;4;i++){</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot; EIGENVALS: %f \n&quot;,eigenvals[i]);</span>
<span class="lineNum">     261 </span>            :                 }
<span class="lineNum">     262 </span>            :         }
<span class="lineNum">     263 </span>            : 
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         if(abs(eigenvals[0]-eigenvals[1])&lt;1.e-8){</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :                 cerr&lt;&lt;&quot;DIAGONALIZATION: NON UNIQUE SOLUTION&quot;&lt;&lt;endl;exit(0);</span>
<span class="lineNum">     266 </span>            :         }
<span class="lineNum">     267 </span>            : 
<span class="lineNum">     268 </span>            :         /*
<span class="lineNum">     269 </span>            :          * the ROTATION matrix
<span class="lineNum">     270 </span>            :          */
<span class="lineNum">     271 </span>            : 
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         d[0][0]=q[0]*q[0]+q[1]*q[1]-q[2]*q[2]-q[3]*q[3]       ;</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         d[1][0]=2.0*(q[1]*q[2]-q[0]*q[3]);</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :         d[2][0]=2.0*(q[1]*q[3]+q[0]*q[2]);</span>
<span class="lineNum">     275 </span><span class="lineNoCov">          0 :         d[0][1]=2.0*(q[1]*q[2]+q[0]*q[3]);</span>
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         d[1][1]=q[0]*q[0]+q[2]*q[2]-q[1]*q[1]-q[3]*q[3];</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :         d[2][1]=2.0*(q[2]*q[3]-q[0]*q[1]);</span>
<span class="lineNum">     278 </span><span class="lineNoCov">          0 :         d[0][2]=2.0*(q[1]*q[3]-q[0]*q[2]);</span>
<span class="lineNum">     279 </span><span class="lineNoCov">          0 :         d[1][2]=2.0*(q[2]*q[3]+q[0]*q[1]);</span>
<span class="lineNum">     280 </span><span class="lineNoCov">          0 :         d[2][2]=q[0]*q[0]+q[3]*q[3]-q[1]*q[1]-q[2]*q[2];</span>
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span>            :         /*
<span class="lineNum">     283 </span>            :          * first derivative in perturbation theory : derivative of the rotation matrix respect to the
<span class="lineNum">     284 </span>            :          * quternion vectors
<span class="lineNum">     285 </span>            :          */
<span class="lineNum">     286 </span>            : 
<span class="lineNum">     287 </span><span class="lineNoCov">          0 :         dddq[0][0][0]= 2.0*q[0];</span>
<span class="lineNum">     288 </span><span class="lineNoCov">          0 :         dddq[1][0][0]=-2.0*q[3];</span>
<span class="lineNum">     289 </span><span class="lineNoCov">          0 :         dddq[2][0][0]= 2.0*q[2];</span>
<span class="lineNum">     290 </span><span class="lineNoCov">          0 :         dddq[0][1][0]= 2.0*q[3];</span>
<span class="lineNum">     291 </span><span class="lineNoCov">          0 :         dddq[1][1][0]= 2.0*q[0];</span>
<span class="lineNum">     292 </span><span class="lineNoCov">          0 :         dddq[2][1][0]=-2.0*q[1];</span>
<span class="lineNum">     293 </span><span class="lineNoCov">          0 :         dddq[0][2][0]=-2.0*q[2];</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :         dddq[1][2][0]= 2.0*q[1];</span>
<span class="lineNum">     295 </span><span class="lineNoCov">          0 :         dddq[2][2][0]= 2.0*q[0];</span>
<span class="lineNum">     296 </span>            : 
<span class="lineNum">     297 </span><span class="lineNoCov">          0 :         dddq[0][0][1]= 2.0*q[1];</span>
<span class="lineNum">     298 </span><span class="lineNoCov">          0 :         dddq[1][0][1]= 2.0*q[2];</span>
<span class="lineNum">     299 </span><span class="lineNoCov">          0 :         dddq[2][0][1]= 2.0*q[3];</span>
<span class="lineNum">     300 </span><span class="lineNoCov">          0 :         dddq[0][1][1]= 2.0*q[2];</span>
<span class="lineNum">     301 </span><span class="lineNoCov">          0 :         dddq[1][1][1]=-2.0*q[1];</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :         dddq[2][1][1]=-2.0*q[0];</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :         dddq[0][2][1]= 2.0*q[3];</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :         dddq[1][2][1]= 2.0*q[0];</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         dddq[2][2][1]=-2.0*q[1];</span>
<span class="lineNum">     306 </span>            : 
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :         dddq[0][0][2]=-2.0*q[2];</span>
<span class="lineNum">     308 </span><span class="lineNoCov">          0 :         dddq[1][0][2]= 2.0*q[1];</span>
<span class="lineNum">     309 </span><span class="lineNoCov">          0 :         dddq[2][0][2]= 2.0*q[0];</span>
<span class="lineNum">     310 </span><span class="lineNoCov">          0 :         dddq[0][1][2]= 2.0*q[1];</span>
<span class="lineNum">     311 </span><span class="lineNoCov">          0 :         dddq[1][1][2]= 2.0*q[2];</span>
<span class="lineNum">     312 </span><span class="lineNoCov">          0 :         dddq[2][1][2]= 2.0*q[3];</span>
<span class="lineNum">     313 </span><span class="lineNoCov">          0 :         dddq[0][2][2]=-2.0*q[0];</span>
<span class="lineNum">     314 </span><span class="lineNoCov">          0 :         dddq[1][2][2]= 2.0*q[3];</span>
<span class="lineNum">     315 </span><span class="lineNoCov">          0 :         dddq[2][2][2]=-2.0*q[2];</span>
<span class="lineNum">     316 </span>            : 
<span class="lineNum">     317 </span><span class="lineNoCov">          0 :         dddq[0][0][3]=-2.0*q[3];</span>
<span class="lineNum">     318 </span><span class="lineNoCov">          0 :         dddq[1][0][3]=-2.0*q[0];</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         dddq[2][0][3]= 2.0*q[1];</span>
<span class="lineNum">     320 </span><span class="lineNoCov">          0 :         dddq[0][1][3]= 2.0*q[0];</span>
<span class="lineNum">     321 </span><span class="lineNoCov">          0 :         dddq[1][1][3]=-2.0*q[3];</span>
<span class="lineNum">     322 </span><span class="lineNoCov">          0 :         dddq[2][1][3]= 2.0*q[2];</span>
<span class="lineNum">     323 </span><span class="lineNoCov">          0 :         dddq[0][2][3]= 2.0*q[1];</span>
<span class="lineNum">     324 </span><span class="lineNoCov">          0 :         dddq[1][2][3]= 2.0*q[2];</span>
<span class="lineNum">     325 </span><span class="lineNoCov">          0 :         dddq[2][2][3]= 2.0*q[3];</span>
<span class="lineNum">     326 </span>            : 
<span class="lineNum">     327 </span>            :         /*
<span class="lineNum">     328 </span>            :          * Build gamma 3x3x3 matrix
<span class="lineNum">     329 </span>            :          */
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :         for(i=0;i&lt;3;i++){     //direction</span>
<span class="lineNum">     331 </span><span class="lineNoCov">          0 :                 for(j=0;j&lt;3;j++){     //direction</span>
<span class="lineNum">     332 </span><span class="lineNoCov">          0 :                         for(k=0;k&lt;3;k++){     //eigenvector number</span>
<span class="lineNum">     333 </span><span class="lineNoCov">          0 :                                 gamma[i][j][k]=0.0;</span>
<span class="lineNum">     334 </span><span class="lineNoCov">          0 :                                 for(l=0;l&lt;4;l++){   //components of each eigenvector in pert. series</span>
<span class="lineNum">     335 </span><span class="lineNoCov">          0 :                                         if(abs(eigenvals[0]-eigenvals[k+1])&lt;1.e-8){</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :                                                 log-&gt;printf(&quot; FOUND DEGENERACY IN RMSD_ESS ROUTINE \n&quot;);</span>
<span class="lineNum">     337 </span><span class="lineNoCov">          0 :                                                 log-&gt;printf(&quot; I'm DYING....\n&quot;);</span>
<span class="lineNum">     338 </span><span class="lineNoCov">          0 :                                                 log-&gt;printf(&quot; COPYING STACK HERE \n&quot;);</span>
<span class="lineNum">     339 </span><span class="lineNoCov">          0 :                                                 log-&gt;printf(&quot; P0\n&quot;);</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :                                                 for(ll=0;ll&lt;natoms;ll++)log-&gt;printf(&quot; %f %f %f \n&quot;,p0reset[ll][0],p0reset[ll][1],p0reset[ll][2]);</span>
<span class="lineNum">     341 </span><span class="lineNoCov">          0 :                                                 log-&gt;printf(&quot; P1\n&quot;);</span>
<span class="lineNum">     342 </span><span class="lineNoCov">          0 :                                                 for(ll=0;ll&lt;natoms;ll++)log-&gt;printf(&quot; %f %f %f \n&quot;,p1reset[ll][0],p1reset[ll][1],p1reset[ll][2]);</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :                                                 exit(0);</span>
<span class="lineNum">     344 </span>            :                                         }
<span class="lineNum">     345 </span>            :                                         else{
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :                                                 gamma[i][j][k]  +=  dddq[i][j][l]*eigenvecs(k+1,l)/(eigenvals[0]-eigenvals[k+1]);</span>
<span class="lineNum">     347 </span>            :                                         }
<span class="lineNum">     348 </span>            :                                 }
<span class="lineNum">     349 </span>            :                 //log-&gt;printf(&quot;GAMMA %2d %2d %2d V %12.6f\n&quot;,i,j,k,gamma[i][j][k]);
<span class="lineNum">     350 </span>            :                         }
<span class="lineNum">     351 </span>            :                 }
<span class="lineNum">     352 </span>            :         }
<span class="lineNum">     353 </span>            : 
<span class="lineNum">     354 </span>            :         // allocate various arrays
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineNoCov">          0 :         dmatdp1.resize(3*3*3*natoms);</span>
<span class="lineNum">     357 </span><span class="lineNoCov">          0 :         for(i=0;i&lt;dmatdp1.size();i++)dmatdp1[i]=0.;</span>
<span class="lineNum">     358 </span><span class="lineNoCov">          0 :         dmatdp0.resize(3*3*3*natoms);</span>
<span class="lineNum">     359 </span><span class="lineNoCov">          0 :         for(i=0;i&lt;dmatdp0.size();i++)dmatdp0[i]=0.;</span>
<span class="lineNum">     360 </span>            : 
<span class="lineNum">     361 </span><span class="lineNoCov">          0 :         vector&lt;double&gt; dd_dr_temp;dd_dr_temp.resize(natoms);</span>
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineNoCov">          0 :         vector&lt;Vector&gt; derr_dr1;</span>
<span class="lineNum">     364 </span><span class="lineNoCov">          0 :         derr_dr1.resize(natoms);</span>
<span class="lineNum">     365 </span><span class="lineNoCov">          0 :         vector&lt;Vector&gt; derr_dr0;</span>
<span class="lineNum">     366 </span><span class="lineNoCov">          0 :         derr_dr0.resize(natoms);</span>
<span class="lineNum">     367 </span><span class="lineNoCov">          0 :         vector&lt;Vector&gt; array_3_n;</span>
<span class="lineNum">     368 </span><span class="lineNoCov">          0 :         array_3_n.resize(natoms);</span>
<span class="lineNum">     369 </span>            : 
<span class="lineNum">     370 </span>            : 
<span class="lineNum">     371 </span>            :         /*
<span class="lineNum">     372 </span>            :          * Table of Derivative of the quaternion matrix respect to atom position: needed only if simple
<span class="lineNum">     373 </span>            :          * alignment is required and no correction respect to the rotation matrix is wanted
<span class="lineNum">     374 </span>            :          */
<span class="lineNum">     375 </span>            : 
<span class="lineNum">     376 </span><span class="lineNoCov">          0 :         for(iii=0;iii&lt;alignmap.size();iii++){</span>
<span class="lineNum">     377 </span>            : 
<span class="lineNum">     378 </span><span class="lineNoCov">          0 :                 i=alignmap[iii];</span>
<span class="lineNum">     379 </span><span class="lineNoCov">          0 :                 tmp1=sqrt(align[i]/totalign);</span>
<span class="lineNum">     380 </span>            : 
<span class="lineNum">     381 </span>            :                 // once again: derivative respect to scaled distance
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :                 rr1=2.*p1reset[i]*tmp1;</span>
<span class="lineNum">     384 </span><span class="lineNoCov">          0 :                 rr0=2.*p0reset[i]*tmp1;</span>
<span class="lineNum">     385 </span>            : 
<span class="lineNum">     386 </span>            : 
<span class="lineNum">     387 </span><span class="lineNoCov">          0 :                 dm_r1 [0][0][0]=(rr1[0]-rr0[0]);</span>
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :                 dm_r1 [0][0][1]=(rr1[1]-rr0[1]);</span>
<span class="lineNum">     389 </span><span class="lineNoCov">          0 :                 dm_r1 [0][0][2]=(rr1[2]-rr0[2]);</span>
<span class="lineNum">     390 </span>            : 
<span class="lineNum">     391 </span><span class="lineNoCov">          0 :                 dm_r1 [0][1][0]=0.;</span>
<span class="lineNum">     392 </span><span class="lineNoCov">          0 :                 dm_r1 [0][1][1]= rr0[2];</span>
<span class="lineNum">     393 </span><span class="lineNoCov">          0 :                 dm_r1 [0][1][2]=-rr0[1];</span>
<span class="lineNum">     394 </span>            : 
<span class="lineNum">     395 </span><span class="lineNoCov">          0 :                 dm_r1 [0][2][0]=-rr0[2];</span>
<span class="lineNum">     396 </span><span class="lineNoCov">          0 :                 dm_r1 [0][2][1]= 0.;</span>
<span class="lineNum">     397 </span><span class="lineNoCov">          0 :                 dm_r1 [0][2][2]= rr0[0];</span>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineNoCov">          0 :                 dm_r1 [0][3][0]= rr0[1];</span>
<span class="lineNum">     400 </span><span class="lineNoCov">          0 :                 dm_r1 [0][3][1]=-rr0[0];</span>
<span class="lineNum">     401 </span><span class="lineNoCov">          0 :                 dm_r1 [0][3][2]= 0.;</span>
<span class="lineNum">     402 </span>            : 
<span class="lineNum">     403 </span><span class="lineNoCov">          0 :                 dm_r1 [1][1][0]=(rr1[0]-rr0[0]);</span>
<span class="lineNum">     404 </span><span class="lineNoCov">          0 :                 dm_r1 [1][1][1]=(rr1[1]+rr0[1]);</span>
<span class="lineNum">     405 </span><span class="lineNoCov">          0 :                 dm_r1 [1][1][2]=(rr1[2]+rr0[2]);</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineNoCov">          0 :                 dm_r1 [1][2][0]=-rr0[1];</span>
<span class="lineNum">     408 </span><span class="lineNoCov">          0 :                 dm_r1 [1][2][1]=-rr0[0];</span>
<span class="lineNum">     409 </span><span class="lineNoCov">          0 :                 dm_r1 [1][2][2]= 0.;</span>
<span class="lineNum">     410 </span>            : 
<span class="lineNum">     411 </span><span class="lineNoCov">          0 :                 dm_r1 [1][3][0]=-rr0[2];</span>
<span class="lineNum">     412 </span><span class="lineNoCov">          0 :                 dm_r1 [1][3][1]= 0.;</span>
<span class="lineNum">     413 </span><span class="lineNoCov">          0 :                 dm_r1 [1][3][2]=-rr0[0];</span>
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :                 dm_r1 [2][2][0]=(rr1[0]+rr0[0]);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :                 dm_r1 [2][2][1]=(rr1[1]-rr0[1]);</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :                 dm_r1 [2][2][2]=(rr1[2]+rr0[2]);</span>
<span class="lineNum">     418 </span>            : 
<span class="lineNum">     419 </span><span class="lineNoCov">          0 :                 dm_r1 [2][3][0]=0.;</span>
<span class="lineNum">     420 </span><span class="lineNoCov">          0 :                 dm_r1 [2][3][1]=-rr0[2];</span>
<span class="lineNum">     421 </span><span class="lineNoCov">          0 :                 dm_r1 [2][3][2]=-rr0[1];</span>
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineNoCov">          0 :                 dm_r1 [3][3][0]=(rr1[0]+rr0[0]);</span>
<span class="lineNum">     424 </span><span class="lineNoCov">          0 :                 dm_r1 [3][3][1]=(rr1[1]+rr0[1]);</span>
<span class="lineNum">     425 </span><span class="lineNoCov">          0 :                 dm_r1 [3][3][2]=(rr1[2]-rr0[2]);</span>
<span class="lineNum">     426 </span>            :                 /*
<span class="lineNum">     427 </span>            :    derivative respec to to the other vector
<span class="lineNum">     428 </span>            :                  */
<span class="lineNum">     429 </span><span class="lineNoCov">          0 :                 dm_r0 [0][0][0]=-(rr1[0]-rr0[0]);</span>
<span class="lineNum">     430 </span><span class="lineNoCov">          0 :                 dm_r0 [0][0][1]=-(rr1[1]-rr0[1]);</span>
<span class="lineNum">     431 </span><span class="lineNoCov">          0 :                 dm_r0 [0][0][2]=-(rr1[2]-rr0[2]);</span>
<span class="lineNum">     432 </span>            : 
<span class="lineNum">     433 </span><span class="lineNoCov">          0 :                 dm_r0 [0][1][0]=0.       ;</span>
<span class="lineNum">     434 </span><span class="lineNoCov">          0 :                 dm_r0 [0][1][1]=-rr1[2];</span>
<span class="lineNum">     435 </span><span class="lineNoCov">          0 :                 dm_r0 [0][1][2]=rr1[1];</span>
<span class="lineNum">     436 </span>            : 
<span class="lineNum">     437 </span><span class="lineNoCov">          0 :                 dm_r0 [0][2][0]= rr1[2];</span>
<span class="lineNum">     438 </span><span class="lineNoCov">          0 :                 dm_r0 [0][2][1]= 0.;</span>
<span class="lineNum">     439 </span><span class="lineNoCov">          0 :                 dm_r0 [0][2][2]=-rr1[0];</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineNoCov">          0 :                 dm_r0 [0][3][0]=-rr1[1] ;</span>
<span class="lineNum">     442 </span><span class="lineNoCov">          0 :                 dm_r0 [0][3][1]= rr1[0];</span>
<span class="lineNum">     443 </span><span class="lineNoCov">          0 :                 dm_r0 [0][3][2]= 0.;</span>
<span class="lineNum">     444 </span>            : 
<span class="lineNum">     445 </span><span class="lineNoCov">          0 :                 dm_r0 [1][1][0]=-(rr1[0]-rr0[0]);</span>
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :                 dm_r0 [1][1][1]=(rr1[1]+rr0[1]);</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :                 dm_r0 [1][1][2]=(rr1[2]+rr0[2]);</span>
<span class="lineNum">     448 </span>            : 
<span class="lineNum">     449 </span><span class="lineNoCov">          0 :                 dm_r0 [1][2][0]=-rr1[1];</span>
<span class="lineNum">     450 </span><span class="lineNoCov">          0 :                 dm_r0 [1][2][1]=-rr1[0];</span>
<span class="lineNum">     451 </span><span class="lineNoCov">          0 :                 dm_r0 [1][2][2]= 0.;</span>
<span class="lineNum">     452 </span>            : 
<span class="lineNum">     453 </span><span class="lineNoCov">          0 :                 dm_r0 [1][3][0]=-rr1[2];</span>
<span class="lineNum">     454 </span><span class="lineNoCov">          0 :                 dm_r0 [1][3][1]= 0.;</span>
<span class="lineNum">     455 </span><span class="lineNoCov">          0 :                 dm_r0 [1][3][2]=-rr1[0];</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineNoCov">          0 :                 dm_r0 [2][2][0]=(rr1[0]+rr0[0]);</span>
<span class="lineNum">     458 </span><span class="lineNoCov">          0 :                 dm_r0 [2][2][1]=-(rr1[1]-rr0[1]);</span>
<span class="lineNum">     459 </span><span class="lineNoCov">          0 :                 dm_r0 [2][2][2]=(rr1[2]+rr0[2]);</span>
<span class="lineNum">     460 </span>            : 
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :                 dm_r0 [2][3][0]=0.;</span>
<span class="lineNum">     462 </span><span class="lineNoCov">          0 :                 dm_r0 [2][3][1]=-rr1[2];</span>
<span class="lineNum">     463 </span><span class="lineNoCov">          0 :                 dm_r0 [2][3][2]=-rr1[1];</span>
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineNoCov">          0 :                 dm_r0 [3][3][0]=(rr1[0]+rr0[0]);</span>
<span class="lineNum">     466 </span><span class="lineNoCov">          0 :                 dm_r0 [3][3][1]=(rr1[1]+rr0[1]);</span>
<span class="lineNum">     467 </span><span class="lineNoCov">          0 :                 dm_r0 [3][3][2]=-(rr1[2]-rr0[2]);</span>
<span class="lineNum">     468 </span>            :                 /*
<span class="lineNum">     469 </span>            :                  * write the diagonal
<span class="lineNum">     470 </span>            :                  */
<span class="lineNum">     471 </span>            : 
<span class="lineNum">     472 </span><span class="lineNoCov">          0 :                 dm_r1[1][0]=dm_r1[0][1];</span>
<span class="lineNum">     473 </span><span class="lineNoCov">          0 :                 dm_r1[2][0]=dm_r1[0][2];</span>
<span class="lineNum">     474 </span><span class="lineNoCov">          0 :                 dm_r1[3][0]=dm_r1[0][3];</span>
<span class="lineNum">     475 </span><span class="lineNoCov">          0 :                 dm_r1[2][1]=dm_r1[1][2];</span>
<span class="lineNum">     476 </span><span class="lineNoCov">          0 :                 dm_r1[3][1]=dm_r1[1][3];</span>
<span class="lineNum">     477 </span><span class="lineNoCov">          0 :                 dm_r1[3][2]=dm_r1[2][3];</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineNoCov">          0 :                 dm_r0[1][0]=dm_r0[0][1];</span>
<span class="lineNum">     480 </span><span class="lineNoCov">          0 :                 dm_r0[2][0]=dm_r0[0][2];</span>
<span class="lineNum">     481 </span><span class="lineNoCov">          0 :                 dm_r0[3][0]=dm_r0[0][3];</span>
<span class="lineNum">     482 </span><span class="lineNoCov">          0 :                 dm_r0[2][1]=dm_r0[1][2];</span>
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :                 dm_r0[3][1]=dm_r0[1][3];</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :                 dm_r0[3][2]=dm_r0[2][3];</span>
<span class="lineNum">     485 </span>            : 
<span class="lineNum">     486 </span>            : 
<span class="lineNum">     487 </span>            :                 //log-&gt;printf(&quot;DMDR0 ALIGN %f AT %d VAL %f\n&quot;,align[i],i,dm_r0[0][0][j]);
<span class="lineNum">     488 </span>            : 
<span class="lineNum">     489 </span>            : 
<span class="lineNum">     490 </span>            :                 /*
<span class="lineNum">     491 </span>            :                  * pi matrix : coefficents in per theory
<span class="lineNum">     492 </span>            :                  */
<span class="lineNum">     493 </span>            : 
<span class="lineNum">     494 </span><span class="lineNoCov">          0 :         pi0.zero();</span>
<span class="lineNum">     495 </span><span class="lineNoCov">          0 :                 pi1.zero();</span>
<span class="lineNum">     496 </span><span class="lineNoCov">          0 :                 derr_dr1[i].zero();</span>
<span class="lineNum">     497 </span><span class="lineNoCov">          0 :                 derr_dr0[i].zero();</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span><span class="lineNoCov">          0 :                 for(k=0;k&lt;4;k++){</span>
<span class="lineNum">     500 </span><span class="lineNoCov">          0 :                         for(l=0;l&lt;4;l++){</span>
<span class="lineNum">     501 </span><span class="lineNoCov">          0 :                                 derr_dr1[i]+=(q[k]*q[l])*dm_r1[l][k];</span>
<span class="lineNum">     502 </span><span class="lineNoCov">          0 :                                 derr_dr0[i]+=(q[k]*q[l])*dm_r0[l][k];</span>
<span class="lineNum">     503 </span><span class="lineNoCov">          0 :                                 for(mm=0;mm&lt;3;mm++)for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :                                         pi0[mm][j]+=eigenvecs(mm+1,k)*dm_r0[l][k][j]*q[l];</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :                                         pi1[mm][j]+=eigenvecs(mm+1,k)*dm_r1[l][k][j]*q[l];</span>
<span class="lineNum">     506 </span>            :                                 };
<span class="lineNum">     507 </span>            :                         };
<span class="lineNum">     508 </span>            :                 };
<span class="lineNum">     509 </span>            : /*
<span class="lineNum">     510 </span>            :                 derr_dr1[i]/=totalign;
<span class="lineNum">     511 </span>            :                 derr_dr0[i]/=totalign;
<span class="lineNum">     512 </span>            : 
<span class="lineNum">     513 </span>            : 
<span class="lineNum">     514 </span>            : */
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineNoCov">          0 :                 for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     517 </span><span class="lineNoCov">          0 :                         for (k=0;k&lt;3;k++){</span>
<span class="lineNum">     518 </span><span class="lineNoCov">          0 :                                 for(l=0;l&lt;3;l++){</span>
<span class="lineNum">     519 </span><span class="lineNoCov">          0 :                                         int ind=j*3*3*natoms+k*3*natoms+l*natoms+i;</span>
<span class="lineNum">     520 </span><span class="lineNoCov">          0 :                                         dmatdp0[ind]=0.;</span>
<span class="lineNum">     521 </span><span class="lineNoCov">          0 :                                         dmatdp1[ind]=0.;</span>
<span class="lineNum">     522 </span><span class="lineNoCov">          0 :                                         for(ii=0;ii&lt;3;ii++){</span>
<span class="lineNum">     523 </span><span class="lineNoCov">          0 :                                                 dmatdp1[ind]+=gamma[j][k][ii]*pi1[ii][l];</span>
<span class="lineNum">     524 </span><span class="lineNoCov">          0 :                                                 dmatdp0[ind]+=gamma[j][k][ii]*pi0[ii][l];</span>
<span class="lineNum">     525 </span>            :                                         }
<span class="lineNum">     526 </span>            : 
<span class="lineNum">     527 </span>            :                                 }
<span class="lineNum">     528 </span>            : 
<span class="lineNum">     529 </span>            :                         }
<span class="lineNum">     530 </span>            : 
<span class="lineNum">     531 </span>            :                 }
<span class="lineNum">     532 </span>            :         }
<span class="lineNum">     533 </span>            : 
<span class="lineNum">     534 </span>            : 
<span class="lineNum">     535 </span>            : 
<span class="lineNum">     536 </span>            : 
<span class="lineNum">     537 </span>            :         // end of the calculation of the derivative of the rotation matrix
<span class="lineNum">     538 </span>            : 
<span class="lineNum">     539 </span>            :         /*
<span class="lineNum">     540 </span>            :          * Now correct for center of mass: only if needed
<span class="lineNum">     541 </span>            :          *
<span class="lineNum">     542 </span>            :          */
<span class="lineNum">     543 </span>            : 
<span class="lineNum">     544 </span><span class="lineNoCov">          0 :         bool comcorr_r1=true;</span>
<span class="lineNum">     545 </span>            : 
<span class="lineNum">     546 </span><span class="lineNoCov">          0 :         if(comcorr_r1){</span>
<span class="lineNum">     547 </span><span class="lineNoCov">          0 :                 for(k=0;k&lt;alignmap.size();k++){</span>
<span class="lineNum">     548 </span><span class="lineNoCov">          0 :                         i=alignmap[k];</span>
<span class="lineNum">     549 </span><span class="lineNoCov">          0 :                         tmp1=sqrt(align[i]/totalign);</span>
<span class="lineNum">     550 </span><span class="lineNoCov">          0 :                         array_3_n[i]=tmp1*derr_dr1[i];</span>
<span class="lineNum">     551 </span><span class="lineNoCov">          0 :                         if(do_center){</span>
<span class="lineNum">     552 </span><span class="lineNoCov">          0 :                                 for(jj=0;jj&lt;alignmap.size();jj++){</span>
<span class="lineNum">     553 </span><span class="lineNoCov">          0 :                                         j=alignmap[jj];</span>
<span class="lineNum">     554 </span><span class="lineNoCov">          0 :                                         array_3_n[i]-=tmp1*(align[j]/totalign)*derr_dr1[j];</span>
<span class="lineNum">     555 </span>            :                                 }
<span class="lineNum">     556 </span>            :                         }
<span class="lineNum">     557 </span>            :                 }
<span class="lineNum">     558 </span><span class="lineNoCov">          0 :                 for(k=0;k&lt;alignmap.size();k++){</span>
<span class="lineNum">     559 </span><span class="lineNoCov">          0 :                         i=alignmap[k];</span>
<span class="lineNum">     560 </span><span class="lineNoCov">          0 :                         derr_dr1[i]=array_3_n[i];</span>
<span class="lineNum">     561 </span>            :                 }
<span class="lineNum">     562 </span>            :         }
<span class="lineNum">     563 </span>            : 
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineNoCov">          0 :         bool do_comcorr_r0=true;</span>
<span class="lineNum">     566 </span>            :         //
<span class="lineNum">     567 </span>            :         // correction for r0 frame
<span class="lineNum">     568 </span>            :         //
<span class="lineNum">     569 </span><span class="lineNoCov">          0 :         if(do_comcorr_r0){</span>
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :                 for(k=0;k&lt;alignmap.size();k++){</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :                         i=alignmap[k];</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :                         tmp1=sqrt(align[i]/totalign);</span>
<span class="lineNum">     573 </span><span class="lineNoCov">          0 :                         array_3_n[i]=tmp1*derr_dr0[i];</span>
<span class="lineNum">     574 </span><span class="lineNoCov">          0 :                         if(do_center){</span>
<span class="lineNum">     575 </span><span class="lineNoCov">          0 :                                 for(jj=0;jj&lt;alignmap.size();jj++){</span>
<span class="lineNum">     576 </span><span class="lineNoCov">          0 :                                         j=alignmap[jj];</span>
<span class="lineNum">     577 </span><span class="lineNoCov">          0 :                                         array_3_n[i]-=tmp1*(align[j]/totalign)*derr_dr0[j];</span>
<span class="lineNum">     578 </span>            :                                 }
<span class="lineNum">     579 </span>            :                         }
<span class="lineNum">     580 </span>            :                 }
<span class="lineNum">     581 </span><span class="lineNoCov">          0 :                 for(k=0;k&lt;alignmap.size();k++){</span>
<span class="lineNum">     582 </span><span class="lineNoCov">          0 :                         i=alignmap[k];</span>
<span class="lineNum">     583 </span><span class="lineNoCov">          0 :                         derr_dr0[i]=array_3_n[i];</span>
<span class="lineNum">     584 </span>            :                 }
<span class="lineNum">     585 </span>            :         }
<span class="lineNum">     586 </span>            : 
<span class="lineNum">     587 </span>            : 
<span class="lineNum">     588 </span><span class="lineNoCov">          0 :         bool do_der_r1=true;</span>
<span class="lineNum">     589 </span><span class="lineNoCov">          0 :         bool do_der_r0=true;</span>
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :         bool do_der_rotmat=true;</span>
<span class="lineNum">     591 </span>            : 
<span class="lineNum">     592 </span><span class="lineNoCov">          0 :         if(do_der_r1 &amp;&amp; do_der_rotmat){</span>
<span class="lineNum">     593 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;3;i++){</span>
<span class="lineNum">     594 </span><span class="lineNoCov">          0 :                         for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     595 </span><span class="lineNoCov">          0 :                                 for(k=0;k&lt;3;k++){</span>
<span class="lineNum">     596 </span><span class="lineNoCov">          0 :                                         for(ll=0;ll&lt;alignmap.size();ll++){</span>
<span class="lineNum">     597 </span><span class="lineNoCov">          0 :                                                 l=alignmap[ll];</span>
<span class="lineNum">     598 </span><span class="lineNoCov">          0 :                                                 int ind=i*3*3*natoms+j*3*natoms+k*natoms+l;</span>
<span class="lineNum">     599 </span><span class="lineNoCov">          0 :                                                 tmp1=sqrt(align[l]/totalign);</span>
<span class="lineNum">     600 </span><span class="lineNoCov">          0 :                                                 dd_dr_temp[l]=tmp1*dmatdp1[ind];</span>
<span class="lineNum">     601 </span><span class="lineNoCov">          0 :                                                 if(do_center){</span>
<span class="lineNum">     602 </span><span class="lineNoCov">          0 :                                                         for(nn=0;nn&lt;alignmap.size();nn++){</span>
<span class="lineNum">     603 </span><span class="lineNoCov">          0 :                                                                 n=alignmap[nn];</span>
<span class="lineNum">     604 </span><span class="lineNoCov">          0 :                                                                 dd_dr_temp[l]-=dmatdp1[ind-l+n]*tmp1*align[n]/totalign;</span>
<span class="lineNum">     605 </span>            :                                                         }
<span class="lineNum">     606 </span>            :                                                 }
<span class="lineNum">     607 </span>            : 
<span class="lineNum">     608 </span>            :                                         }
<span class="lineNum">     609 </span><span class="lineNoCov">          0 :                                         for(ll=0;ll&lt;alignmap.size();ll++){</span>
<span class="lineNum">     610 </span><span class="lineNoCov">          0 :                                                 l=alignmap[ll];</span>
<span class="lineNum">     611 </span><span class="lineNoCov">          0 :                                                 int ind=i*3*3*natoms+j*3*natoms+k*natoms+l;</span>
<span class="lineNum">     612 </span><span class="lineNoCov">          0 :                                                 dmatdp1[ind]=dd_dr_temp[l];</span>
<span class="lineNum">     613 </span>            :                                         }
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            :                                 }
<span class="lineNum">     616 </span>            :                         }
<span class="lineNum">     617 </span>            :                 }
<span class="lineNum">     618 </span>            : 
<span class="lineNum">     619 </span>            :         }
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span><span class="lineNoCov">          0 :         if(do_der_r0 &amp;&amp; do_der_rotmat){</span>
<span class="lineNum">     622 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;3;i++){</span>
<span class="lineNum">     623 </span><span class="lineNoCov">          0 :                         for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     624 </span><span class="lineNoCov">          0 :                                 for(k=0;k&lt;3;k++){</span>
<span class="lineNum">     625 </span><span class="lineNoCov">          0 :                                         for(ll=0;ll&lt;alignmap.size();ll++){</span>
<span class="lineNum">     626 </span><span class="lineNoCov">          0 :                                                 l=alignmap[ll];</span>
<span class="lineNum">     627 </span><span class="lineNoCov">          0 :                                                 int ind=i*3*3*natoms+j*3*natoms+k*natoms+l;</span>
<span class="lineNum">     628 </span><span class="lineNoCov">          0 :                                                 tmp1=sqrt(align[l]/totalign);</span>
<span class="lineNum">     629 </span><span class="lineNoCov">          0 :                                                 dd_dr_temp[l]=tmp1*dmatdp0[ind];</span>
<span class="lineNum">     630 </span><span class="lineNoCov">          0 :                                                 if(do_center){</span>
<span class="lineNum">     631 </span><span class="lineNoCov">          0 :                                                         for(nn=0;nn&lt;alignmap.size();nn++){</span>
<span class="lineNum">     632 </span><span class="lineNoCov">          0 :                                                                 n=alignmap[nn];</span>
<span class="lineNum">     633 </span><span class="lineNoCov">          0 :                                                                 dd_dr_temp[l]-=dmatdp0[ind-l+n]*tmp1*align[n]/totalign;</span>
<span class="lineNum">     634 </span>            :                                                         }
<span class="lineNum">     635 </span>            :                                                 }
<span class="lineNum">     636 </span>            :                                         }
<span class="lineNum">     637 </span><span class="lineNoCov">          0 :                                         for(ll=0;ll&lt;alignmap.size();ll++){</span>
<span class="lineNum">     638 </span><span class="lineNoCov">          0 :                                                 l=alignmap[ll];</span>
<span class="lineNum">     639 </span><span class="lineNoCov">          0 :                                                 int ind=i*3*3*natoms+j*3*natoms+k*natoms+l;</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :                                                 dmatdp0[ind]=dd_dr_temp[l];</span>
<span class="lineNum">     641 </span>            :                                         }
<span class="lineNum">     642 </span>            :                                 }
<span class="lineNum">     643 </span>            :                         }
<span class="lineNum">     644 </span>            :                 }
<span class="lineNum">     645 </span>            :         }
<span class="lineNum">     646 </span>            : 
<span class="lineNum">     647 </span>            : 
<span class="lineNum">     648 </span><span class="lineNoCov">          0 :         bool do_p1rotated=true;</span>
<span class="lineNum">     649 </span><span class="lineNoCov">          0 :         if (do_p1rotated){</span>
<span class="lineNum">     650 </span>            :                 // resize if not allocated
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineNoCov">          0 :                 if(p1.size()!=p1rotated.size())p1rotated.resize(p1.size());</span>
<span class="lineNum">     653 </span>            : 
<span class="lineNum">     654 </span>            : //              exit(0);
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++) p1rotated[i]=matmul(d,p1reset[i]);</span>
<span class="lineNum">     657 </span>            : 
<span class="lineNum">     658 </span>            :                 // reallocate difference vectors
<span class="lineNum">     659 </span><span class="lineNoCov">          0 :                 if(p1.size()!=diff1on0.size())diff1on0.resize(p1.size());</span>
<span class="lineNum">     660 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     661 </span><span class="lineNoCov">          0 :                         diff1on0[i]=p1rotated[i]-p0reset[i];</span>
<span class="lineNum">     662 </span>            :                 }
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span><span class="lineNoCov">          0 :                 if(verbose){</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P1-RESET-AND-ROTATED\n&quot;);</span>
<span class="lineNum">     666 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     667 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     2    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p1rotated[i][0]/myscale,p1rotated[i][1]/myscale,p1rotated[i][2]/myscale);</span>
<span class="lineNum">     668 </span>            :                         }
<span class="lineNum">     669 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     670 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P0-RESET\n&quot;);</span>
<span class="lineNum">     671 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     672 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     2    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p0reset[i][0]/myscale,p0reset[i][1]/myscale,p0reset[i][2]/myscale);</span>
<span class="lineNum">     673 </span>            :                         }
<span class="lineNum">     674 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     675 </span>            :                 }
<span class="lineNum">     676 </span>            : 
<span class="lineNum">     677 </span>            :         }
<span class="lineNum">     678 </span>            : 
<span class="lineNum">     679 </span>            : 
<span class="lineNum">     680 </span>            : 
<span class="lineNum">     681 </span><span class="lineNoCov">          0 :         dinv=inverse(d);</span>
<span class="lineNum">     682 </span>            : 
<span class="lineNum">     683 </span><span class="lineNoCov">          0 :         bool do_p0rotated=true;</span>
<span class="lineNum">     684 </span><span class="lineNoCov">          0 :         if (do_p0rotated){</span>
<span class="lineNum">     685 </span><span class="lineNoCov">          0 :                 if(p0.size()!=p0rotated.size())p0rotated.resize(p0.size());</span>
<span class="lineNum">     686 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++) p0rotated[i]=matmul(dinv,p0reset[i]);</span>
<span class="lineNum">     687 </span><span class="lineNoCov">          0 :                 if(p1.size()!=diff0on1.size())diff0on1.resize(p1.size());</span>
<span class="lineNum">     688 </span><span class="lineNoCov">          0 :                 for(i=0;i&lt;natoms;i++) diff0on1[i]=p0rotated[i]-p1reset[i];</span>
<span class="lineNum">     689 </span><span class="lineNoCov">          0 :                 if(verbose){</span>
<span class="lineNum">     690 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P0-RESET AND INVERSE ROTATED\n&quot;);</span>
<span class="lineNum">     691 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     692 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     1    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p0rotated[i][0]/myscale,p0rotated[i][1]/myscale,p0rotated[i][2]/myscale);</span>
<span class="lineNum">     693 </span>            :                         }
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;P1-RESET\n&quot;);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :                         for(i=0;i&lt;natoms;i++){</span>
<span class="lineNum">     697 </span><span class="lineNoCov">          0 :                                 log-&gt;printf(&quot;ATOM %6u  C   ALA     2    %8.3f%8.3f%8.3f  1.00  1.00\n&quot;,i+1,p1reset[i][0]/myscale,p1reset[i][1]/myscale,p1reset[i][2]/myscale);</span>
<span class="lineNum">     698 </span>            :                         }
<span class="lineNum">     699 </span><span class="lineNoCov">          0 :                         log-&gt;printf(&quot;END\n&quot;);</span>
<span class="lineNum">     700 </span>            :                 }
<span class="lineNum">     701 </span>            :         }
<span class="lineNum">     702 </span>            :         // copy on the official vectors:
<span class="lineNum">     703 </span><span class="lineNoCov">          0 :         rotmat0on1=d;</span>
<span class="lineNum">     704 </span><span class="lineNoCov">          0 :         rotmat1on0=dinv;</span>
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :         derrdp0.resize(natoms);</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :         derrdp0=derr_dr0;</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :         derrdp1.resize(natoms);</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :         derrdp1=derr_dr1;</span>
<span class="lineNum">     709 </span>            : 
<span class="lineNum">     710 </span>            :         // now rescale accordingly for rmsd instead of msd
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :         if(rmsd){</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :                 err=sqrt(err);</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :                 double tmp=0.5/err;</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :                 for(ii=0;ii&lt;alignmap.size();ii++){</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :                                 i=alignmap[ii];</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :                                 derrdp0[i]*=tmp;</span>
<span class="lineNum">     717 </span><span class="lineNoCov">          0 :                                 derrdp1[i]*=tmp;</span>
<span class="lineNum">     718 </span>            :                 }
<span class="lineNum">     719 </span>            : 
<span class="lineNum">     720 </span>            :         }
<span class="lineNum">     721 </span>            : 
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :         return err;</span>
<a name="723"><span class="lineNum">     723 </span>            : </a>
<span class="lineNum">     724 </span>            : }
<span class="lineNum">     725 </span><span class="lineNoCov">          0 : void Kearsley::assignP1(const std::vector&lt;Vector&gt; &amp; p1) {</span>
<span class="lineNum">     726 </span><span class="lineNoCov">          0 :         this-&gt;p1=p1;</span>
<a name="727"><span class="lineNum">     727 </span><span class="lineNoCov">          0 :         com1_is_removed=false;</span></a>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 : void Kearsley::assignP0(const std::vector&lt;Vector&gt; &amp; p0) {</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :         this-&gt;p0=p0;</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :         com0_is_removed=false;</span>
<a name="732"><span class="lineNum">     732 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineNoCov">          0 : void Kearsley::assignAlign(const std::vector&lt;double&gt; &amp; align) {</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :         this-&gt;align=align;</span>
<a name="736"><span class="lineNum">     736 </span><span class="lineNoCov">          0 : }</span></a>
<span class="lineNum">     737 </span>            : 
<span class="lineNum">     738 </span><span class="lineNoCov">          0 : void Kearsley::finiteDifferenceInterface(bool rmsd){</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;Entering rmsd finite difference test system for kearsley\n&quot;);</span>
<span class="lineNum">     740 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;-------------------------------------------\n&quot;);</span>
<span class="lineNum">     741 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;TEST1: derivative of the value (derr_dr0/derr_dr1)\n&quot;);</span>
<span class="lineNum">     742 </span>            : //// test 1
<span class="lineNum">     743 </span>            : unsigned i,j,l,m;
<span class="lineNum">     744 </span><span class="lineNoCov">          0 : double step=1.e-6,olderr,delta;</span>
<span class="lineNum">     745 </span>            : // messing up a bit with align weights
<span class="lineNum">     746 </span>            : double delta1;
<span class="lineNum">     747 </span><span class="lineNoCov">          0 : vector&lt;double&gt; align1;</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 : align1.resize(p0.size());</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 : Random rnd;</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 : for (i=0;i&lt;p0.size();i++){</span>
<span class="lineNum">     751 </span>            :                 // draw a random number
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :             delta=rnd.RandU01();</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :             delta1=rnd.RandU01();</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :             if(delta&gt;delta1){</span>
<span class="lineNum">     755 </span>            :             //if(delta&gt;0.3){
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :                 align1[i]=delta;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :             }else{align1[i]=0.;};</span>
<span class="lineNum">     758 </span>            :            // log-&gt;printf(&quot;ALIGN %d IS %8.3f\n&quot;,i,align1[i]);
<span class="lineNum">     759 </span>            : }
<span class="lineNum">     760 </span><span class="lineNoCov">          0 : assignAlign(align1);</span>
<span class="lineNum">     761 </span>            : //// get initial value of the error and derivative of it
<span class="lineNum">     762 </span><span class="lineNoCov">          0 : olderr=calculate(rmsd);</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;INITIAL ERROR VALUE: %e\n&quot;,olderr);</span>
<span class="lineNum">     764 </span>            : // store the matrix
<span class="lineNum">     765 </span><span class="lineNoCov">          0 : Tensor old_rotmat0on1=rotmat0on1;</span>
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            : //// get initial value of the error and derivative of it
<span class="lineNum">     768 </span>            : 
<span class="lineNum">     769 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;TESTING: derrdp1 \n&quot;);</span>
<span class="lineNum">     770 </span><span class="lineNoCov">          0 : for(unsigned j=0;j&lt;3;j++){</span>
<span class="lineNum">     771 </span><span class="lineNoCov">          0 :    for(unsigned i=0;i&lt;derrdp1.size();i++){</span>
<span class="lineNum">     772 </span>            :        // random displacement
<span class="lineNum">     773 </span><span class="lineNoCov">          0 :        delta=(rnd.RandU01()-0.5)*2*step;</span>
<span class="lineNum">     774 </span><span class="lineNoCov">          0 :        p1[i][j]+=delta;</span>
<span class="lineNum">     775 </span><span class="lineNoCov">          0 :            com1_is_removed=false; // this is required whenever the assignment is not done with the methods</span>
<span class="lineNum">     776 </span><span class="lineNoCov">          0 :        com0_is_removed=false; // this is required whenever the assignment is not done with the methods</span>
<span class="lineNum">     777 </span><span class="lineNoCov">          0 :        err=calculate(rmsd);</span>
<span class="lineNum">     778 </span>            :        //log-&gt;printf(&quot;INITIAL ERROR VALUE: %e NEW ERROR %e DELTA %e ELEM %d %d \n&quot;,olderr,err,delta,i,j );
<span class="lineNum">     779 </span><span class="lineNoCov">          0 :        p1[i][j]-=delta;</span>
<span class="lineNum">     780 </span><span class="lineNoCov">          0 :        switch(j){</span>
<span class="lineNum">     781 </span>            :          case 0:
<span class="lineNum">     782 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: X  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp1[i][j],(err-olderr)/delta,derrdp1[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     783 </span>            :          case 1:
<span class="lineNum">     784 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: Y  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp1[i][j],(err-olderr)/delta,derrdp1[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     785 </span>            :          case 2:
<span class="lineNum">     786 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: Z  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp1[i][j],(err-olderr)/delta,derrdp1[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span>            :        }
<span class="lineNum">     789 </span>            :    }
<span class="lineNum">     790 </span>            : }
<span class="lineNum">     791 </span>            : //exit(0);
<span class="lineNum">     792 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;TESTING: derrdp0 \n&quot;);</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 : for(unsigned j=0;j&lt;3;j++){</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :    for(unsigned i=0;i&lt;derrdp0.size();i++){</span>
<span class="lineNum">     795 </span>            :        // random displacement
<span class="lineNum">     796 </span><span class="lineNoCov">          0 :        delta=(rnd.RandU01()-0.5)*2*step;</span>
<span class="lineNum">     797 </span><span class="lineNoCov">          0 :        p0[i][j]+=delta;</span>
<span class="lineNum">     798 </span><span class="lineNoCov">          0 :        com0_is_removed=false; // this is required whenever the assignment is not done with the methods</span>
<span class="lineNum">     799 </span><span class="lineNoCov">          0 :        com1_is_removed=false; // this is required whenever the assignment is not done with the methods</span>
<span class="lineNum">     800 </span>            : 
<span class="lineNum">     801 </span><span class="lineNoCov">          0 :        err=calculate(rmsd);</span>
<span class="lineNum">     802 </span><span class="lineNoCov">          0 :        p0[i][j]-=delta;</span>
<span class="lineNum">     803 </span><span class="lineNoCov">          0 :        switch(j){</span>
<span class="lineNum">     804 </span>            :          case 0:
<span class="lineNum">     805 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: X  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp0[i][j],(err-olderr)/delta,derrdp0[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     806 </span>            :          case 1:
<span class="lineNum">     807 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: Y  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp0[i][j],(err-olderr)/delta,derrdp0[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     808 </span>            :          case 2:
<span class="lineNum">     809 </span><span class="lineNoCov">          0 :              log-&gt;printf(&quot;TESTING: Z  %4u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,i,derrdp0[i][j],(err-olderr)/delta,derrdp0[i][j]-(err-olderr)/delta,align[i]);break;</span>
<span class="lineNum">     810 </span>            :        }
<span class="lineNum">     811 </span>            :    }
<span class="lineNum">     812 </span>            : }
<span class="lineNum">     813 </span>            : 
<span class="lineNum">     814 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;TESTING: dmatdp0 \n&quot;);</span>
<span class="lineNum">     815 </span><span class="lineNoCov">          0 : for(l=0;l&lt;3;l++){</span>
<span class="lineNum">     816 </span><span class="lineNoCov">          0 :   for(m=0;m&lt;3;m++){</span>
<span class="lineNum">     817 </span><span class="lineNoCov">          0 :     for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     818 </span><span class="lineNoCov">          0 :        for(i=0;i&lt;p0.size();i++){</span>
<span class="lineNum">     819 </span>            :            // random displacement
<span class="lineNum">     820 </span><span class="lineNoCov">          0 :            delta=(rnd.RandU01()-0.5)*2*step;</span>
<span class="lineNum">     821 </span><span class="lineNoCov">          0 :            p0[i][j]+=delta;</span>
<span class="lineNum">     822 </span><span class="lineNoCov">          0 :            com0_is_removed=false;</span>
<span class="lineNum">     823 </span><span class="lineNoCov">          0 :            com1_is_removed=false;</span>
<span class="lineNum">     824 </span><span class="lineNoCov">          0 :            calculate(rmsd);</span>
<span class="lineNum">     825 </span><span class="lineNoCov">          0 :            p0[i][j]-=delta;</span>
<span class="lineNum">     826 </span><span class="lineNoCov">          0 :            int ind=l*3*3*p0.size()+m*3*p0.size()+j*p0.size()+i;</span>
<span class="lineNum">     827 </span><span class="lineNoCov">          0 :            switch(j){</span>
<span class="lineNum">     828 </span>            :                  case 0:
<span class="lineNum">     829 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP0 [ %u ][ %u ]:  X %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp0[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp0[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span>            :                  case 1:
<span class="lineNum">     832 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP0 [ %u ][ %u ]:  Y %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp0[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp0[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     833 </span>            : 
<span class="lineNum">     834 </span>            :                  case 2:
<span class="lineNum">     835 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP0 [ %u ][ %u ]:  Z %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp0[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp0[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span>            :            }
<span class="lineNum">     838 </span>            :        }
<span class="lineNum">     839 </span>            :     }
<span class="lineNum">     840 </span>            :   }
<span class="lineNum">     841 </span>            : }
<span class="lineNum">     842 </span><span class="lineNoCov">          0 : log-&gt;printf(&quot;TESTING: dmatdp1 \n&quot;);</span>
<span class="lineNum">     843 </span><span class="lineNoCov">          0 : for(l=0;l&lt;3;l++){</span>
<span class="lineNum">     844 </span><span class="lineNoCov">          0 :   for(m=0;m&lt;3;m++){</span>
<span class="lineNum">     845 </span><span class="lineNoCov">          0 :     for(j=0;j&lt;3;j++){</span>
<span class="lineNum">     846 </span><span class="lineNoCov">          0 :        for(i=0;i&lt;p1.size();i++){</span>
<span class="lineNum">     847 </span>            :            // random displacement
<span class="lineNum">     848 </span><span class="lineNoCov">          0 :            delta=(rnd.RandU01()-0.5)*2*step;</span>
<span class="lineNum">     849 </span><span class="lineNoCov">          0 :            p1[i][j]+=delta;</span>
<span class="lineNum">     850 </span><span class="lineNoCov">          0 :            com0_is_removed=false;</span>
<span class="lineNum">     851 </span><span class="lineNoCov">          0 :            com1_is_removed=false;</span>
<span class="lineNum">     852 </span><span class="lineNoCov">          0 :            calculate(rmsd);</span>
<span class="lineNum">     853 </span><span class="lineNoCov">          0 :            p1[i][j]-=delta;</span>
<span class="lineNum">     854 </span><span class="lineNoCov">          0 :            int ind=l*3*3*p1.size()+m*3*p1.size()+j*p1.size()+i;</span>
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :            switch(j){</span>
<span class="lineNum">     856 </span>            : 
<span class="lineNum">     857 </span>            :              case 0:
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP1 [ %u ][ %u ]:  X %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp1[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp1[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span>            :              case 1:
<span class="lineNum">     861 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP1 [ %u ][ %u ]:  Y %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp1[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp1[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     862 </span>            : 
<span class="lineNum">     863 </span>            :              case 2:
<span class="lineNum">     864 </span><span class="lineNoCov">          0 :                 log-&gt;printf(&quot;TESTING: DMATDP1 [ %u ][ %u ]:  Z %u ANAL %18.9f NUMER %18.9f DELTA %18.9f ALIGN %6.2f\n&quot;,l,m,i,dmatdp1[ind],(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,dmatdp1[ind]-(rotmat0on1[l][m]- old_rotmat0on1[l][m])/delta,align[i]);break;</span>
<span class="lineNum">     865 </span>            : 
<span class="lineNum">     866 </span>            :            }
<span class="lineNum">     867 </span>            :        }
<span class="lineNum">     868 </span>            :     }
<span class="lineNum">     869 </span>            :   }
<span class="lineNum">     870 </span>            : }
<span class="lineNum">     871 </span>            : 
<a name="872"><span class="lineNum">     872 </span><span class="lineNoCov">          0 :         exit(0);</span></a>
<span class="lineNum">     873 </span>            : }
<span class="lineNum">     874 </span><span class="lineCov">       4014 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
