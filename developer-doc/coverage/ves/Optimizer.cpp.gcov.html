<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - plumed test coverage - ves/Optimizer.cpp</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">ves</a> - Optimizer.cpp<span style="font-size: 80%;"> (source / <a href="Optimizer.cpp.func.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">plumed test coverage</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">554</td>
            <td class="headerCovTableEntry">726</td>
            <td class="headerCovTableEntryMed">76.3 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-02-14</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntry">32</td>
            <td class="headerCovTableEntryMed">87.5 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</a>
<span class="lineNum">       2 </span>            :    Copyright (c) 2016-2017 The ves-code team
<span class="lineNum">       3 </span>            :    (see the PEOPLE-VES file at the root of this folder for a list of names)
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            :    See http://www.ves-code.org for more information.
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            :    This file is part of ves-code, version 1.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            :    ves-code is free software: you can redistribute it and/or modify
<span class="lineNum">      10 </span>            :    it under the terms of the GNU Lesser General Public License as published by
<span class="lineNum">      11 </span>            :    the Free Software Foundation, either version 3 of the License, or
<span class="lineNum">      12 </span>            :    (at your option) any later version.
<span class="lineNum">      13 </span>            : 
<span class="lineNum">      14 </span>            :    ves-code is distributed in the hope that it will be useful,
<span class="lineNum">      15 </span>            :    but WITHOUT ANY WARRANTY; without even the implied warranty of
<span class="lineNum">      16 </span>            :    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
<span class="lineNum">      17 </span>            :    GNU Lesser General Public License for more details.
<span class="lineNum">      18 </span>            : 
<span class="lineNum">      19 </span>            :    You should have received a copy of the GNU Lesser General Public License
<span class="lineNum">      20 </span>            :    along with ves-code.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
<span class="lineNum">      21 </span>            : +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
<span class="lineNum">      22 </span>            : 
<span class="lineNum">      23 </span>            : #include &quot;Optimizer.h&quot;
<span class="lineNum">      24 </span>            : #include &quot;CoeffsVector.h&quot;
<span class="lineNum">      25 </span>            : #include &quot;CoeffsMatrix.h&quot;
<span class="lineNum">      26 </span>            : #include &quot;VesBias.h&quot;
<span class="lineNum">      27 </span>            : 
<span class="lineNum">      28 </span>            : #include &quot;tools/Exception.h&quot;
<span class="lineNum">      29 </span>            : #include &quot;core/PlumedMain.h&quot;
<span class="lineNum">      30 </span>            : #include &quot;core/ActionSet.h&quot;
<span class="lineNum">      31 </span>            : #include &quot;tools/Communicator.h&quot;
<span class="lineNum">      32 </span>            : #include &quot;tools/File.h&quot;
<span class="lineNum">      33 </span>            : #include &quot;tools/FileBase.h&quot;
<span class="lineNum">      34 </span>            : 
<span class="lineNum">      35 </span>            : 
<span class="lineNum">      36 </span>            : namespace PLMD{
<a name="37"><span class="lineNum">      37 </span>            : namespace ves{</a>
<span class="lineNum">      38 </span>            : 
<span class="lineNum">      39 </span><span class="lineCov">         47 : Optimizer::Optimizer(const ActionOptions&amp;ao):</span>
<span class="lineNum">      40 </span>            : Action(ao),
<span class="lineNum">      41 </span>            : ActionPilot(ao),
<span class="lineNum">      42 </span>            : ActionWithValue(ao),
<span class="lineNum">      43 </span>            : description_(&quot;Undefined&quot;),
<span class="lineNum">      44 </span>            : type_(&quot;Undefined&quot;),
<span class="lineNum">      45 </span>            : stepsizes_(0),
<span class="lineNum">      46 </span>            : current_stepsizes(0),
<span class="lineNum">      47 </span>            : fixed_stepsize_(true),
<span class="lineNum">      48 </span>            : iter_counter(0),
<span class="lineNum">      49 </span>            : use_hessian_(false),
<span class="lineNum">      50 </span>            : diagonal_hessian_(true),
<span class="lineNum">      51 </span>            : use_mwalkers_mpi_(false),
<span class="lineNum">      52 </span>            : mwalkers_mpi_single_files_(true),
<span class="lineNum">      53 </span>            : dynamic_targetdists_(0),
<span class="lineNum">      54 </span>            : ustride_targetdist_(0),
<span class="lineNum">      55 </span>            : coeffssetid_prefix_(&quot;&quot;),
<span class="lineNum">      56 </span>            : coeffs_wstride_(100),
<span class="lineNum">      57 </span>            : coeffsOFiles_(0),
<span class="lineNum">      58 </span>            : coeffs_output_fmt_(&quot;&quot;),
<span class="lineNum">      59 </span>            : gradient_wstride_(100),
<span class="lineNum">      60 </span>            : gradientOFiles_(0),
<span class="lineNum">      61 </span>            : gradient_output_fmt_(&quot;&quot;),
<span class="lineNum">      62 </span>            : hessian_wstride_(100),
<span class="lineNum">      63 </span>            : hessianOFiles_(0),
<span class="lineNum">      64 </span>            : hessian_output_fmt_(&quot;&quot;),
<span class="lineNum">      65 </span>            : targetdist_averages_wstride_(0),
<span class="lineNum">      66 </span>            : targetdist_averagesOFiles_(0),
<span class="lineNum">      67 </span>            : targetdist_averages_output_fmt_(&quot;&quot;),
<span class="lineNum">      68 </span>            : nbiases_(0),
<span class="lineNum">      69 </span>            : bias_pntrs_(0),
<span class="lineNum">      70 </span>            : ncoeffssets_(0),
<span class="lineNum">      71 </span>            : coeffs_pntrs_(0),
<span class="lineNum">      72 </span>            : aux_coeffs_pntrs_(0),
<span class="lineNum">      73 </span>            : gradient_pntrs_(0),
<span class="lineNum">      74 </span>            : aver_gradient_pntrs_(0),
<span class="lineNum">      75 </span>            : hessian_pntrs_(0),
<span class="lineNum">      76 </span>            : coeffs_mask_pntrs_(0),
<span class="lineNum">      77 </span>            : targetdist_averages_pntrs_(0),
<span class="lineNum">      78 </span>            : identical_coeffs_shape_(true),
<span class="lineNum">      79 </span>            : bias_output_active_(false),
<span class="lineNum">      80 </span>            : bias_output_stride_(0),
<span class="lineNum">      81 </span>            : fes_output_active_(false),
<span class="lineNum">      82 </span>            : fes_output_stride_(0),
<span class="lineNum">      83 </span>            : fesproj_output_active_(false),
<span class="lineNum">      84 </span>            : fesproj_output_stride_(0),
<span class="lineNum">      85 </span>            : targetdist_output_active_(false),
<span class="lineNum">      86 </span>            : targetdist_output_stride_(0),
<span class="lineNum">      87 </span>            : targetdist_proj_output_active_(false),
<span class="lineNum">      88 </span>            : targetdist_proj_output_stride_(0),
<span class="lineNum">      89 </span><span class="lineCov">         47 : isFirstStep(true)</span>
<span class="lineNum">      90 </span>            : {
<span class="lineNum">      91 </span><span class="lineCov">         47 :   std::vector&lt;std::string&gt; bias_labels(0);</span>
<span class="lineNum">      92 </span><span class="lineCov">         47 :   parseVector(&quot;BIAS&quot;,bias_labels);</span>
<span class="lineNum">      93 </span><span class="lineCov">         47 :   plumed_massert(bias_labels.size()&gt;0,&quot;problem with BIAS keyword&quot;);</span>
<span class="lineNum">      94 </span><span class="lineCov">         47 :   nbiases_ = bias_labels.size();</span>
<span class="lineNum">      95 </span>            :   //
<span class="lineNum">      96 </span><span class="lineCov">         47 :   bias_pntrs_.resize(nbiases_);</span>
<span class="lineNum">      97 </span>            :   //
<span class="lineNum">      98 </span><span class="lineCov">         94 :   for(unsigned int i=0; i&lt;nbiases_; i++) {</span>
<span class="lineNum">      99 </span><span class="lineCov">         47 :     bias_pntrs_[i]=plumed.getActionSet().selectWithLabel&lt;VesBias*&gt;(bias_labels[i]);</span>
<span class="lineNum">     100 </span><span class="lineCov">         47 :     if(!bias_pntrs_[i]){plumed_merror(&quot;VES bias &quot;+bias_labels[i]+&quot; does not exist. NOTE: the optimizer should always be defined AFTER the VES biases.&quot;);}</span>
<span class="lineNum">     101 </span>            :     //
<span class="lineNum">     102 </span><span class="lineCov">         47 :     bias_pntrs_[i]-&gt;linkOptimizer(this);</span>
<span class="lineNum">     103 </span>            :     //
<span class="lineNum">     104 </span><span class="lineCov">         47 :     std::vector&lt;CoeffsVector*&gt; pntrs_coeffs = bias_pntrs_[i]-&gt;getCoeffsPntrs();</span>
<span class="lineNum">     105 </span><span class="lineCov">         94 :     std::vector&lt;CoeffsVector*&gt; pntrs_gradient = bias_pntrs_[i]-&gt;getGradientPntrs();</span>
<span class="lineNum">     106 </span><span class="lineCov">         94 :     std::vector&lt;CoeffsVector*&gt; pntrs_targetdist_averages = bias_pntrs_[i]-&gt;getTargetDistAveragesPntrs();</span>
<span class="lineNum">     107 </span><span class="lineCov">         47 :     plumed_massert(pntrs_coeffs.size()==pntrs_gradient.size(),&quot;something wrong in the coefficients and gradient passed from VES bias&quot;);</span>
<span class="lineNum">     108 </span><span class="lineCov">         47 :     plumed_massert(pntrs_coeffs.size()==pntrs_targetdist_averages.size(),&quot;something wrong in the coefficients and target distribution averages passed from VES bias&quot;);</span>
<span class="lineNum">     109 </span><span class="lineCov">         94 :     for(unsigned int k=0; k&lt;pntrs_coeffs.size(); k++){</span>
<span class="lineNum">     110 </span><span class="lineCov">         47 :       plumed_massert(pntrs_coeffs[k] != NULL,&quot;some coefficient is not linked correctly&quot;);</span>
<span class="lineNum">     111 </span><span class="lineCov">         47 :       plumed_massert(pntrs_gradient[k] != NULL,&quot;some gradient is not linked correctly&quot;);</span>
<span class="lineNum">     112 </span><span class="lineCov">         47 :       plumed_massert(pntrs_targetdist_averages[k] != NULL,&quot;some target distribution average is not linked correctly&quot;);</span>
<span class="lineNum">     113 </span><span class="lineCov">         47 :       pntrs_coeffs[k]-&gt;turnOnIterationCounter();</span>
<span class="lineNum">     114 </span><span class="lineCov">         47 :       coeffs_pntrs_.push_back(pntrs_coeffs[k]);</span>
<span class="lineNum">     115 </span><span class="lineCov">         47 :       pntrs_gradient[k]-&gt;turnOnIterationCounter();</span>
<span class="lineNum">     116 </span><span class="lineCov">         47 :       gradient_pntrs_.push_back(pntrs_gradient[k]);</span>
<span class="lineNum">     117 </span><span class="lineCov">         47 :       pntrs_targetdist_averages[k]-&gt;turnOnIterationCounter();</span>
<span class="lineNum">     118 </span><span class="lineCov">         47 :       targetdist_averages_pntrs_.push_back(pntrs_targetdist_averages[k]);</span>
<span class="lineNum">     119 </span>            :       //
<span class="lineNum">     120 </span><span class="lineCov">         47 :       CoeffsVector* aux_coeffs_tmp = new CoeffsVector(*pntrs_coeffs[k]);</span>
<span class="lineNum">     121 </span><span class="lineCov">         47 :       std::string aux_label = pntrs_coeffs[k]-&gt;getLabel();</span>
<span class="lineNum">     122 </span><span class="lineCov">         47 :       if(aux_label.find(&quot;coeffs&quot;)!=std::string::npos){</span>
<span class="lineNum">     123 </span><span class="lineCov">         47 :         aux_label.replace(aux_label.find(&quot;coeffs&quot;), std::string(&quot;coeffs&quot;).length(), &quot;aux_coeffs&quot;);</span>
<span class="lineNum">     124 </span>            :       }
<span class="lineNum">     125 </span>            :       else {
<span class="lineNum">     126 </span><span class="lineNoCov">          0 :         aux_label += &quot;_aux&quot;;</span>
<span class="lineNum">     127 </span>            :       }
<span class="lineNum">     128 </span><span class="lineCov">         47 :       aux_coeffs_tmp-&gt;setLabels(aux_label);</span>
<span class="lineNum">     129 </span><span class="lineCov">         47 :       aux_coeffs_pntrs_.push_back(aux_coeffs_tmp);</span>
<span class="lineNum">     130 </span><span class="lineCov">         47 :       AuxCoeffs(i).setValues( Coeffs(i) );</span>
<span class="lineNum">     131 </span><span class="lineCov">         47 :     }</span>
<span class="lineNum">     132 </span><span class="lineCov">         47 :   }</span>
<span class="lineNum">     133 </span><span class="lineCov">         47 :   ncoeffssets_ = coeffs_pntrs_.size();</span>
<span class="lineNum">     134 </span><span class="lineCov">         47 :   plumed_massert(aux_coeffs_pntrs_.size()==ncoeffssets_,&quot;problems in linking aux coefficients&quot;);</span>
<span class="lineNum">     135 </span><span class="lineCov">         47 :   plumed_massert(gradient_pntrs_.size()==ncoeffssets_,&quot;problems in linking gradients&quot;);</span>
<span class="lineNum">     136 </span><span class="lineCov">         47 :   setAllCoeffsSetIterationCounters();</span>
<span class="lineNum">     137 </span>            : 
<span class="lineNum">     138 </span>            : 
<span class="lineNum">     139 </span>            :   //
<span class="lineNum">     140 </span><span class="lineCov">         47 :   identical_coeffs_shape_ = true;</span>
<span class="lineNum">     141 </span><span class="lineCov">         47 :   for(unsigned int i=1; i&lt;ncoeffssets_; i++) {</span>
<span class="lineNum">     142 </span><span class="lineNoCov">          0 :     if(!coeffs_pntrs_[0]-&gt;sameShape(*coeffs_pntrs_[i])){</span>
<span class="lineNum">     143 </span><span class="lineNoCov">          0 :       identical_coeffs_shape_ = false;</span>
<span class="lineNum">     144 </span><span class="lineNoCov">          0 :       break;</span>
<span class="lineNum">     145 </span>            :     }
<span class="lineNum">     146 </span>            :   }
<span class="lineNum">     147 </span>            :   //
<span class="lineNum">     148 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;STEPSIZE&quot;)){</span>
<span class="lineNum">     149 </span><span class="lineCov">         42 :     plumed_assert(!keywords.exists(&quot;INITIAL_STEPSIZE&quot;));</span>
<span class="lineNum">     150 </span><span class="lineCov">         42 :     fixed_stepsize_=true;</span>
<span class="lineNum">     151 </span><span class="lineCov">         42 :     parseMultipleValues(&quot;STEPSIZE&quot;,stepsizes_);</span>
<span class="lineNum">     152 </span><span class="lineCov">         42 :     setCurrentStepSizes(stepsizes_);</span>
<span class="lineNum">     153 </span>            :   }
<span class="lineNum">     154 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;INITIAL_STEPSIZE&quot;)){</span>
<span class="lineNum">     155 </span><span class="lineCov">          3 :     plumed_assert(!keywords.exists(&quot;STEPSIZE&quot;));</span>
<span class="lineNum">     156 </span><span class="lineCov">          3 :     fixed_stepsize_=false;</span>
<span class="lineNum">     157 </span><span class="lineCov">          3 :     parseMultipleValues(&quot;INITIAL_STEPSIZE&quot;,stepsizes_);</span>
<span class="lineNum">     158 </span><span class="lineCov">          3 :     setCurrentStepSizes(stepsizes_);</span>
<span class="lineNum">     159 </span>            :   }
<span class="lineNum">     160 </span>            :   //
<span class="lineNum">     161 </span><span class="lineCov">         47 :   if(ncoeffssets_==1){</span>
<span class="lineNum">     162 </span><span class="lineCov">         47 :     log.printf(&quot;  optimizing VES bias %s with label %s: \n&quot;,bias_pntrs_[0]-&gt;getName().c_str(),bias_pntrs_[0]-&gt;getLabel().c_str());</span>
<span class="lineNum">     163 </span><span class="lineCov">         47 :     log.printf(&quot;   KbT: %f\n&quot;,bias_pntrs_[0]-&gt;getKbT());</span>
<span class="lineNum">     164 </span><span class="lineCov">         47 :     log.printf(&quot;  number of coefficients: %zu\n&quot;,coeffs_pntrs_[0]-&gt;numberOfCoeffs());</span>
<span class="lineNum">     165 </span><span class="lineCov">         47 :     if(stepsizes_.size()&gt;0){</span>
<span class="lineNum">     166 </span><span class="lineCov">         45 :       if(fixed_stepsize_){log.printf(&quot;  using a constant step size of %f\n&quot;,stepsizes_[0]);}</span>
<span class="lineNum">     167 </span><span class="lineCov">          3 :       else{log.printf(&quot;  using an initial step size of %f\n&quot;,stepsizes_[0]);}</span>
<span class="lineNum">     168 </span>            :     }
<span class="lineNum">     169 </span>            :   }
<span class="lineNum">     170 </span>            :   else {
<span class="lineNum">     171 </span><span class="lineNoCov">          0 :     log.printf(&quot;  optimizing %u coefficent sets from following %u VES biases:\n&quot;,ncoeffssets_,nbiases_);</span>
<span class="lineNum">     172 </span><span class="lineNoCov">          0 :     for(unsigned int i=0; i&lt;nbiases_; i++) {</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :       log.printf(&quot;   %s of type %s (KbT: %f) \n&quot;,bias_pntrs_[i]-&gt;getLabel().c_str(),bias_pntrs_[i]-&gt;getName().c_str(),bias_pntrs_[i]-&gt;getKbT());</span>
<span class="lineNum">     174 </span>            :     }
<span class="lineNum">     175 </span><span class="lineNoCov">          0 :     size_t tot_ncoeffs = 0;</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++) {</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :       log.printf(&quot;  coefficient set %u: \n&quot;,i);</span>
<span class="lineNum">     178 </span><span class="lineNoCov">          0 :       log.printf(&quot;   used in bias %s (type %s)\n&quot;,coeffs_pntrs_[i]-&gt;getPntrToAction()-&gt;getLabel().c_str(),coeffs_pntrs_[i]-&gt;getPntrToAction()-&gt;getName().c_str());</span>
<span class="lineNum">     179 </span><span class="lineNoCov">          0 :       log.printf(&quot;   number of coefficients: %zu\n&quot;,coeffs_pntrs_[i]-&gt;numberOfCoeffs());</span>
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :       if(stepsizes_.size()&gt;0){</span>
<span class="lineNum">     181 </span><span class="lineNoCov">          0 :         if(fixed_stepsize_){log.printf(&quot;   using a constant step size of %f\n&quot;,stepsizes_[i]);}</span>
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :         else{log.printf(&quot;   using an initial step size of %f\n&quot;,stepsizes_[i]);}</span>
<span class="lineNum">     183 </span>            :       }
<span class="lineNum">     184 </span><span class="lineNoCov">          0 :       tot_ncoeffs += coeffs_pntrs_[i]-&gt;numberOfCoeffs();</span>
<span class="lineNum">     185 </span>            :     }
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :     log.printf(&quot;  total number of coefficients: %zu\n&quot;,tot_ncoeffs);</span>
<span class="lineNum">     187 </span><span class="lineNoCov">          0 :     if(identical_coeffs_shape_){</span>
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :       log.printf(&quot;  the indices shape is identical for all coefficient sets\n&quot;);</span>
<span class="lineNum">     189 </span>            :     }
<span class="lineNum">     190 </span>            :     else{
<span class="lineNum">     191 </span><span class="lineNoCov">          0 :       log.printf(&quot;  the indices shape differs between coefficient sets\n&quot;);</span>
<span class="lineNum">     192 </span>            :     }
<span class="lineNum">     193 </span>            :   }
<span class="lineNum">     194 </span>            : 
<span class="lineNum">     195 </span>            :   //
<span class="lineNum">     196 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;FULL_HESSIAN&quot;)){</span>
<span class="lineNum">     197 </span><span class="lineNoCov">          0 :     bool full_hessian=false;</span>
<span class="lineNum">     198 </span><span class="lineNoCov">          0 :     parseFlag(&quot;FULL_HESSIAN&quot;,full_hessian);</span>
<span class="lineNum">     199 </span><span class="lineNoCov">          0 :     diagonal_hessian_ = !full_hessian;</span>
<span class="lineNum">     200 </span>            :   }
<span class="lineNum">     201 </span>            :   //
<span class="lineNum">     202 </span><span class="lineCov">         47 :   bool mw_single_files = false;</span>
<span class="lineNum">     203 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;MULTIPLE_WALKERS&quot;)){</span>
<span class="lineNum">     204 </span><span class="lineCov">         46 :     parseFlag(&quot;MULTIPLE_WALKERS&quot;,use_mwalkers_mpi_);</span>
<span class="lineNum">     205 </span><span class="lineCov">         46 :     if(use_mwalkers_mpi_){</span>
<span class="lineNum">     206 </span><span class="lineNoCov">          0 :       mw_single_files=true;</span>
<span class="lineNum">     207 </span>            :     }
<span class="lineNum">     208 </span>            :   }
<span class="lineNum">     209 </span>            : 
<span class="lineNum">     210 </span><span class="lineCov">         47 :   int numwalkers=1;</span>
<span class="lineNum">     211 </span><span class="lineCov">         47 :   int walker_rank=0;</span>
<span class="lineNum">     212 </span><span class="lineCov">         47 :   if(comm.Get_rank()==0){</span>
<span class="lineNum">     213 </span><span class="lineCov">         38 :     numwalkers = multi_sim_comm.Get_size();</span>
<span class="lineNum">     214 </span><span class="lineCov">         38 :     walker_rank = multi_sim_comm.Get_rank();</span>
<span class="lineNum">     215 </span>            :   }
<span class="lineNum">     216 </span><span class="lineCov">         47 :   comm.Bcast(numwalkers,0);</span>
<span class="lineNum">     217 </span><span class="lineCov">         47 :   comm.Bcast(walker_rank,0);</span>
<span class="lineNum">     218 </span><span class="lineCov">         47 :   if(use_mwalkers_mpi_ &amp;&amp; numwalkers==1){</span>
<span class="lineNum">     219 </span><span class="lineNoCov">          0 :       plumed_merror(&quot;using the MULTIPLE_WALKERS keyword does not make sense if running the MD code with a single replica&quot;);</span>
<span class="lineNum">     220 </span>            :   }
<span class="lineNum">     221 </span><span class="lineCov">         47 :   if(use_mwalkers_mpi_){</span>
<span class="lineNum">     222 </span><span class="lineNoCov">          0 :     log.printf(&quot;  optimization performed using multiple walkers connected via MPI:\n&quot;);</span>
<span class="lineNum">     223 </span><span class="lineNoCov">          0 :     log.printf(&quot;   number of walkers: %d\n&quot;,numwalkers);</span>
<span class="lineNum">     224 </span><span class="lineNoCov">          0 :     log.printf(&quot;   walker number: %d\n&quot;,walker_rank);</span>
<span class="lineNum">     225 </span>            :   }
<span class="lineNum">     226 </span>            : 
<span class="lineNum">     227 </span><span class="lineCov">         47 :   dynamic_targetdists_.resize(nbiases_,false);</span>
<span class="lineNum">     228 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;TARGETDIST_STRIDE&quot;)){</span>
<span class="lineNum">     229 </span><span class="lineCov">         43 :     bool need_stride = false;</span>
<span class="lineNum">     230 </span><span class="lineCov">         86 :     for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     231 </span><span class="lineCov">         43 :       dynamic_targetdists_[i] = bias_pntrs_[i]-&gt;dynamicTargetDistribution();</span>
<span class="lineNum">     232 </span><span class="lineCov">         43 :       if(dynamic_targetdists_[i]){need_stride = true;}</span>
<span class="lineNum">     233 </span>            :     }
<span class="lineNum">     234 </span><span class="lineCov">         43 :     parse(&quot;TARGETDIST_STRIDE&quot;,ustride_targetdist_);</span>
<span class="lineNum">     235 </span><span class="lineCov">         43 :     if(need_stride &amp;&amp; ustride_targetdist_==0){</span>
<span class="lineNum">     236 </span><span class="lineNoCov">          0 :       plumed_merror(&quot;one of the biases has a dynamic target distribution so you need to give stride for updating it by using the TARGETDIST_STRIDE keyword&quot;);</span>
<span class="lineNum">     237 </span>            :     }
<span class="lineNum">     238 </span><span class="lineCov">         43 :     if(!need_stride &amp;&amp; ustride_targetdist_!=0){</span>
<span class="lineNum">     239 </span><span class="lineNoCov">          0 :       plumed_merror(&quot;using the TARGETDIST_STRIDE keyword doesn't make sense as there is no dynamic target distribution to update&quot;);</span>
<span class="lineNum">     240 </span>            :     }
<span class="lineNum">     241 </span><span class="lineCov">         43 :     if(ustride_targetdist_&gt;0){</span>
<span class="lineNum">     242 </span><span class="lineCov">         26 :       if(nbiases_==1){</span>
<span class="lineNum">     243 </span><span class="lineCov">         26 :         log.printf(&quot;  the target distribution will be updated very %u coefficent iterations\n&quot;,ustride_targetdist_);</span>
<span class="lineNum">     244 </span>            :       }
<span class="lineNum">     245 </span>            :       else{
<span class="lineNum">     246 </span><span class="lineNoCov">          0 :         log.printf(&quot;  the target distribution will be updated very %u coefficent iterations for the following biases\n   &quot;,ustride_targetdist_);</span>
<span class="lineNum">     247 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     248 </span><span class="lineNoCov">          0 :           log.printf(&quot;%s &quot;,bias_pntrs_[i]-&gt;getLabel().c_str());</span>
<span class="lineNum">     249 </span>            :         }
<span class="lineNum">     250 </span><span class="lineNoCov">          0 :         log.printf(&quot;\n&quot;);</span>
<span class="lineNum">     251 </span>            :       }
<span class="lineNum">     252 </span>            :     }
<span class="lineNum">     253 </span>            :   }
<span class="lineNum">     254 </span>            : 
<span class="lineNum">     255 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;MONITOR_AVERAGE_GRADIENT&quot;)){</span>
<span class="lineNum">     256 </span><span class="lineNoCov">          0 :     bool monitor_aver_gradient = false;</span>
<span class="lineNum">     257 </span><span class="lineNoCov">          0 :     parseFlag(&quot;MONITOR_AVERAGE_GRADIENT&quot;,monitor_aver_gradient);</span>
<span class="lineNum">     258 </span><span class="lineNoCov">          0 :     if(monitor_aver_gradient){</span>
<span class="lineNum">     259 </span><span class="lineNoCov">          0 :       unsigned int averaging_exp_decay=0;</span>
<span class="lineNum">     260 </span><span class="lineNoCov">          0 :       parse(&quot;MONITOR_AVERAGES_EXP_DECAY&quot;,averaging_exp_decay);</span>
<span class="lineNum">     261 </span><span class="lineNoCov">          0 :       aver_gradient_pntrs_.clear();</span>
<span class="lineNum">     262 </span><span class="lineNoCov">          0 :       for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     263 </span><span class="lineNoCov">          0 :         CoeffsVector* aver_gradient_tmp = new CoeffsVector(*gradient_pntrs_[i]);</span>
<span class="lineNum">     264 </span><span class="lineNoCov">          0 :         aver_gradient_tmp-&gt;clear();</span>
<span class="lineNum">     265 </span><span class="lineNoCov">          0 :         std::string aver_grad_label = aver_gradient_tmp-&gt;getLabel();</span>
<span class="lineNum">     266 </span><span class="lineNoCov">          0 :         if(aver_grad_label.find(&quot;gradient&quot;)!=std::string::npos){</span>
<span class="lineNum">     267 </span><span class="lineNoCov">          0 :           aver_grad_label.replace(aver_grad_label.find(&quot;gradient&quot;), std::string(&quot;gradient&quot;).length(), &quot;aver_gradient&quot;);</span>
<span class="lineNum">     268 </span>            :         }
<span class="lineNum">     269 </span>            :         else {
<span class="lineNum">     270 </span><span class="lineNoCov">          0 :           aver_grad_label += &quot;_aver&quot;;</span>
<span class="lineNum">     271 </span>            :         }
<span class="lineNum">     272 </span><span class="lineNoCov">          0 :         aver_gradient_tmp-&gt;setLabels(aver_grad_label);</span>
<span class="lineNum">     273 </span><span class="lineNoCov">          0 :         if(averaging_exp_decay&gt;0){</span>
<span class="lineNum">     274 </span><span class="lineNoCov">          0 :           aver_gradient_tmp-&gt;setupExponentiallyDecayingAveraging(averaging_exp_decay);</span>
<span class="lineNum">     275 </span>            :         }
<span class="lineNum">     276 </span><span class="lineNoCov">          0 :         aver_gradient_pntrs_.push_back(aver_gradient_tmp);</span>
<span class="lineNum">     277 </span><span class="lineNoCov">          0 :       }</span>
<span class="lineNum">     278 </span>            :     }
<span class="lineNum">     279 </span>            :   }
<span class="lineNum">     280 </span>            : 
<span class="lineNum">     281 </span>            : 
<span class="lineNum">     282 </span><span class="lineCov">         47 :   if(ncoeffssets_&gt;1){</span>
<span class="lineNum">     283 </span><span class="lineNoCov">          0 :     coeffssetid_prefix_=&quot;c-&quot;;</span>
<span class="lineNum">     284 </span><span class="lineNoCov">          0 :     if(keywords.exists(&quot;COEFFS_SET_ID_PREFIX&quot;)){</span>
<span class="lineNum">     285 </span><span class="lineNoCov">          0 :       parse(&quot;COEFFS_SET_ID_PREFIX&quot;,coeffssetid_prefix_);</span>
<span class="lineNum">     286 </span>            :     }
<span class="lineNum">     287 </span>            :   }
<span class="lineNum">     288 </span>            :   else{
<span class="lineNum">     289 </span><span class="lineCov">         47 :     coeffssetid_prefix_=&quot;&quot;;</span>
<span class="lineNum">     290 </span><span class="lineCov">         47 :     if(keywords.exists(&quot;COEFFS_SET_ID_PREFIX&quot;)){</span>
<span class="lineNum">     291 </span><span class="lineCov">         46 :       parse(&quot;COEFFS_SET_ID_PREFIX&quot;,coeffssetid_prefix_);</span>
<span class="lineNum">     292 </span>            :     }
<span class="lineNum">     293 </span><span class="lineCov">         47 :     if(coeffssetid_prefix_.size()&gt;0){</span>
<span class="lineNum">     294 </span><span class="lineNoCov">          0 :       plumed_merror(&quot;COEFFS_SET_ID_PREFIX should only be given if optimizing multiple coefficent sets&quot;);</span>
<span class="lineNum">     295 </span>            :     }
<span class="lineNum">     296 </span>            :   }
<span class="lineNum">     297 </span>            : 
<span class="lineNum">     298 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;INITIAL_COEFFS&quot;)){</span>
<span class="lineNum">     299 </span><span class="lineCov">         46 :     std::vector&lt;std::string&gt; initial_coeffs_fnames;</span>
<span class="lineNum">     300 </span><span class="lineCov">         46 :     parseFilenames(&quot;INITIAL_COEFFS&quot;,initial_coeffs_fnames);</span>
<span class="lineNum">     301 </span><span class="lineCov">         46 :     if(initial_coeffs_fnames.size()&gt;0){</span>
<span class="lineNum">     302 </span><span class="lineNoCov">          0 :       readCoeffsFromFiles(initial_coeffs_fnames,false);</span>
<span class="lineNum">     303 </span><span class="lineNoCov">          0 :       comm.Barrier();</span>
<span class="lineNum">     304 </span><span class="lineNoCov">          0 :       if(comm.Get_rank()==0 &amp;&amp; use_mwalkers_mpi_){</span>
<span class="lineNum">     305 </span><span class="lineNoCov">          0 :         multi_sim_comm.Barrier();</span>
<span class="lineNum">     306 </span>            :       }
<span class="lineNum">     307 </span><span class="lineNoCov">          0 :       setAllCoeffsSetIterationCounters();</span>
<span class="lineNum">     308 </span><span class="lineCov">         46 :     }</span>
<span class="lineNum">     309 </span>            :   }
<span class="lineNum">     310 </span>            :   //
<span class="lineNum">     311 </span>            : 
<span class="lineNum">     312 </span><span class="lineCov">         94 :   std::vector&lt;std::string&gt; coeffs_fnames;</span>
<span class="lineNum">     313 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;COEFFS_FILE&quot;)){</span>
<span class="lineNum">     314 </span><span class="lineCov">         46 :     parseFilenames(&quot;COEFFS_FILE&quot;,coeffs_fnames,&quot;coeffs.data&quot;);</span>
<span class="lineNum">     315 </span><span class="lineCov">         46 :     bool start_opt_afresh=false;</span>
<span class="lineNum">     316 </span><span class="lineCov">         46 :     if(keywords.exists(&quot;START_OPTIMIZATION_AFRESH&quot;)){</span>
<span class="lineNum">     317 </span><span class="lineCov">         43 :       parseFlag(&quot;START_OPTIMIZATION_AFRESH&quot;,start_opt_afresh);</span>
<span class="lineNum">     318 </span><span class="lineCov">         43 :       if(start_opt_afresh &amp;&amp; !getRestart()){</span>
<span class="lineNum">     319 </span><span class="lineNoCov">          0 :         plumed_merror(&quot;the START_OPTIMIZATION_AFRESH keyword should only be used when a restart has been triggered by the RESTART keyword or the MD code&quot;);</span>
<span class="lineNum">     320 </span>            :       }
<span class="lineNum">     321 </span>            :     }
<span class="lineNum">     322 </span><span class="lineCov">         46 :     if(getRestart()){</span>
<span class="lineNum">     323 </span><span class="lineCov">         14 :       for(unsigned int i=0; i&lt;coeffs_fnames.size(); i++){</span>
<span class="lineNum">     324 </span><span class="lineCov">          7 :         IFile ifile;</span>
<span class="lineNum">     325 </span><span class="lineCov">          7 :         ifile.link(*this);</span>
<span class="lineNum">     326 </span><span class="lineCov">          7 :         if(use_mwalkers_mpi_){ifile.enforceSuffix(&quot;&quot;);}</span>
<span class="lineNum">     327 </span><span class="lineCov">          7 :         bool file_exist = ifile.FileExist(coeffs_fnames[i]);</span>
<span class="lineNum">     328 </span><span class="lineCov">          7 :         if(!file_exist){</span>
<span class="lineNum">     329 </span><span class="lineNoCov">          0 :           std::string fname = FileBase::appendSuffix(coeffs_fnames[i],ifile.getSuffix());</span>
<span class="lineNum">     330 </span><span class="lineNoCov">          0 :           plumed_merror(&quot;Cannot find coefficient file &quot; + fname + &quot; when trying to restart an optimzation. If you don't want to restart the optimzation please remove the RESTART keyword or use the RESTART=NO within the &quot;+getName()+&quot; action to locally disable the restart.&quot;);</span>
<span class="lineNum">     331 </span>            :         }
<span class="lineNum">     332 </span><span class="lineCov">          7 :       }</span>
<span class="lineNum">     333 </span><span class="lineCov">          7 :       readCoeffsFromFiles(coeffs_fnames,true);</span>
<span class="lineNum">     334 </span><span class="lineCov">          7 :       comm.Barrier();</span>
<span class="lineNum">     335 </span><span class="lineCov">          7 :       if(comm.Get_rank()==0 &amp;&amp; use_mwalkers_mpi_){</span>
<span class="lineNum">     336 </span><span class="lineNoCov">          0 :         multi_sim_comm.Barrier();</span>
<span class="lineNum">     337 </span>            :       }
<span class="lineNum">     338 </span><span class="lineCov">          7 :       unsigned int iter_opt_tmp = coeffs_pntrs_[0]-&gt;getIterationCounter();</span>
<span class="lineNum">     339 </span><span class="lineCov">          7 :       for(unsigned int i=1; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     340 </span><span class="lineNoCov">          0 :         plumed_massert(coeffs_pntrs_[i]-&gt;getIterationCounter()==iter_opt_tmp,&quot;the iteraton counter should be the same for all files when restarting from previous coefficient files\n&quot;);</span>
<span class="lineNum">     341 </span>            :       }
<span class="lineNum">     342 </span><span class="lineCov">          7 :       if(start_opt_afresh){</span>
<span class="lineNum">     343 </span><span class="lineNoCov">          0 :         setIterationCounter(0);</span>
<span class="lineNum">     344 </span><span class="lineNoCov">          0 :         log.printf(&quot;  Optimization started afresh at iteration %u\n&quot;,getIterationCounter());</span>
<span class="lineNum">     345 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     346 </span><span class="lineNoCov">          0 :           AuxCoeffs(i).setValues( Coeffs(i) );</span>
<span class="lineNum">     347 </span>            :         }
<span class="lineNum">     348 </span>            :       }
<span class="lineNum">     349 </span>            :       else{
<span class="lineNum">     350 </span><span class="lineCov">          7 :         setIterationCounter(coeffs_pntrs_[0]-&gt;getIterationCounter());</span>
<span class="lineNum">     351 </span><span class="lineCov">          7 :         log.printf(&quot;  Optimization restarted at iteration %u\n&quot;,getIterationCounter());</span>
<span class="lineNum">     352 </span>            :       }
<span class="lineNum">     353 </span><span class="lineCov">          7 :       setAllCoeffsSetIterationCounters();</span>
<span class="lineNum">     354 </span>            :     }
<span class="lineNum">     355 </span>            : 
<span class="lineNum">     356 </span><span class="lineCov">         46 :     std::string coeffs_wstride_tmpstr=&quot;&quot;;</span>
<span class="lineNum">     357 </span><span class="lineCov">         46 :     parse(&quot;COEFFS_OUTPUT&quot;,coeffs_wstride_tmpstr);</span>
<span class="lineNum">     358 </span><span class="lineCov">         46 :     if(coeffs_wstride_tmpstr!=&quot;OFF&quot; &amp;&amp; coeffs_wstride_tmpstr.size()&gt;0){</span>
<span class="lineNum">     359 </span><span class="lineCov">         46 :       Tools::convert(coeffs_wstride_tmpstr,coeffs_wstride_);</span>
<span class="lineNum">     360 </span>            :     }
<span class="lineNum">     361 </span><span class="lineCov">         46 :     if(coeffs_wstride_tmpstr==&quot;OFF&quot;){</span>
<span class="lineNum">     362 </span><span class="lineNoCov">          0 :       coeffs_fnames.clear();</span>
<span class="lineNum">     363 </span>            :     }
<span class="lineNum">     364 </span><span class="lineCov">         46 :     setupOFiles(coeffs_fnames,coeffsOFiles_,mw_single_files);</span>
<span class="lineNum">     365 </span><span class="lineCov">         46 :     parse(&quot;COEFFS_FMT&quot;,coeffs_output_fmt_);</span>
<span class="lineNum">     366 </span><span class="lineCov">         46 :     if(coeffs_output_fmt_.size()&gt;0){</span>
<span class="lineNum">     367 </span><span class="lineCov">         92 :       for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     368 </span><span class="lineCov">         46 :         coeffs_pntrs_[i]-&gt;setOutputFmt(coeffs_output_fmt_);</span>
<span class="lineNum">     369 </span>            :       }
<span class="lineNum">     370 </span>            :     }
<span class="lineNum">     371 </span><span class="lineCov">         46 :     if(!getRestart()){</span>
<span class="lineNum">     372 </span><span class="lineCov">         78 :       for(unsigned int i=0; i&lt;coeffsOFiles_.size();i++){</span>
<span class="lineNum">     373 </span><span class="lineCov">         39 :         coeffs_pntrs_[i]-&gt;writeToFile(*coeffsOFiles_[i],aux_coeffs_pntrs_[i],false);</span>
<span class="lineNum">     374 </span>            :       }
<span class="lineNum">     375 </span>            :     }
<span class="lineNum">     376 </span><span class="lineCov">         46 :     if(coeffs_fnames.size()&gt;0){</span>
<span class="lineNum">     377 </span><span class="lineCov">         46 :       if(ncoeffssets_==1){</span>
<span class="lineNum">     378 </span><span class="lineCov">         46 :         log.printf(&quot;  Coefficients will be written out to file %s every %u iterations\n&quot;,coeffsOFiles_[0]-&gt;getPath().c_str(),coeffs_wstride_);</span>
<span class="lineNum">     379 </span>            :       }
<span class="lineNum">     380 </span>            :       else {
<span class="lineNum">     381 </span><span class="lineNoCov">          0 :         log.printf(&quot;  Coefficients will be written out to the following files every %u iterations:\n&quot;,coeffs_wstride_);</span>
<span class="lineNum">     382 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;coeffs_fnames.size(); i++){</span>
<span class="lineNum">     383 </span><span class="lineNoCov">          0 :           log.printf(&quot;   coefficient set %u: %s\n&quot;,i,coeffsOFiles_[i]-&gt;getPath().c_str());</span>
<span class="lineNum">     384 </span>            :         }
<span class="lineNum">     385 </span>            :       }
<span class="lineNum">     386 </span>            :     }
<span class="lineNum">     387 </span>            :     else {
<span class="lineNum">     388 </span><span class="lineNoCov">          0 :       log.printf(&quot;  Output of coefficients to file has been disabled\n&quot;);</span>
<span class="lineNum">     389 </span><span class="lineCov">         46 :     }</span>
<span class="lineNum">     390 </span>            :   }
<span class="lineNum">     391 </span>            : 
<span class="lineNum">     392 </span><span class="lineCov">         94 :   std::vector&lt;std::string&gt; gradient_fnames;</span>
<span class="lineNum">     393 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;GRADIENT_FILE&quot;)){</span>
<span class="lineNum">     394 </span><span class="lineCov">         46 :     parseFilenames(&quot;GRADIENT_FILE&quot;,gradient_fnames);</span>
<span class="lineNum">     395 </span><span class="lineCov">         46 :     parse(&quot;GRADIENT_OUTPUT&quot;,gradient_wstride_);</span>
<span class="lineNum">     396 </span>            : 
<span class="lineNum">     397 </span><span class="lineCov">         46 :     if(coeffs_fnames.size()&gt;0){</span>
<span class="lineNum">     398 </span><span class="lineCov">         85 :       for(unsigned int i=0; i&lt;gradient_fnames.size(); i++){</span>
<span class="lineNum">     399 </span><span class="lineCov">         39 :         plumed_massert(gradient_fnames[i]!=coeffs_fnames[i],&quot;COEFFS_FILE and GRADIENT_FILE cannot be the same&quot;);</span>
<span class="lineNum">     400 </span>            :       }
<span class="lineNum">     401 </span>            :     }
<span class="lineNum">     402 </span><span class="lineCov">         46 :     setupOFiles(gradient_fnames,gradientOFiles_,mw_single_files);</span>
<span class="lineNum">     403 </span><span class="lineCov">         46 :     parse(&quot;GRADIENT_FMT&quot;,gradient_output_fmt_);</span>
<span class="lineNum">     404 </span><span class="lineCov">         46 :     if(gradient_output_fmt_.size()&gt;0){</span>
<span class="lineNum">     405 </span><span class="lineCov">         78 :       for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     406 </span><span class="lineCov">         39 :         gradient_pntrs_[i]-&gt;setOutputFmt(gradient_output_fmt_);</span>
<span class="lineNum">     407 </span>            :       }
<span class="lineNum">     408 </span>            :     }
<span class="lineNum">     409 </span>            : 
<span class="lineNum">     410 </span><span class="lineCov">         46 :     if(gradient_fnames.size()&gt;0){</span>
<span class="lineNum">     411 </span><span class="lineCov">         39 :       if(ncoeffssets_==1){</span>
<span class="lineNum">     412 </span><span class="lineCov">         39 :         log.printf(&quot;  Gradient will be written out to file %s every %u iterations\n&quot;,gradientOFiles_[0]-&gt;getPath().c_str(),gradient_wstride_);</span>
<span class="lineNum">     413 </span>            :       }
<span class="lineNum">     414 </span>            :       else {
<span class="lineNum">     415 </span><span class="lineNoCov">          0 :         log.printf(&quot;  Gradient will be written out to the following files every %u iterations:\n&quot;,gradient_wstride_);</span>
<span class="lineNum">     416 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;gradient_fnames.size(); i++){</span>
<span class="lineNum">     417 </span><span class="lineNoCov">          0 :           log.printf(&quot;   coefficient set %u: %s\n&quot;,i,gradientOFiles_[i]-&gt;getPath().c_str());</span>
<span class="lineNum">     418 </span>            :         }
<span class="lineNum">     419 </span>            :       }
<span class="lineNum">     420 </span>            :     }
<span class="lineNum">     421 </span>            :   }
<span class="lineNum">     422 </span>            : 
<span class="lineNum">     423 </span><span class="lineCov">         94 :   std::vector&lt;std::string&gt; hessian_fnames;</span>
<span class="lineNum">     424 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;HESSIAN_FILE&quot;)){</span>
<span class="lineNum">     425 </span><span class="lineCov">         41 :     parseFilenames(&quot;HESSIAN_FILE&quot;,hessian_fnames);</span>
<span class="lineNum">     426 </span><span class="lineCov">         41 :     parse(&quot;HESSIAN_OUTPUT&quot;,hessian_wstride_);</span>
<span class="lineNum">     427 </span>            : 
<span class="lineNum">     428 </span><span class="lineCov">         41 :     if(coeffs_fnames.size()&gt;0){</span>
<span class="lineNum">     429 </span><span class="lineCov">         77 :       for(unsigned int i=0; i&lt;hessian_fnames.size(); i++){</span>
<span class="lineNum">     430 </span><span class="lineCov">         36 :         plumed_massert(hessian_fnames[i]!=coeffs_fnames[i],&quot;COEFFS_FILE and HESSIAN_FILE cannot be the same&quot;);</span>
<span class="lineNum">     431 </span>            :       }
<span class="lineNum">     432 </span>            :     }
<span class="lineNum">     433 </span><span class="lineCov">         41 :     if(gradient_fnames.size()&gt;0){</span>
<span class="lineNum">     434 </span><span class="lineCov">         72 :       for(unsigned int i=0; i&lt;hessian_fnames.size(); i++){</span>
<span class="lineNum">     435 </span><span class="lineCov">         36 :         plumed_massert(hessian_fnames[i]!=gradient_fnames[i],&quot;GRADIENT_FILE and HESSIAN_FILE cannot be the same&quot;);</span>
<span class="lineNum">     436 </span>            :       }
<span class="lineNum">     437 </span>            :     }
<span class="lineNum">     438 </span><span class="lineCov">         41 :     setupOFiles(hessian_fnames,hessianOFiles_,mw_single_files);</span>
<span class="lineNum">     439 </span><span class="lineCov">         41 :     parse(&quot;HESSIAN_FMT&quot;,hessian_output_fmt_);</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span><span class="lineCov">         41 :     if(hessian_fnames.size()&gt;0){</span>
<span class="lineNum">     442 </span><span class="lineCov">         36 :       if(ncoeffssets_==1){</span>
<span class="lineNum">     443 </span><span class="lineCov">         36 :         log.printf(&quot;  Hessian will be written out to file %s every %u iterations\n&quot;,hessianOFiles_[0]-&gt;getPath().c_str(),hessian_wstride_);</span>
<span class="lineNum">     444 </span>            :       }
<span class="lineNum">     445 </span>            :       else {
<span class="lineNum">     446 </span><span class="lineNoCov">          0 :         log.printf(&quot;  Hessian will be written out to the following files every %u iterations:\n&quot;,hessian_wstride_);</span>
<span class="lineNum">     447 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;hessian_fnames.size(); i++){</span>
<span class="lineNum">     448 </span><span class="lineNoCov">          0 :           log.printf(&quot;   coefficient set %u: %s\n&quot;,i,hessianOFiles_[i]-&gt;getPath().c_str());</span>
<span class="lineNum">     449 </span>            :         }
<span class="lineNum">     450 </span>            :       }
<span class="lineNum">     451 </span>            :     }
<span class="lineNum">     452 </span>            :   }
<span class="lineNum">     453 </span>            : 
<span class="lineNum">     454 </span>            : 
<span class="lineNum">     455 </span>            :   //
<span class="lineNum">     456 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;MASK_FILE&quot;)){</span>
<span class="lineNum">     457 </span><span class="lineCov">         45 :     std::vector&lt;std::string&gt; mask_fnames_in;</span>
<span class="lineNum">     458 </span><span class="lineCov">         45 :     parseVector(&quot;MASK_FILE&quot;,mask_fnames_in);</span>
<span class="lineNum">     459 </span><span class="lineCov">         45 :     if(mask_fnames_in.size()==1 &amp;&amp; ncoeffssets_&gt;1){</span>
<span class="lineNum">     460 </span><span class="lineNoCov">          0 :       if(identical_coeffs_shape_){mask_fnames_in.resize(ncoeffssets_,mask_fnames_in[0]);}</span>
<span class="lineNum">     461 </span><span class="lineNoCov">          0 :       else{plumed_merror(&quot;the coefficients indices shape differs between biases so you need to give a separate file for each coefficient set\n&quot;);}</span>
<span class="lineNum">     462 </span>            :     }
<span class="lineNum">     463 </span><span class="lineCov">         45 :     if(mask_fnames_in.size()&gt;0 &amp;&amp; mask_fnames_in.size()!=ncoeffssets_){</span>
<span class="lineNum">     464 </span><span class="lineNoCov">          0 :       plumed_merror(&quot;Error in MASK_FILE keyword: either give one value for all biases or a separate value for each coefficient set&quot;);</span>
<span class="lineNum">     465 </span>            :     }
<span class="lineNum">     466 </span>            : 
<span class="lineNum">     467 </span><span class="lineCov">         45 :     coeffs_mask_pntrs_.resize(ncoeffssets_);</span>
<span class="lineNum">     468 </span><span class="lineCov">         90 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     469 </span><span class="lineCov">         45 :       coeffs_mask_pntrs_[i] = new CoeffsVector(*coeffs_pntrs_[i]);</span>
<span class="lineNum">     470 </span><span class="lineCov">         45 :       coeffs_mask_pntrs_[i]-&gt;setLabels(&quot;mask&quot;);</span>
<span class="lineNum">     471 </span><span class="lineCov">         45 :       coeffs_mask_pntrs_[i]-&gt;setValues(1.0);</span>
<span class="lineNum">     472 </span><span class="lineCov">         45 :       coeffs_mask_pntrs_[i]-&gt;setOutputFmt(&quot;%f&quot;);</span>
<span class="lineNum">     473 </span>            :     }
<span class="lineNum">     474 </span>            : 
<span class="lineNum">     475 </span><span class="lineCov">         45 :     if(mask_fnames_in.size()&gt;0){</span>
<span class="lineNum">     476 </span><span class="lineCov">          3 :       if(ncoeffssets_==1){</span>
<span class="lineNum">     477 </span><span class="lineCov">          3 :         size_t nread = coeffs_mask_pntrs_[0]-&gt;readFromFile(mask_fnames_in[0],true,true);</span>
<span class="lineNum">     478 </span><span class="lineCov">          3 :         log.printf(&quot;  read %zu values from mask file %s\n&quot;,nread,mask_fnames_in[0].c_str());</span>
<span class="lineNum">     479 </span><span class="lineCov">          3 :         size_t ndeactived = coeffs_mask_pntrs_[0]-&gt;countValues(0.0);</span>
<span class="lineNum">     480 </span><span class="lineCov">          3 :         log.printf(&quot;  deactived optimization of %zu coefficients\n&quot;,ndeactived);</span>
<span class="lineNum">     481 </span>            :       }
<span class="lineNum">     482 </span>            :       else{
<span class="lineNum">     483 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     484 </span><span class="lineNoCov">          0 :           size_t nread = coeffs_mask_pntrs_[i]-&gt;readFromFile(mask_fnames_in[i],true,true);</span>
<span class="lineNum">     485 </span><span class="lineNoCov">          0 :           log.printf(&quot;  mask for coefficent set %u:\n&quot;,i);</span>
<span class="lineNum">     486 </span><span class="lineNoCov">          0 :           log.printf(&quot;   read %zu values from file %s\n&quot;,nread,mask_fnames_in[i].c_str());</span>
<span class="lineNum">     487 </span><span class="lineNoCov">          0 :           size_t ndeactived = coeffs_mask_pntrs_[0]-&gt;countValues(0.0);</span>
<span class="lineNum">     488 </span><span class="lineNoCov">          0 :           log.printf(&quot;   deactived optimization of %zu coefficients\n&quot;,ndeactived);</span>
<span class="lineNum">     489 </span>            :         }
<span class="lineNum">     490 </span>            :       }
<span class="lineNum">     491 </span>            :     }
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineCov">         90 :     std::vector&lt;std::string&gt; mask_fnames_out;</span>
<span class="lineNum">     494 </span><span class="lineCov">         45 :     parseFilenames(&quot;OUTPUT_MASK_FILE&quot;,mask_fnames_out);</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">         48 :     for(unsigned int i=0; i&lt;mask_fnames_out.size(); i++){</span>
<span class="lineNum">     497 </span><span class="lineCov">          3 :       if(mask_fnames_in.size()&gt;0){</span>
<span class="lineNum">     498 </span><span class="lineCov">          3 :         plumed_massert(mask_fnames_out[i]!=mask_fnames_in[i],&quot;MASK_FILE and OUTPUT_MASK_FILE cannot be the same&quot;);</span>
<span class="lineNum">     499 </span>            :       }
<span class="lineNum">     500 </span><span class="lineCov">          3 :       OFile maskOFile;</span>
<span class="lineNum">     501 </span><span class="lineCov">          3 :       maskOFile.link(*this);</span>
<span class="lineNum">     502 </span><span class="lineCov">          3 :       maskOFile.enforceBackup();</span>
<span class="lineNum">     503 </span><span class="lineCov">          3 :       if(use_mwalkers_mpi_ &amp;&amp; mwalkers_mpi_single_files_){</span>
<span class="lineNum">     504 </span><span class="lineNoCov">          0 :         unsigned int r=0;</span>
<span class="lineNum">     505 </span><span class="lineNoCov">          0 :         if(comm.Get_rank()==0){r=multi_sim_comm.Get_rank();}</span>
<span class="lineNum">     506 </span><span class="lineNoCov">          0 :         comm.Bcast(r,0);</span>
<span class="lineNum">     507 </span><span class="lineNoCov">          0 :         if(r&gt;0){mask_fnames_out[i]=&quot;/dev/null&quot;;}</span>
<span class="lineNum">     508 </span><span class="lineNoCov">          0 :         maskOFile.enforceSuffix(&quot;&quot;);</span>
<span class="lineNum">     509 </span>            :       }
<span class="lineNum">     510 </span><span class="lineCov">          3 :       maskOFile.open(mask_fnames_out[i]);</span>
<span class="lineNum">     511 </span><span class="lineCov">          3 :       coeffs_mask_pntrs_[i]-&gt;writeToFile(maskOFile,true);</span>
<span class="lineNum">     512 </span><span class="lineCov">          3 :       maskOFile.close();</span>
<span class="lineNum">     513 </span><span class="lineCov">         48 :     }</span>
<span class="lineNum">     514 </span>            :   }
<span class="lineNum">     515 </span>            : 
<span class="lineNum">     516 </span><span class="lineCov">         47 :   if(getRestart() &amp;&amp; ustride_targetdist_&gt;0){</span>
<span class="lineNum">     517 </span><span class="lineCov">         12 :     for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     518 </span><span class="lineCov">          6 :       if(dynamic_targetdists_[i]){</span>
<span class="lineNum">     519 </span><span class="lineCov">          6 :         bias_pntrs_[i]-&gt;restartTargetDistributions();</span>
<span class="lineNum">     520 </span>            :       }
<span class="lineNum">     521 </span>            :     }
<span class="lineNum">     522 </span>            :   }
<span class="lineNum">     523 </span>            : 
<span class="lineNum">     524 </span>            : 
<span class="lineNum">     525 </span><span class="lineCov">         94 :   std::vector&lt;std::string&gt; targetdist_averages_fnames;</span>
<span class="lineNum">     526 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;TARGETDIST_AVERAGES_FILE&quot;)){</span>
<span class="lineNum">     527 </span><span class="lineCov">         46 :     parseFilenames(&quot;TARGETDIST_AVERAGES_FILE&quot;,targetdist_averages_fnames,&quot;targetdist-averages.data&quot;);</span>
<span class="lineNum">     528 </span><span class="lineCov">         46 :     parse(&quot;TARGETDIST_AVERAGES_OUTPUT&quot;,targetdist_averages_wstride_);</span>
<span class="lineNum">     529 </span>            : 
<span class="lineNum">     530 </span><span class="lineCov">         46 :     if(coeffs_fnames.size()&gt;0){</span>
<span class="lineNum">     531 </span><span class="lineCov">         92 :       for(unsigned int i=0; i&lt;targetdist_averages_fnames.size(); i++){</span>
<span class="lineNum">     532 </span><span class="lineCov">         46 :         plumed_massert(targetdist_averages_fnames[i]!=coeffs_fnames[i],&quot;COEFFS_FILE and TARGETDIST_AVERAGES_FILE cannot be the same&quot;);</span>
<span class="lineNum">     533 </span>            :       }
<span class="lineNum">     534 </span>            :     }
<span class="lineNum">     535 </span><span class="lineCov">         46 :     if(gradient_fnames.size()&gt;0){</span>
<span class="lineNum">     536 </span><span class="lineCov">         78 :       for(unsigned int i=0; i&lt;targetdist_averages_fnames.size(); i++){</span>
<span class="lineNum">     537 </span><span class="lineCov">         39 :         plumed_massert(targetdist_averages_fnames[i]!=gradient_fnames[i],&quot;GRADIENT_FILE and TARGETDIST_AVERAGES_FILE cannot be the same&quot;);</span>
<span class="lineNum">     538 </span>            :       }
<span class="lineNum">     539 </span>            :     }
<span class="lineNum">     540 </span><span class="lineCov">         46 :     if(hessian_fnames.size()&gt;0){</span>
<span class="lineNum">     541 </span><span class="lineCov">         72 :       for(unsigned int i=0; i&lt;targetdist_averages_fnames.size(); i++){</span>
<span class="lineNum">     542 </span><span class="lineCov">         36 :         plumed_massert(targetdist_averages_fnames[i]!=hessian_fnames[i],&quot;HESSIAN_FILE and TARGETDIST_AVERAGES_FILE cannot be the same&quot;);</span>
<span class="lineNum">     543 </span>            :       }
<span class="lineNum">     544 </span>            :     }
<span class="lineNum">     545 </span><span class="lineCov">         46 :     setupOFiles(targetdist_averages_fnames,targetdist_averagesOFiles_,mw_single_files);</span>
<span class="lineNum">     546 </span><span class="lineCov">         46 :     parse(&quot;TARGETDIST_AVERAGES_FMT&quot;,targetdist_averages_output_fmt_);</span>
<span class="lineNum">     547 </span><span class="lineCov">         46 :     if(targetdist_averages_output_fmt_.size()&gt;0){</span>
<span class="lineNum">     548 </span><span class="lineCov">         92 :       for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     549 </span><span class="lineCov">         46 :         targetdist_averages_pntrs_[i]-&gt;setOutputFmt(targetdist_averages_output_fmt_);</span>
<span class="lineNum">     550 </span>            :       }
<span class="lineNum">     551 </span>            :     }
<span class="lineNum">     552 </span>            : 
<span class="lineNum">     553 </span><span class="lineCov">         92 :     for(unsigned int i=0; i&lt;targetdist_averagesOFiles_.size(); i++){</span>
<span class="lineNum">     554 </span><span class="lineCov">         46 :       targetdist_averages_pntrs_[i]-&gt;writeToFile(*targetdist_averagesOFiles_[i]);</span>
<span class="lineNum">     555 </span>            :     }
<span class="lineNum">     556 </span>            : 
<span class="lineNum">     557 </span><span class="lineCov">         46 :     if(targetdist_averages_wstride_==0){</span>
<span class="lineNum">     558 </span><span class="lineCov">         40 :       for(unsigned int i=0; i&lt;targetdist_averagesOFiles_.size(); i++){</span>
<span class="lineNum">     559 </span><span class="lineCov">         20 :         targetdist_averagesOFiles_[i]-&gt;close();</span>
<span class="lineNum">     560 </span><span class="lineCov">         20 :         delete targetdist_averagesOFiles_[i];</span>
<span class="lineNum">     561 </span>            :       }
<span class="lineNum">     562 </span><span class="lineCov">         20 :       targetdist_averagesOFiles_.clear();</span>
<span class="lineNum">     563 </span>            :     }
<span class="lineNum">     564 </span>            : 
<span class="lineNum">     565 </span><span class="lineCov">         46 :     if(targetdist_averages_fnames.size()&gt;0 &amp;&amp; targetdist_averages_wstride_ &gt; 0){</span>
<span class="lineNum">     566 </span><span class="lineCov">         26 :       if(ncoeffssets_==1){</span>
<span class="lineNum">     567 </span><span class="lineCov">         26 :         log.printf(&quot;  Target distribution averages will be written out to file %s every %u iterations\n&quot;,targetdist_averagesOFiles_[0]-&gt;getPath().c_str(),targetdist_averages_wstride_);</span>
<span class="lineNum">     568 </span>            :       }
<span class="lineNum">     569 </span>            :       else {
<span class="lineNum">     570 </span><span class="lineNoCov">          0 :         log.printf(&quot;  Target distribution averages will be written out to the following files every %u iterations:\n&quot;,targetdist_averages_wstride_);</span>
<span class="lineNum">     571 </span><span class="lineNoCov">          0 :         for(unsigned int i=0; i&lt;targetdist_averages_fnames.size(); i++){</span>
<span class="lineNum">     572 </span><span class="lineNoCov">          0 :           log.printf(&quot;   coefficient set %u: %s\n&quot;,i,targetdist_averagesOFiles_[i]-&gt;getPath().c_str());</span>
<span class="lineNum">     573 </span>            :         }
<span class="lineNum">     574 </span>            :       }
<span class="lineNum">     575 </span>            :     }
<span class="lineNum">     576 </span>            :   }
<span class="lineNum">     577 </span>            : 
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;BIAS_OUTPUT&quot;)){</span>
<span class="lineNum">     580 </span><span class="lineCov">         47 :     parse(&quot;BIAS_OUTPUT&quot;,bias_output_stride_);</span>
<span class="lineNum">     581 </span><span class="lineCov">         47 :     if(bias_output_stride_&gt;0){</span>
<span class="lineNum">     582 </span><span class="lineCov">         47 :       bias_output_active_=true;</span>
<span class="lineNum">     583 </span><span class="lineCov">         94 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     584 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;enableBiasFileOutput();</span>
<span class="lineNum">     585 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;setupBiasFileOutput();</span>
<span class="lineNum">     586 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;writeBiasToFile();</span>
<span class="lineNum">     587 </span>            :       }
<span class="lineNum">     588 </span>            :     }
<span class="lineNum">     589 </span>            :     else{
<span class="lineNum">     590 </span><span class="lineNoCov">          0 :       bias_output_active_=false;</span>
<span class="lineNum">     591 </span><span class="lineNoCov">          0 :       bias_output_stride_=1000;</span>
<span class="lineNum">     592 </span>            :     }
<span class="lineNum">     593 </span>            :   }
<span class="lineNum">     594 </span>            : 
<span class="lineNum">     595 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;FES_OUTPUT&quot;)){</span>
<span class="lineNum">     596 </span><span class="lineCov">         47 :     parse(&quot;FES_OUTPUT&quot;,fes_output_stride_);</span>
<span class="lineNum">     597 </span><span class="lineCov">         47 :     if(fes_output_stride_&gt;0){</span>
<span class="lineNum">     598 </span><span class="lineCov">         47 :       fes_output_active_=true;</span>
<span class="lineNum">     599 </span><span class="lineCov">         94 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     600 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;enableFesFileOutput();</span>
<span class="lineNum">     601 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;setupFesFileOutput();</span>
<span class="lineNum">     602 </span><span class="lineCov">         47 :         bias_pntrs_[i]-&gt;writeFesToFile();</span>
<span class="lineNum">     603 </span>            :       }
<span class="lineNum">     604 </span>            :     }
<span class="lineNum">     605 </span>            :     else{
<span class="lineNum">     606 </span><span class="lineNoCov">          0 :       fes_output_active_=false;</span>
<span class="lineNum">     607 </span><span class="lineNoCov">          0 :       fes_output_stride_=1000;</span>
<span class="lineNum">     608 </span>            :     }
<span class="lineNum">     609 </span>            :   }
<span class="lineNum">     610 </span>            : 
<span class="lineNum">     611 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;FES_PROJ_OUTPUT&quot;)){</span>
<span class="lineNum">     612 </span><span class="lineCov">         47 :     parse(&quot;FES_PROJ_OUTPUT&quot;,fesproj_output_stride_);</span>
<span class="lineNum">     613 </span><span class="lineCov">         47 :     if(fesproj_output_stride_&gt;0){</span>
<span class="lineNum">     614 </span><span class="lineCov">          8 :       fesproj_output_active_=true;</span>
<span class="lineNum">     615 </span><span class="lineCov">         16 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     616 </span><span class="lineCov">          8 :         bias_pntrs_[i]-&gt;enableFesProjFileOutput();</span>
<span class="lineNum">     617 </span><span class="lineCov">          8 :         bias_pntrs_[i]-&gt;setupFesProjFileOutput();</span>
<span class="lineNum">     618 </span><span class="lineCov">          8 :         bias_pntrs_[i]-&gt;writeFesProjToFile();</span>
<span class="lineNum">     619 </span>            :       }
<span class="lineNum">     620 </span>            :     }
<span class="lineNum">     621 </span>            :     else{
<span class="lineNum">     622 </span><span class="lineCov">         39 :       fesproj_output_active_=false;</span>
<span class="lineNum">     623 </span><span class="lineCov">         39 :       fesproj_output_stride_=1000;</span>
<span class="lineNum">     624 </span>            :     }
<span class="lineNum">     625 </span>            :   }
<span class="lineNum">     626 </span>            : 
<span class="lineNum">     627 </span><span class="lineCov">         94 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     628 </span><span class="lineCov">         47 :     if(!dynamic_targetdists_[i] &amp;&amp; bias_pntrs_[i]-&gt;isStaticTargetDistFileOutputActive()){</span>
<span class="lineNum">     629 </span><span class="lineCov">         21 :       bias_pntrs_[i]-&gt;setupTargetDistFileOutput();</span>
<span class="lineNum">     630 </span><span class="lineCov">         21 :       bias_pntrs_[i]-&gt;writeTargetDistToFile();</span>
<span class="lineNum">     631 </span><span class="lineCov">         21 :       bias_pntrs_[i]-&gt;setupTargetDistProjFileOutput();</span>
<span class="lineNum">     632 </span><span class="lineCov">         21 :       bias_pntrs_[i]-&gt;writeTargetDistProjToFile();</span>
<span class="lineNum">     633 </span>            :     }
<span class="lineNum">     634 </span>            :   }
<span class="lineNum">     635 </span>            : 
<span class="lineNum">     636 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;TARGETDIST_OUTPUT&quot;)){</span>
<span class="lineNum">     637 </span><span class="lineCov">         43 :     parse(&quot;TARGETDIST_OUTPUT&quot;,targetdist_output_stride_);</span>
<span class="lineNum">     638 </span><span class="lineCov">         43 :     if(targetdist_output_stride_&gt;0){</span>
<span class="lineNum">     639 </span><span class="lineCov">         26 :       if(ustride_targetdist_==0){</span>
<span class="lineNum">     640 </span><span class="lineNoCov">          0 :         plumed_merror(&quot;it doesn't make sense to use the TARGETDIST_OUTPUT keyword if you don't have a target distribution that needs to be updated&quot;);</span>
<span class="lineNum">     641 </span>            :       }
<span class="lineNum">     642 </span><span class="lineCov">         26 :       if(targetdist_output_stride_%ustride_targetdist_!=0){</span>
<span class="lineNum">     643 </span><span class="lineNoCov">          0 :         plumed_merror(&quot;the value given in TARGETDIST_OUTPUT doesn't make sense, it should be multiple of TARGETDIST_STRIDE&quot;);</span>
<span class="lineNum">     644 </span>            :       }
<span class="lineNum">     645 </span>            : 
<span class="lineNum">     646 </span><span class="lineCov">         26 :       targetdist_output_active_=true;</span>
<span class="lineNum">     647 </span><span class="lineCov">         52 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     648 </span><span class="lineCov">         26 :         if(dynamic_targetdists_[i]){</span>
<span class="lineNum">     649 </span><span class="lineCov">         26 :           bias_pntrs_[i]-&gt;enableDynamicTargetDistFileOutput();</span>
<span class="lineNum">     650 </span><span class="lineCov">         26 :           bias_pntrs_[i]-&gt;setupTargetDistFileOutput();</span>
<span class="lineNum">     651 </span><span class="lineCov">         26 :           bias_pntrs_[i]-&gt;writeTargetDistToFile();</span>
<span class="lineNum">     652 </span>            :         }
<span class="lineNum">     653 </span>            :       }
<span class="lineNum">     654 </span>            :     }
<span class="lineNum">     655 </span>            :     else{
<span class="lineNum">     656 </span><span class="lineCov">         17 :       targetdist_output_active_=false;</span>
<span class="lineNum">     657 </span><span class="lineCov">         17 :       targetdist_output_stride_=1000;</span>
<span class="lineNum">     658 </span>            :     }
<span class="lineNum">     659 </span>            :   }
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineCov">         47 :   if(keywords.exists(&quot;TARGETDIST_PROJ_OUTPUT&quot;)){</span>
<span class="lineNum">     662 </span><span class="lineCov">         43 :     parse(&quot;TARGETDIST_PROJ_OUTPUT&quot;,targetdist_proj_output_stride_);</span>
<span class="lineNum">     663 </span><span class="lineCov">         43 :     if(targetdist_proj_output_stride_&gt;0){</span>
<span class="lineNum">     664 </span><span class="lineCov">          2 :       if(ustride_targetdist_==0){</span>
<span class="lineNum">     665 </span><span class="lineNoCov">          0 :         plumed_merror(&quot;it doesn't make sense to use the TARGETDIST_PROJ_OUTPUT keyword if you don't have a target distribution that needs to be updated&quot;);</span>
<span class="lineNum">     666 </span>            :       }
<span class="lineNum">     667 </span><span class="lineCov">          2 :       if(targetdist_proj_output_stride_%ustride_targetdist_!=0){</span>
<span class="lineNum">     668 </span><span class="lineNoCov">          0 :         plumed_merror(&quot;the value given in TARGETDIST_PROJ_OUTPUT doesn't make sense, it should be multiple of TARGETDIST_STRIDE&quot;);</span>
<span class="lineNum">     669 </span>            :       }
<span class="lineNum">     670 </span>            : 
<span class="lineNum">     671 </span><span class="lineCov">          2 :       targetdist_proj_output_active_=true;</span>
<span class="lineNum">     672 </span><span class="lineCov">          4 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     673 </span><span class="lineCov">          2 :         if(dynamic_targetdists_[i]){</span>
<span class="lineNum">     674 </span><span class="lineCov">          2 :           bias_pntrs_[i]-&gt;enableDynamicTargetDistFileOutput();</span>
<span class="lineNum">     675 </span><span class="lineCov">          2 :           bias_pntrs_[i]-&gt;setupTargetDistProjFileOutput();</span>
<span class="lineNum">     676 </span><span class="lineCov">          2 :           bias_pntrs_[i]-&gt;writeTargetDistProjToFile();</span>
<span class="lineNum">     677 </span>            :         }
<span class="lineNum">     678 </span>            :       }
<span class="lineNum">     679 </span>            :     }
<span class="lineNum">     680 </span>            :     else{
<span class="lineNum">     681 </span><span class="lineCov">         41 :       targetdist_proj_output_active_=false;</span>
<span class="lineNum">     682 </span><span class="lineCov">         41 :       targetdist_proj_output_stride_=1000;</span>
<span class="lineNum">     683 </span>            :     }
<span class="lineNum">     684 </span>            :   }
<span class="lineNum">     685 </span>            : 
<span class="lineNum">     686 </span><span class="lineCov">         47 :   if(ncoeffssets_==1){</span>
<span class="lineNum">     687 </span><span class="lineCov">         47 :     log.printf(&quot;  Output Components:\n&quot;);</span>
<span class="lineNum">     688 </span><span class="lineCov">         47 :     log.printf(&quot; &quot;);</span>
<span class="lineNum">     689 </span><span class="lineCov">         47 :     addComponent(&quot;gradrms&quot;); componentIsNotPeriodic(&quot;gradrms&quot;);</span>
<span class="lineNum">     690 </span><span class="lineCov">         47 :     log.printf(&quot; &quot;);</span>
<span class="lineNum">     691 </span><span class="lineCov">         47 :     addComponent(&quot;gradmax&quot;); componentIsNotPeriodic(&quot;gradmax&quot;);</span>
<span class="lineNum">     692 </span><span class="lineCov">         47 :     if(aver_gradient_pntrs_.size()&gt;0){</span>
<span class="lineNum">     693 </span><span class="lineNoCov">          0 :       log.printf(&quot; &quot;);</span>
<span class="lineNum">     694 </span><span class="lineNoCov">          0 :       addComponent(&quot;avergradrms&quot;); componentIsNotPeriodic(&quot;avergradrms&quot;);</span>
<span class="lineNum">     695 </span><span class="lineNoCov">          0 :       log.printf(&quot; &quot;);</span>
<span class="lineNum">     696 </span><span class="lineNoCov">          0 :       addComponent(&quot;avergradmax&quot;); componentIsNotPeriodic(&quot;avergradmax&quot;);</span>
<span class="lineNum">     697 </span>            :     }
<span class="lineNum">     698 </span><span class="lineCov">         47 :     if(!fixed_stepsize_){</span>
<span class="lineNum">     699 </span><span class="lineCov">          3 :       log.printf(&quot; &quot;);</span>
<span class="lineNum">     700 </span><span class="lineCov">          3 :       addComponent(&quot;stepsize&quot;); componentIsNotPeriodic(&quot;stepsize&quot;);</span>
<span class="lineNum">     701 </span><span class="lineCov">          3 :       getPntrToComponent(&quot;stepsize&quot;)-&gt;set( getCurrentStepSize(0) );</span>
<span class="lineNum">     702 </span>            :     }
<span class="lineNum">     703 </span>            :   }
<span class="lineNum">     704 </span>            :   else {
<span class="lineNum">     705 </span><span class="lineNoCov">          0 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     706 </span><span class="lineNoCov">          0 :       log.printf(&quot;  Output Components for coefficent set %u:\n&quot;,i);</span>
<span class="lineNum">     707 </span><span class="lineNoCov">          0 :       std::string is=&quot;&quot;; Tools::convert(i,is); is = &quot;_&quot; + coeffssetid_prefix_ + is;</span>
<span class="lineNum">     708 </span><span class="lineNoCov">          0 :       log.printf(&quot; &quot;);</span>
<span class="lineNum">     709 </span><span class="lineNoCov">          0 :       addComponent(&quot;gradrms&quot;+is); componentIsNotPeriodic(&quot;gradrms&quot;+is);</span>
<span class="lineNum">     710 </span><span class="lineNoCov">          0 :       log.printf(&quot; &quot;);</span>
<span class="lineNum">     711 </span><span class="lineNoCov">          0 :       addComponent(&quot;gradmax&quot;+is); componentIsNotPeriodic(&quot;gradmax&quot;+is);</span>
<span class="lineNum">     712 </span><span class="lineNoCov">          0 :       if(aver_gradient_pntrs_.size()&gt;0){</span>
<span class="lineNum">     713 </span><span class="lineNoCov">          0 :         log.printf(&quot; &quot;);</span>
<span class="lineNum">     714 </span><span class="lineNoCov">          0 :         addComponent(&quot;avergradrms&quot;+is); componentIsNotPeriodic(&quot;avergradrms&quot;+is);</span>
<span class="lineNum">     715 </span><span class="lineNoCov">          0 :         log.printf(&quot; &quot;);</span>
<span class="lineNum">     716 </span><span class="lineNoCov">          0 :         addComponent(&quot;avergradmax&quot;+is); componentIsNotPeriodic(&quot;avergradmax&quot;+is);</span>
<span class="lineNum">     717 </span>            :       }
<span class="lineNum">     718 </span><span class="lineNoCov">          0 :       if(!fixed_stepsize_){</span>
<span class="lineNum">     719 </span><span class="lineNoCov">          0 :         log.printf(&quot; &quot;);</span>
<span class="lineNum">     720 </span><span class="lineNoCov">          0 :         addComponent(&quot;stepsize&quot;+is); componentIsNotPeriodic(&quot;stepsize&quot;+is);</span>
<span class="lineNum">     721 </span><span class="lineNoCov">          0 :         getPntrToComponent(&quot;stepsize&quot;+is)-&gt;set( getCurrentStepSize(i) );</span>
<span class="lineNum">     722 </span>            :       }
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">     724 </span><span class="lineCov">         47 :   }</span>
<span class="lineNum">     725 </span>            : 
<span class="lineNum">     726 </span><span class="lineCov">         47 : }</span>
<a name="727"><span class="lineNum">     727 </span>            : </a>
<span class="lineNum">     728 </span>            : 
<span class="lineNum">     729 </span><span class="lineCov">         94 : Optimizer::~Optimizer() {</span>
<span class="lineNum">     730 </span><span class="lineCov">         94 :   for(unsigned int i=0; i&lt;aux_coeffs_pntrs_.size(); i++){</span>
<span class="lineNum">     731 </span><span class="lineCov">         47 :     delete aux_coeffs_pntrs_[i];</span>
<span class="lineNum">     732 </span>            :   }
<span class="lineNum">     733 </span><span class="lineCov">         47 :   aux_coeffs_pntrs_.clear();</span>
<span class="lineNum">     734 </span>            :   //
<span class="lineNum">     735 </span><span class="lineCov">         47 :   for(unsigned int i=0; i&lt;aver_gradient_pntrs_.size(); i++){</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     delete aver_gradient_pntrs_[i];</span>
<span class="lineNum">     737 </span>            :   }
<span class="lineNum">     738 </span><span class="lineCov">         47 :   aver_gradient_pntrs_.clear();</span>
<span class="lineNum">     739 </span>            :   //
<span class="lineNum">     740 </span><span class="lineCov">         92 :   for(unsigned int i=0; i&lt;coeffs_mask_pntrs_.size(); i++){</span>
<span class="lineNum">     741 </span><span class="lineCov">         45 :     delete coeffs_mask_pntrs_[i];</span>
<span class="lineNum">     742 </span>            :   }
<span class="lineNum">     743 </span><span class="lineCov">         47 :   coeffs_mask_pntrs_.clear();</span>
<span class="lineNum">     744 </span>            :   //
<span class="lineNum">     745 </span><span class="lineCov">         92 :   for(unsigned int i=0; i&lt;coeffsOFiles_.size(); i++){</span>
<span class="lineNum">     746 </span><span class="lineCov">         45 :     coeffsOFiles_[i]-&gt;close();</span>
<span class="lineNum">     747 </span><span class="lineCov">         45 :     delete coeffsOFiles_[i];</span>
<span class="lineNum">     748 </span>            :   }
<span class="lineNum">     749 </span><span class="lineCov">         47 :   coeffsOFiles_.clear();</span>
<span class="lineNum">     750 </span><span class="lineCov">         86 :   for(unsigned int i=0; i&lt;gradientOFiles_.size(); i++){</span>
<span class="lineNum">     751 </span><span class="lineCov">         39 :     gradientOFiles_[i]-&gt;close();</span>
<span class="lineNum">     752 </span><span class="lineCov">         39 :     delete gradientOFiles_[i];</span>
<span class="lineNum">     753 </span>            :   }
<span class="lineNum">     754 </span><span class="lineCov">         47 :   gradientOFiles_.clear();</span>
<span class="lineNum">     755 </span><span class="lineCov">         83 :   for(unsigned int i=0; i&lt;hessianOFiles_.size(); i++){</span>
<span class="lineNum">     756 </span><span class="lineCov">         36 :     hessianOFiles_[i]-&gt;close();</span>
<span class="lineNum">     757 </span><span class="lineCov">         36 :     delete hessianOFiles_[i];</span>
<span class="lineNum">     758 </span>            :   }
<span class="lineNum">     759 </span><span class="lineCov">         47 :   hessianOFiles_.clear();</span>
<span class="lineNum">     760 </span><span class="lineCov">         73 :   for(unsigned int i=0; i&lt;targetdist_averagesOFiles_.size(); i++){</span>
<span class="lineNum">     761 </span><span class="lineCov">         26 :     targetdist_averagesOFiles_[i]-&gt;close();</span>
<span class="lineNum">     762 </span><span class="lineCov">         26 :     delete targetdist_averagesOFiles_[i];</span>
<span class="lineNum">     763 </span>            :   }
<span class="lineNum">     764 </span><span class="lineCov">         47 :   targetdist_averagesOFiles_.clear();</span>
<span class="lineNum">     765 </span><span class="lineCov">         47 : }</span>
<a name="766"><span class="lineNum">     766 </span>            : </a>
<span class="lineNum">     767 </span>            : 
<span class="lineNum">     768 </span><span class="lineCov">         57 : void Optimizer::registerKeywords( Keywords&amp; keys ) {</span>
<span class="lineNum">     769 </span><span class="lineCov">         57 :   Action::registerKeywords(keys);</span>
<span class="lineNum">     770 </span><span class="lineCov">         57 :   ActionPilot::registerKeywords(keys);</span>
<span class="lineNum">     771 </span><span class="lineCov">         57 :   ActionWithValue::registerKeywords(keys);</span>
<span class="lineNum">     772 </span>            :   //
<span class="lineNum">     773 </span><span class="lineCov">         57 :   keys.remove(&quot;NUMERICAL_DERIVATIVES&quot;);</span>
<span class="lineNum">     774 </span>            :   // Default always active keywords
<span class="lineNum">     775 </span><span class="lineCov">         57 :   keys.add(&quot;compulsory&quot;,&quot;BIAS&quot;,&quot;the label of the VES bias to be optimized&quot;);</span>
<span class="lineNum">     776 </span><span class="lineCov">         57 :   keys.add(&quot;compulsory&quot;,&quot;STRIDE&quot;,&quot;the frequency of updating the coefficients given in the number of MD steps.&quot;);</span>
<span class="lineNum">     777 </span><span class="lineCov">         57 :   keys.add(&quot;compulsory&quot;,&quot;COEFFS_FILE&quot;,&quot;coeffs.data&quot;,&quot;the name of output file for the coefficients&quot;);</span>
<span class="lineNum">     778 </span><span class="lineCov">         57 :   keys.add(&quot;compulsory&quot;,&quot;COEFFS_OUTPUT&quot;,&quot;100&quot;,&quot;how often the coefficients should be written to file. This parameter is given as the number of iterations.&quot;);</span>
<span class="lineNum">     779 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;COEFFS_FMT&quot;,&quot;specify format for coefficient file(s) (useful for decrease the number of digits in regtests)&quot;);</span>
<span class="lineNum">     780 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;COEFFS_SET_ID_PREFIX&quot;,&quot;suffix to add to the filename given in FILE to identfy the bias, should only be given if a single filename is given in FILE when optimizing multiple biases.&quot;);</span>
<span class="lineNum">     781 </span>            :   //
<span class="lineNum">     782 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;INITIAL_COEFFS&quot;,&quot;the name(s) of file(s) with the initial coefficents&quot;);</span>
<span class="lineNum">     783 </span>            :   // Hidden keywords to output the gradient to a file.
<span class="lineNum">     784 </span><span class="lineCov">         57 :   keys.add(&quot;hidden&quot;,&quot;GRADIENT_FILE&quot;,&quot;the name of output file for the gradient&quot;);</span>
<span class="lineNum">     785 </span><span class="lineCov">         57 :   keys.add(&quot;hidden&quot;,&quot;GRADIENT_OUTPUT&quot;,&quot;how often the gradient should be written to file. This parameter is given as the number of bias iterations. It is by default 100 if GRADIENT_FILE is specficed&quot;);</span>
<span class="lineNum">     786 </span><span class="lineCov">         57 :   keys.add(&quot;hidden&quot;,&quot;GRADIENT_FMT&quot;,&quot;specify format for gradient file(s) (useful for decrease the number of digits in regtests)&quot;);</span>
<span class="lineNum">     787 </span>            :   // Either use a fixed stepsize (useFixedStepSizeKeywords) or changing stepsize (useDynamicsStepSizeKeywords)
<span class="lineNum">     788 </span><span class="lineCov">         57 :   keys.reserve(&quot;compulsory&quot;,&quot;STEPSIZE&quot;,&quot;the step size used for the optimization&quot;);</span>
<span class="lineNum">     789 </span><span class="lineCov">         57 :   keys.reserve(&quot;compulsory&quot;,&quot;INITIAL_STEPSIZE&quot;,&quot;the initial step size used for the optimization&quot;);</span>
<span class="lineNum">     790 </span>            :   // Keywords related to the Hessian, actived with the useHessianKeywords function
<span class="lineNum">     791 </span><span class="lineCov">         57 :   keys.reserveFlag(&quot;FULL_HESSIAN&quot;,false,&quot;if the full Hessian matrix should be used for the optimization, otherwise only the diagonal part of the Hessian is used&quot;);</span>
<span class="lineNum">     792 </span><span class="lineCov">         57 :   keys.reserve(&quot;hidden&quot;,&quot;HESSIAN_FILE&quot;,&quot;the name of output file for the Hessian&quot;);</span>
<span class="lineNum">     793 </span><span class="lineCov">         57 :   keys.reserve(&quot;hidden&quot;,&quot;HESSIAN_OUTPUT&quot;,&quot;how often the Hessian should be written to file. This parameter is given as the number of bias iterations. It is by default 100 if HESSIAN_FILE is specficed&quot;);</span>
<span class="lineNum">     794 </span><span class="lineCov">         57 :   keys.reserve(&quot;hidden&quot;,&quot;HESSIAN_FMT&quot;,&quot;specify format for hessian file(s) (useful for decrease the number of digits in regtests)&quot;);</span>
<span class="lineNum">     795 </span>            :   // Keywords related to the multiple walkers, actived with the useMultipleWalkersKeywords function
<span class="lineNum">     796 </span><span class="lineCov">         57 :   keys.reserveFlag(&quot;MULTIPLE_WALKERS&quot;,false,&quot;if optimization is to be performed using multiple walkers connected via MPI&quot;);</span>
<span class="lineNum">     797 </span>            :   // Keywords related to the mask file, actived with the useMaskKeywords function
<span class="lineNum">     798 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;MASK_FILE&quot;,&quot;read in a mask file which allows one to employ different step sizes for different coefficents and/or deactive the optimization of certain coefficients (by putting values of 0.0). One can write out the resulting mask by using the OUTPUT_MASK_FILE keyword.&quot;);</span>
<span class="lineNum">     799 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;OUTPUT_MASK_FILE&quot;,&quot;Name of the file to write out the mask resulting from using the MASK_FILE keyword. Can also be used to generate a template mask file.&quot;);</span>
<span class="lineNum">     800 </span>            :   //
<span class="lineNum">     801 </span><span class="lineCov">         57 :   keys.reserveFlag(&quot;START_OPTIMIZATION_AFRESH&quot;,false,&quot;if the iterations should be started afresh when a restart has been triggered by the RESTART keyword or the MD code.&quot;);</span>
<span class="lineNum">     802 </span>            :   //
<span class="lineNum">     803 </span><span class="lineCov">         57 :   keys.reserveFlag(&quot;MONITOR_AVERAGE_GRADIENT&quot;,false,&quot;if the averaged gradient should be monitored.&quot;);</span>
<span class="lineNum">     804 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;MONITOR_AVERAGES_EXP_DECAY&quot;,&quot;use an exponentially decaying averaging with a given time constant when monitoring the averaged gradient&quot;);</span>
<span class="lineNum">     805 </span>            :   //
<span class="lineNum">     806 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;TARGETDIST_STRIDE&quot;,&quot;stride for updating a target distribution that is iteratively updated during the optimization. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     807 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;TARGETDIST_OUTPUT&quot;,&quot;how often the dynamic target distribution(s) should be written out to file. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     808 </span><span class="lineCov">         57 :   keys.reserve(&quot;optional&quot;,&quot;TARGETDIST_PROJ_OUTPUT&quot;,&quot;how often the projections of the dynamic target distribution(s) should be written out to file. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     809 </span>            :   //
<span class="lineNum">     810 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;TARGETDIST_AVERAGES_FILE&quot;,&quot;the name of output file for the target distribution averages. By default it is targetdist-averages.data.&quot;);</span>
<span class="lineNum">     811 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;TARGETDIST_AVERAGES_OUTPUT&quot;,&quot;how often the target distribution averages should be written out to file. Note that the value is given in terms of coefficent iterations. If no value is given are the averages only written at the begining of the optimization&quot;);</span>
<span class="lineNum">     812 </span><span class="lineCov">         57 :   keys.add(&quot;hidden&quot;,&quot;TARGETDIST_AVERAGES_FMT&quot;,&quot;specify format for target distribution averages file(s) (useful for decrease the number of digits in regtests)&quot;);</span>
<span class="lineNum">     813 </span>            :   //
<span class="lineNum">     814 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;BIAS_OUTPUT&quot;,&quot;how often the bias(es) should be written out to file. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     815 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;FES_OUTPUT&quot;,&quot;how often the FES(s) should be written out to file. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     816 </span><span class="lineCov">         57 :   keys.add(&quot;optional&quot;,&quot;FES_PROJ_OUTPUT&quot;,&quot;how often the projections of the FES(s) should be written out to file. Note that the value is given in terms of coefficent iterations.&quot;);</span>
<span class="lineNum">     817 </span>            :   //
<span class="lineNum">     818 </span><span class="lineCov">         57 :   keys.use(&quot;RESTART&quot;);</span>
<span class="lineNum">     819 </span>            :   //
<span class="lineNum">     820 </span><span class="lineCov">         57 :   keys.use(&quot;UPDATE_FROM&quot;);</span>
<span class="lineNum">     821 </span><span class="lineCov">         57 :   keys.use(&quot;UPDATE_UNTIL&quot;);</span>
<span class="lineNum">     822 </span>            :   // Components that are always active
<span class="lineNum">     823 </span><span class="lineCov">         57 :   keys.addOutputComponent(&quot;gradrms&quot;,&quot;default&quot;,&quot;the root mean square value of the coefficent gradient. For multiple biases this component is labeled using the number of the bias as gradrms-#.&quot;);</span>
<span class="lineNum">     824 </span><span class="lineCov">         57 :   keys.addOutputComponent(&quot;gradmax&quot;,&quot;default&quot;,&quot;the largest absolute value of the coefficent gradient. For multiple biases this component is labeled using the number of the bias as gradmax-#.&quot;);</span>
<span class="lineNum">     825 </span><span class="lineCov">         57 :   ActionWithValue::useCustomisableComponents(keys);</span>
<span class="lineNum">     826 </span>            :   // keys.addOutputComponent(&quot;gradmaxidx&quot;,&quot;default&quot;,&quot;the index of the maximum absolute value of the gradient&quot;);
<span class="lineNum">     827 </span><span class="lineCov">         57 : }</span>
<a name="828"><span class="lineNum">     828 </span>            : </a>
<span class="lineNum">     829 </span>            : 
<span class="lineNum">     830 </span><span class="lineCov">         45 : void Optimizer::useHessianKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     831 </span>            :   // keys.use(&quot;FULL_HESSIAN&quot;);
<span class="lineNum">     832 </span><span class="lineCov">         45 :   keys.use(&quot;HESSIAN_FILE&quot;);</span>
<span class="lineNum">     833 </span><span class="lineCov">         45 :   keys.use(&quot;HESSIAN_OUTPUT&quot;);</span>
<span class="lineNum">     834 </span><span class="lineCov">         45 :   keys.use(&quot;HESSIAN_FMT&quot;);</span>
<span class="lineNum">     835 </span><span class="lineCov">         45 : }</span>
<a name="836"><span class="lineNum">     836 </span>            : </a>
<span class="lineNum">     837 </span>            : 
<span class="lineNum">     838 </span><span class="lineCov">         54 : void Optimizer::useMultipleWalkersKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     839 </span><span class="lineCov">         54 :   keys.use(&quot;MULTIPLE_WALKERS&quot;);</span>
<span class="lineNum">     840 </span><span class="lineCov">         54 : }</span>
<a name="841"><span class="lineNum">     841 </span>            : </a>
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span><span class="lineCov">         46 : void Optimizer::useFixedStepSizeKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     844 </span><span class="lineCov">         46 :   keys.use(&quot;STEPSIZE&quot;);</span>
<span class="lineNum">     845 </span><span class="lineCov">         46 : }</span>
<a name="846"><span class="lineNum">     846 </span>            : </a>
<span class="lineNum">     847 </span>            : 
<span class="lineNum">     848 </span><span class="lineCov">          5 : void Optimizer::useDynamicStepSizeKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     849 </span><span class="lineCov">          5 :   keys.use(&quot;INITIAL_STEPSIZE&quot;);</span>
<span class="lineNum">     850 </span><span class="lineCov">          5 :   keys.addOutputComponent(&quot;stepsize&quot;,&quot;default&quot;,&quot;the current value of step size used to update the coefficients. For multiple biases this component is labeled using the number of the bias as stepsize-#.&quot;);</span>
<span class="lineNum">     851 </span><span class="lineCov">          5 : }</span>
<a name="852"><span class="lineNum">     852 </span>            : </a>
<span class="lineNum">     853 </span>            : 
<span class="lineNum">     854 </span><span class="lineCov">         51 : void Optimizer::useMaskKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     855 </span><span class="lineCov">         51 :   keys.use(&quot;MASK_FILE&quot;);</span>
<span class="lineNum">     856 </span><span class="lineCov">         51 :   keys.use(&quot;OUTPUT_MASK_FILE&quot;);</span>
<span class="lineNum">     857 </span><span class="lineCov">         51 : }</span>
<a name="858"><span class="lineNum">     858 </span>            : </a>
<span class="lineNum">     859 </span>            : 
<span class="lineNum">     860 </span><span class="lineCov">         47 : void Optimizer::useRestartKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     861 </span><span class="lineCov">         47 :   keys.use(&quot;START_OPTIMIZATION_AFRESH&quot;);</span>
<span class="lineNum">     862 </span><span class="lineCov">         47 : }</span>
<a name="863"><span class="lineNum">     863 </span>            : </a>
<span class="lineNum">     864 </span>            : 
<span class="lineNum">     865 </span><span class="lineNoCov">          0 : void Optimizer::useMonitorAveragesKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     866 </span><span class="lineNoCov">          0 :   keys.use(&quot;MONITOR_AVERAGE_GRADIENT&quot;);</span>
<span class="lineNum">     867 </span><span class="lineNoCov">          0 :   keys.use(&quot;MONITOR_AVERAGES_EXP_DECAY&quot;);</span>
<span class="lineNum">     868 </span><span class="lineNoCov">          0 : }</span>
<a name="869"><span class="lineNum">     869 </span>            : </a>
<span class="lineNum">     870 </span>            : 
<span class="lineNum">     871 </span><span class="lineCov">         47 : void Optimizer::useDynamicTargetDistributionKeywords(Keywords&amp; keys) {</span>
<span class="lineNum">     872 </span><span class="lineCov">         47 :   keys.use(&quot;TARGETDIST_STRIDE&quot;);</span>
<span class="lineNum">     873 </span><span class="lineCov">         47 :   keys.use(&quot;TARGETDIST_OUTPUT&quot;);</span>
<span class="lineNum">     874 </span><span class="lineCov">         47 :   keys.use(&quot;TARGETDIST_PROJ_OUTPUT&quot;);</span>
<span class="lineNum">     875 </span><span class="lineCov">         47 : }</span>
<a name="876"><span class="lineNum">     876 </span>            : </a>
<span class="lineNum">     877 </span>            : 
<span class="lineNum">     878 </span><span class="lineCov">         41 : void Optimizer::turnOnHessian() {</span>
<span class="lineNum">     879 </span><span class="lineCov">         41 :   plumed_massert(hessian_pntrs_.size()==0,&quot;turnOnHessian() should only be run during initialization&quot;);</span>
<span class="lineNum">     880 </span><span class="lineCov">         41 :   use_hessian_=true;</span>
<span class="lineNum">     881 </span><span class="lineCov">         41 :   hessian_pntrs_.clear();</span>
<span class="lineNum">     882 </span><span class="lineCov">         82 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     883 </span><span class="lineCov">         41 :     std::vector&lt;CoeffsMatrix*&gt; pntrs_hessian = enableHessian(bias_pntrs_[i],diagonal_hessian_);</span>
<span class="lineNum">     884 </span><span class="lineCov">         82 :     for(unsigned int k=0; k&lt;pntrs_hessian.size(); k++){</span>
<span class="lineNum">     885 </span><span class="lineCov">         41 :       pntrs_hessian[k]-&gt;turnOnIterationCounter();</span>
<span class="lineNum">     886 </span><span class="lineCov">         41 :       pntrs_hessian[k]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">     887 </span><span class="lineCov">         41 :       hessian_pntrs_.push_back(pntrs_hessian[k]);</span>
<span class="lineNum">     888 </span>            :     }
<span class="lineNum">     889 </span><span class="lineCov">         41 :   }</span>
<span class="lineNum">     890 </span><span class="lineCov">         41 :   plumed_massert(hessian_pntrs_.size()==ncoeffssets_,&quot;problems in linking Hessians&quot;);</span>
<span class="lineNum">     891 </span><span class="lineCov">         41 :   if(diagonal_hessian_){</span>
<span class="lineNum">     892 </span><span class="lineCov">         41 :     log.printf(&quot;  Optimization performed using diagonal Hessian matrix\n&quot;);</span>
<span class="lineNum">     893 </span>            :   }
<span class="lineNum">     894 </span>            :   else {
<span class="lineNum">     895 </span><span class="lineNoCov">          0 :     log.printf(&quot;  Optimization performed using full Hessian matrix\n&quot;);</span>
<span class="lineNum">     896 </span>            :   }
<span class="lineNum">     897 </span>            :   //
<span class="lineNum">     898 </span><span class="lineCov">         41 :   if(hessian_output_fmt_.size()&gt;0){</span>
<span class="lineNum">     899 </span><span class="lineCov">         72 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     900 </span><span class="lineCov">         36 :       hessian_pntrs_[i]-&gt;setOutputFmt(hessian_output_fmt_);</span>
<span class="lineNum">     901 </span>            :     }
<span class="lineNum">     902 </span>            :   }
<span class="lineNum">     903 </span>            : 
<span class="lineNum">     904 </span><span class="lineCov">         41 : }</span>
<a name="905"><span class="lineNum">     905 </span>            : </a>
<span class="lineNum">     906 </span>            : 
<span class="lineNum">     907 </span><span class="lineCov">          1 : void Optimizer::turnOffHessian() {</span>
<span class="lineNum">     908 </span><span class="lineCov">          1 :   use_hessian_=false;</span>
<span class="lineNum">     909 </span><span class="lineCov">          2 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     910 </span><span class="lineCov">          1 :     bias_pntrs_[i]-&gt;disableHessian();</span>
<span class="lineNum">     911 </span>            :   }
<span class="lineNum">     912 </span><span class="lineCov">          1 :   hessian_pntrs_.clear();</span>
<span class="lineNum">     913 </span><span class="lineCov">          1 :   for(unsigned int i=0; i&lt;hessianOFiles_.size(); i++){</span>
<span class="lineNum">     914 </span><span class="lineNoCov">          0 :     hessianOFiles_[i]-&gt;close();</span>
<span class="lineNum">     915 </span><span class="lineNoCov">          0 :     delete hessianOFiles_[i];</span>
<span class="lineNum">     916 </span>            :   }
<span class="lineNum">     917 </span><span class="lineCov">          1 :   hessianOFiles_.clear();</span>
<span class="lineNum">     918 </span><span class="lineCov">          1 : }</span>
<a name="919"><span class="lineNum">     919 </span>            : </a>
<span class="lineNum">     920 </span>            : 
<span class="lineNum">     921 </span><span class="lineCov">         41 : std::vector&lt;CoeffsMatrix*&gt; Optimizer::enableHessian(VesBias* bias_pntr_in, const bool diagonal_hessian) {</span>
<span class="lineNum">     922 </span><span class="lineCov">         41 :   plumed_massert(use_hessian_,&quot;the Hessian should not be used&quot;);</span>
<span class="lineNum">     923 </span><span class="lineCov">         41 :   bias_pntr_in-&gt;enableHessian(diagonal_hessian);</span>
<span class="lineNum">     924 </span><span class="lineCov">         41 :   std::vector&lt;CoeffsMatrix*&gt; hessian_pntrs_out = bias_pntr_in-&gt;getHessianPntrs();</span>
<span class="lineNum">     925 </span><span class="lineCov">         82 :   for(unsigned int k=0; k&lt;hessian_pntrs_out.size(); k++){</span>
<span class="lineNum">     926 </span><span class="lineCov">         41 :     plumed_massert(hessian_pntrs_out[k] != NULL,&quot;Hessian is needed but not linked correctly&quot;);</span>
<span class="lineNum">     927 </span>            :   }
<span class="lineNum">     928 </span><span class="lineCov">         41 :   return hessian_pntrs_out;</span>
<span class="lineNum">     929 </span>            : }
<span class="lineNum">     930 </span>            : 
<span class="lineNum">     931 </span>            : 
<span class="lineNum">     932 </span>            : // CoeffsMatrix* Optimizer::switchToDiagonalHessian(VesBias* bias_pntr_in) {
<span class="lineNum">     933 </span>            : //   plumed_massert(use_hessian_,&quot;it does not make sense to switch to diagonal Hessian if it Hessian is not used&quot;);
<span class="lineNum">     934 </span>            : //   diagonal_hessian_=true;
<span class="lineNum">     935 </span>            : //   bias_pntr_in-&gt;enableHessian(diagonal_hessian_);
<span class="lineNum">     936 </span>            : //   CoeffsMatrix* hessian_pntr_out = bias_pntr_in-&gt;getHessianPntr();
<span class="lineNum">     937 </span>            : //   plumed_massert(hessian_pntr_out != NULL,&quot;Hessian is needed but not linked correctly&quot;);
<span class="lineNum">     938 </span>            : //   //
<span class="lineNum">     939 </span>            : //   log.printf(&quot;  %s (with label %s): switching to a diagonal Hessian for VES bias %s (with label %s) at time  %f\n&quot;,getName().c_str(),getLabel().c_str(),bias_pntr_in-&gt;getName().c_str(),bias_pntr_in-&gt;getLabel().c_str(),getTime());
<span class="lineNum">     940 </span>            : //   return hessian_pntr_out;
<span class="lineNum">     941 </span>            : // }
<span class="lineNum">     942 </span>            : 
<span class="lineNum">     943 </span>            : 
<span class="lineNum">     944 </span>            : // CoeffsMatrix* Optimizer::switchToFullHessian(VesBias* bias_pntr_in) {
<span class="lineNum">     945 </span>            : //   plumed_massert(use_hessian_,&quot;it does not make sense to switch to diagonal Hessian if it Hessian is not used&quot;);
<span class="lineNum">     946 </span>            : //   diagonal_hessian_=false;
<span class="lineNum">     947 </span>            : //   bias_pntr_in-&gt;enableHessian(diagonal_hessian_);
<span class="lineNum">     948 </span>            : //   CoeffsMatrix* hessian_pntr_out = bias_pntr_in-&gt;getHessianPntr();
<span class="lineNum">     949 </span>            : //   plumed_massert(hessian_pntr_out != NULL,&quot;Hessian is needed but not linked correctly&quot;);
<span class="lineNum">     950 </span>            : //   //
<span class="lineNum">     951 </span>            : //   log.printf(&quot;  %s (with label %s): switching to a diagonal Hessian for VES bias %s (with label %s) at time  %f\n&quot;,getName().c_str(),getLabel().c_str(),bias_pntr_in-&gt;getName().c_str(),bias_pntr_in-&gt;getLabel().c_str(),getTime());
<span class="lineNum">     952 </span>            : //   return hessian_pntr_out;
<span class="lineNum">     953 </span>            : // }
<a name="954"><span class="lineNum">     954 </span>            : </a>
<span class="lineNum">     955 </span>            : 
<span class="lineNum">     956 </span><span class="lineCov">        606 : void Optimizer::update() {</span>
<span class="lineNum">     957 </span><span class="lineCov">        606 :   if(onStep() &amp;&amp; !isFirstStep){</span>
<span class="lineNum">     958 </span><span class="lineCov">        920 :     for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     959 </span><span class="lineCov">        460 :       bias_pntrs_[i]-&gt;updateGradientAndHessian(use_mwalkers_mpi_);</span>
<span class="lineNum">     960 </span>            :     }
<span class="lineNum">     961 </span><span class="lineCov">        920 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     962 </span><span class="lineCov">        460 :       if(gradient_pntrs_[i]-&gt;isActive()){coeffsUpdate(i);}</span>
<span class="lineNum">     963 </span>            :       // +1 as this is done before increaseIterationCounter() is used
<span class="lineNum">     964 </span><span class="lineCov">        460 :       unsigned int curr_iter = getIterationCounter()+1;</span>
<span class="lineNum">     965 </span><span class="lineCov">        460 :       double curr_time = getTime();</span>
<span class="lineNum">     966 </span><span class="lineCov">        460 :       coeffs_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     967 </span><span class="lineCov">        460 :       aux_coeffs_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     968 </span><span class="lineCov">        460 :       gradient_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     969 </span><span class="lineCov">        460 :       targetdist_averages_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     970 </span><span class="lineCov">        460 :       if(use_hessian_){</span>
<span class="lineNum">     971 </span><span class="lineCov">        410 :         hessian_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     972 </span>            :       }
<span class="lineNum">     973 </span><span class="lineCov">        460 :       if(aver_gradient_pntrs_.size()&gt;0){</span>
<span class="lineNum">     974 </span><span class="lineNoCov">          0 :         aver_gradient_pntrs_[i]-&gt;setIterationCounterAndTime(curr_iter,curr_time);</span>
<span class="lineNum">     975 </span><span class="lineNoCov">          0 :         aver_gradient_pntrs_[i]-&gt;addToAverage(*gradient_pntrs_[i]);</span>
<span class="lineNum">     976 </span>            :       }
<span class="lineNum">     977 </span>            :     }
<span class="lineNum">     978 </span><span class="lineCov">        460 :     increaseIterationCounter();</span>
<span class="lineNum">     979 </span><span class="lineCov">        460 :     updateOutputComponents();</span>
<span class="lineNum">     980 </span><span class="lineCov">        920 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">     981 </span><span class="lineCov">        460 :       writeOutputFiles(i);</span>
<span class="lineNum">     982 </span>            :     }
<span class="lineNum">     983 </span><span class="lineCov">        460 :     if(ustride_targetdist_&gt;0 &amp;&amp; getIterationCounter()%ustride_targetdist_==0){</span>
<span class="lineNum">     984 </span><span class="lineCov">        520 :       for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">     985 </span><span class="lineCov">        260 :         if(dynamic_targetdists_[i]){</span>
<span class="lineNum">     986 </span><span class="lineCov">        260 :           bias_pntrs_[i]-&gt;updateTargetDistributions();</span>
<span class="lineNum">     987 </span>            :         }
<span class="lineNum">     988 </span>            :       }
<span class="lineNum">     989 </span>            :     }
<span class="lineNum">     990 </span>            :     //
<span class="lineNum">     991 </span><span class="lineCov">        460 :     if(isBiasOutputActive() &amp;&amp; getIterationCounter()%getBiasOutputStride()==0){</span>
<span class="lineNum">     992 </span><span class="lineCov">         46 :       writeBiasOutputFiles();</span>
<span class="lineNum">     993 </span>            :     }
<span class="lineNum">     994 </span><span class="lineCov">        460 :     if(isFesOutputActive() &amp;&amp; getIterationCounter()%getFesOutputStride()==0){</span>
<span class="lineNum">     995 </span><span class="lineCov">         46 :       writeFesOutputFiles();</span>
<span class="lineNum">     996 </span>            :     }
<span class="lineNum">     997 </span><span class="lineCov">        460 :     if(isFesProjOutputActive() &amp;&amp; getIterationCounter()%getFesProjOutputStride()==0){</span>
<span class="lineNum">     998 </span><span class="lineCov">          8 :       writeFesProjOutputFiles();</span>
<span class="lineNum">     999 </span>            :     }
<span class="lineNum">    1000 </span><span class="lineCov">        460 :     if(isTargetDistOutputActive() &amp;&amp; getIterationCounter()%getTargetDistOutputStride()==0){</span>
<span class="lineNum">    1001 </span><span class="lineCov">         26 :       writeTargetDistOutputFiles();</span>
<span class="lineNum">    1002 </span>            :     }
<span class="lineNum">    1003 </span><span class="lineCov">        460 :     if(isTargetDistProjOutputActive() &amp;&amp; getIterationCounter()%getTargetDistProjOutputStride()==0){</span>
<span class="lineNum">    1004 </span><span class="lineCov">          2 :       writeTargetDistProjOutputFiles();</span>
<span class="lineNum">    1005 </span>            :     }
<span class="lineNum">    1006 </span>            :   }
<span class="lineNum">    1007 </span>            :   else {
<span class="lineNum">    1008 </span><span class="lineCov">        146 :     isFirstStep=false;</span>
<span class="lineNum">    1009 </span>            :   }
<span class="lineNum">    1010 </span><span class="lineCov">        606 : }</span>
<a name="1011"><span class="lineNum">    1011 </span>            : </a>
<span class="lineNum">    1012 </span>            : 
<span class="lineNum">    1013 </span><span class="lineCov">        460 : void Optimizer::updateOutputComponents() {</span>
<span class="lineNum">    1014 </span><span class="lineCov">        460 :   if(ncoeffssets_==1){</span>
<span class="lineNum">    1015 </span><span class="lineCov">        460 :     if(!fixed_stepsize_){</span>
<span class="lineNum">    1016 </span><span class="lineCov">         30 :       getPntrToComponent(&quot;stepsize&quot;)-&gt;set( getCurrentStepSize(0) );</span>
<span class="lineNum">    1017 </span>            :     }
<span class="lineNum">    1018 </span><span class="lineCov">        460 :     getPntrToComponent(&quot;gradrms&quot;)-&gt;set( gradient_pntrs_[0]-&gt;getRMS() );</span>
<span class="lineNum">    1019 </span><span class="lineCov">        460 :     size_t gradient_maxabs_idx=0;</span>
<span class="lineNum">    1020 </span><span class="lineCov">        460 :     getPntrToComponent(&quot;gradmax&quot;)-&gt;set( gradient_pntrs_[0]-&gt;getMaxAbsValue(gradient_maxabs_idx) );</span>
<span class="lineNum">    1021 </span><span class="lineCov">        460 :     if(aver_gradient_pntrs_.size()&gt;0){</span>
<span class="lineNum">    1022 </span><span class="lineNoCov">          0 :       getPntrToComponent(&quot;avergradrms&quot;)-&gt;set( aver_gradient_pntrs_[0]-&gt;getRMS() );</span>
<span class="lineNum">    1023 </span><span class="lineNoCov">          0 :       getPntrToComponent(&quot;avergradmax&quot;)-&gt;set( aver_gradient_pntrs_[0]-&gt;getMaxAbsValue(gradient_maxabs_idx) );</span>
<span class="lineNum">    1024 </span>            :     }
<span class="lineNum">    1025 </span>            :   }
<span class="lineNum">    1026 </span>            :   else {
<span class="lineNum">    1027 </span><span class="lineNoCov">          0 :     for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">    1028 </span><span class="lineNoCov">          0 :       std::string is=&quot;&quot;; Tools::convert(i,is); is = &quot;_&quot; + coeffssetid_prefix_ + is;</span>
<span class="lineNum">    1029 </span><span class="lineNoCov">          0 :       if(!fixed_stepsize_){</span>
<span class="lineNum">    1030 </span><span class="lineNoCov">          0 :         getPntrToComponent(&quot;stepsize&quot;+is)-&gt;set( getCurrentStepSize(i) );</span>
<span class="lineNum">    1031 </span>            :       }
<span class="lineNum">    1032 </span><span class="lineNoCov">          0 :       getPntrToComponent(&quot;gradrms&quot;+is)-&gt;set( gradient_pntrs_[i]-&gt;getRMS() );</span>
<span class="lineNum">    1033 </span><span class="lineNoCov">          0 :       size_t gradient_maxabs_idx=0;</span>
<span class="lineNum">    1034 </span><span class="lineNoCov">          0 :       getPntrToComponent(&quot;gradmax&quot;+is)-&gt;set( gradient_pntrs_[i]-&gt;getMaxAbsValue(gradient_maxabs_idx) );</span>
<span class="lineNum">    1035 </span><span class="lineNoCov">          0 :       if(aver_gradient_pntrs_.size()&gt;0){</span>
<span class="lineNum">    1036 </span><span class="lineNoCov">          0 :         getPntrToComponent(&quot;avergradrms&quot;+is)-&gt;set( aver_gradient_pntrs_[0]-&gt;getRMS() );</span>
<span class="lineNum">    1037 </span><span class="lineNoCov">          0 :         getPntrToComponent(&quot;avergradmax&quot;+is)-&gt;set( aver_gradient_pntrs_[0]-&gt;getMaxAbsValue(gradient_maxabs_idx) );</span>
<span class="lineNum">    1038 </span>            :       }
<span class="lineNum">    1039 </span><span class="lineNoCov">          0 :     }</span>
<span class="lineNum">    1040 </span>            :   }
<span class="lineNum">    1041 </span><span class="lineCov">        460 : }</span>
<a name="1042"><span class="lineNum">    1042 </span>            : </a>
<span class="lineNum">    1043 </span>            : 
<span class="lineNum">    1044 </span><span class="lineCov">          2 : void Optimizer::turnOffCoeffsOutputFiles() {</span>
<span class="lineNum">    1045 </span><span class="lineCov">          3 :   for(unsigned int i=0; i&lt;coeffsOFiles_.size(); i++){</span>
<span class="lineNum">    1046 </span><span class="lineCov">          1 :     coeffsOFiles_[i]-&gt;close();</span>
<span class="lineNum">    1047 </span><span class="lineCov">          1 :     delete coeffsOFiles_[i];</span>
<span class="lineNum">    1048 </span>            :   }
<span class="lineNum">    1049 </span><span class="lineCov">          2 :   coeffsOFiles_.clear();</span>
<span class="lineNum">    1050 </span><span class="lineCov">          2 : }</span>
<a name="1051"><span class="lineNum">    1051 </span>            : </a>
<span class="lineNum">    1052 </span>            : 
<span class="lineNum">    1053 </span><span class="lineCov">        460 : void Optimizer::writeOutputFiles(const unsigned int coeffs_id) {</span>
<span class="lineNum">    1054 </span><span class="lineCov">        460 :   if(coeffsOFiles_.size()&gt;0 &amp;&amp; iter_counter%coeffs_wstride_==0){</span>
<span class="lineNum">    1055 </span><span class="lineCov">        450 :     coeffs_pntrs_[coeffs_id]-&gt;writeToFile(*coeffsOFiles_[coeffs_id],aux_coeffs_pntrs_[coeffs_id],false);</span>
<span class="lineNum">    1056 </span>            :   }
<span class="lineNum">    1057 </span><span class="lineCov">        460 :   if(gradientOFiles_.size()&gt;0 &amp;&amp; iter_counter%gradient_wstride_==0){</span>
<span class="lineNum">    1058 </span><span class="lineCov">        390 :     if(aver_gradient_pntrs_.size()==0){</span>
<span class="lineNum">    1059 </span><span class="lineCov">        390 :       gradient_pntrs_[coeffs_id]-&gt;writeToFile(*gradientOFiles_[coeffs_id],false);</span>
<span class="lineNum">    1060 </span>            :     }
<span class="lineNum">    1061 </span>            :     else{
<span class="lineNum">    1062 </span><span class="lineNoCov">          0 :       gradient_pntrs_[coeffs_id]-&gt;writeToFile(*gradientOFiles_[coeffs_id],aver_gradient_pntrs_[coeffs_id],false);</span>
<span class="lineNum">    1063 </span>            :     }
<span class="lineNum">    1064 </span>            :   }
<span class="lineNum">    1065 </span><span class="lineCov">        460 :   if(hessianOFiles_.size()&gt;0 &amp;&amp; iter_counter%hessian_wstride_==0){</span>
<span class="lineNum">    1066 </span><span class="lineCov">        360 :     hessian_pntrs_[coeffs_id]-&gt;writeToFile(*hessianOFiles_[coeffs_id]);</span>
<span class="lineNum">    1067 </span>            :   }
<span class="lineNum">    1068 </span><span class="lineCov">        460 :   if(targetdist_averagesOFiles_.size()&gt;0 &amp;&amp; iter_counter%targetdist_averages_wstride_==0){</span>
<span class="lineNum">    1069 </span><span class="lineCov">        260 :     targetdist_averages_pntrs_[coeffs_id]-&gt;writeToFile(*targetdist_averagesOFiles_[coeffs_id]);</span>
<span class="lineNum">    1070 </span>            :   }
<span class="lineNum">    1071 </span><span class="lineCov">        460 : }</span>
<a name="1072"><span class="lineNum">    1072 </span>            : </a>
<span class="lineNum">    1073 </span>            : 
<span class="lineNum">    1074 </span><span class="lineCov">        219 : void Optimizer::setupOFiles(std::vector&lt;std::string&gt;&amp; fnames, std::vector&lt;OFile*&gt;&amp; OFiles, const bool multi_sim_single_files) {</span>
<span class="lineNum">    1075 </span><span class="lineCov">        219 :   plumed_assert(ncoeffssets_&gt;0);</span>
<span class="lineNum">    1076 </span><span class="lineCov">        219 :   OFiles.resize(fnames.size(),NULL);</span>
<span class="lineNum">    1077 </span><span class="lineCov">        389 :   for(unsigned int i=0; i&lt;fnames.size();i++){</span>
<span class="lineNum">    1078 </span><span class="lineCov">        170 :     OFiles[i] = new OFile();</span>
<span class="lineNum">    1079 </span><span class="lineCov">        170 :     OFiles[i]-&gt;link(*this);</span>
<span class="lineNum">    1080 </span><span class="lineCov">        170 :     if(multi_sim_single_files){</span>
<span class="lineNum">    1081 </span><span class="lineNoCov">          0 :       unsigned int r=0;</span>
<span class="lineNum">    1082 </span><span class="lineNoCov">          0 :       if(comm.Get_rank()==0){r=multi_sim_comm.Get_rank();}</span>
<span class="lineNum">    1083 </span><span class="lineNoCov">          0 :       comm.Bcast(r,0);</span>
<span class="lineNum">    1084 </span><span class="lineNoCov">          0 :       if(r&gt;0){fnames[i]=&quot;/dev/null&quot;;}</span>
<span class="lineNum">    1085 </span><span class="lineNoCov">          0 :       OFiles[i]-&gt;enforceSuffix(&quot;&quot;);</span>
<span class="lineNum">    1086 </span>            :     }
<span class="lineNum">    1087 </span><span class="lineCov">        170 :     OFiles[i]-&gt;open(fnames[i]);</span>
<span class="lineNum">    1088 </span><span class="lineCov">        170 :     OFiles[i]-&gt;setHeavyFlush();</span>
<span class="lineNum">    1089 </span>            :   }
<span class="lineNum">    1090 </span><span class="lineCov">        219 : }</span>
<a name="1091"><span class="lineNum">    1091 </span>            : </a>
<span class="lineNum">    1092 </span>            : 
<span class="lineNum">    1093 </span><span class="lineCov">          7 : void Optimizer::readCoeffsFromFiles(const std::vector&lt;std::string&gt;&amp; fnames, const bool read_aux_coeffs) {</span>
<span class="lineNum">    1094 </span><span class="lineCov">          7 :   plumed_assert(ncoeffssets_&gt;0);</span>
<span class="lineNum">    1095 </span><span class="lineCov">          7 :   plumed_assert(fnames.size()==ncoeffssets_);</span>
<span class="lineNum">    1096 </span><span class="lineCov">          7 :   if(ncoeffssets_==1){</span>
<span class="lineNum">    1097 </span><span class="lineCov">          7 :     log.printf(&quot;  Read in coefficents from file &quot;);</span>
<span class="lineNum">    1098 </span>            :   }
<span class="lineNum">    1099 </span>            :   else{
<span class="lineNum">    1100 </span><span class="lineNoCov">          0 :     log.printf(&quot;  Read in coefficents from files:\n&quot;);</span>
<span class="lineNum">    1101 </span>            :   }
<span class="lineNum">    1102 </span><span class="lineCov">         14 :   for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">    1103 </span><span class="lineCov">          7 :     IFile ifile;</span>
<span class="lineNum">    1104 </span><span class="lineCov">          7 :     ifile.link(*this);</span>
<span class="lineNum">    1105 </span><span class="lineCov">          7 :     if(use_mwalkers_mpi_ &amp;&amp; mwalkers_mpi_single_files_){</span>
<span class="lineNum">    1106 </span><span class="lineNoCov">          0 :       ifile.enforceSuffix(&quot;&quot;);</span>
<span class="lineNum">    1107 </span>            :     }
<span class="lineNum">    1108 </span><span class="lineCov">          7 :     ifile.open(fnames[i]);</span>
<span class="lineNum">    1109 </span><span class="lineCov">          7 :     if(!ifile.FieldExist(coeffs_pntrs_[i]-&gt;getDataLabel())){</span>
<span class="lineNum">    1110 </span><span class="lineNoCov">          0 :       std::string error_msg = &quot;Problem with reading coefficents from file &quot; + ifile.getPath() + &quot;: no field with name &quot; + coeffs_pntrs_[i]-&gt;getDataLabel() + &quot;\n&quot;;</span>
<span class="lineNum">    1111 </span><span class="lineNoCov">          0 :       plumed_merror(error_msg);</span>
<span class="lineNum">    1112 </span>            :     }
<span class="lineNum">    1113 </span><span class="lineCov">          7 :     size_t ncoeffs_read = coeffs_pntrs_[i]-&gt;readFromFile(ifile,false,false);</span>
<span class="lineNum">    1114 </span><span class="lineCov">          7 :     if(ncoeffssets_==1){</span>
<span class="lineNum">    1115 </span><span class="lineCov">          7 :       log.printf(&quot;%s (read %zu of %zu values)\n&quot;, ifile.getPath().c_str(),ncoeffs_read,coeffs_pntrs_[i]-&gt;numberOfCoeffs());</span>
<span class="lineNum">    1116 </span>            :     }
<span class="lineNum">    1117 </span>            :     else{
<span class="lineNum">    1118 </span><span class="lineNoCov">          0 :       log.printf(&quot;   coefficent set %u: %s (read %zu of %zu values)\n&quot;,i,ifile.getPath().c_str(),ncoeffs_read,coeffs_pntrs_[i]-&gt;numberOfCoeffs());</span>
<span class="lineNum">    1119 </span>            :     }
<span class="lineNum">    1120 </span><span class="lineCov">          7 :     ifile.close();</span>
<span class="lineNum">    1121 </span><span class="lineCov">          7 :     if(read_aux_coeffs){</span>
<span class="lineNum">    1122 </span><span class="lineCov">          7 :       ifile.open(fnames[i]);</span>
<span class="lineNum">    1123 </span><span class="lineCov">          7 :       if(!ifile.FieldExist(aux_coeffs_pntrs_[i]-&gt;getDataLabel())){</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :         std::string error_msg = &quot;Problem with reading coefficents from file &quot; + ifile.getPath() + &quot;: no field with name &quot; + aux_coeffs_pntrs_[i]-&gt;getDataLabel() + &quot;\n&quot;;</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :         plumed_merror(error_msg);</span>
<span class="lineNum">    1126 </span>            :       }
<span class="lineNum">    1127 </span><span class="lineCov">          7 :       aux_coeffs_pntrs_[i]-&gt;readFromFile(ifile,false,false);</span>
<span class="lineNum">    1128 </span><span class="lineCov">          7 :       ifile.close();</span>
<span class="lineNum">    1129 </span>            :     }
<span class="lineNum">    1130 </span>            :     else{
<span class="lineNum">    1131 </span><span class="lineNoCov">          0 :       AuxCoeffs(i).setValues( Coeffs(i) );</span>
<span class="lineNum">    1132 </span>            :     }
<span class="lineNum">    1133 </span><span class="lineCov">          7 :   }</span>
<span class="lineNum">    1134 </span><span class="lineCov">          7 : }</span>
<a name="1135"><span class="lineNum">    1135 </span>            : </a>
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineCov">         46 : void Optimizer::addCoeffsSetIDsToFilenames(std::vector&lt;std::string&gt;&amp; fnames, std::string&amp; coeffssetid_prefix) {</span>
<span class="lineNum">    1138 </span><span class="lineCov">         92 :   if(ncoeffssets_==1){return;}</span>
<span class="lineNum">    1139 </span>            :   //
<span class="lineNum">    1140 </span><span class="lineNoCov">          0 :   if(fnames.size()==1){</span>
<span class="lineNum">    1141 </span><span class="lineNoCov">          0 :     fnames.resize(ncoeffssets_,fnames[0]);</span>
<span class="lineNum">    1142 </span>            :   }
<span class="lineNum">    1143 </span><span class="lineNoCov">          0 :   plumed_assert(fnames.size()==ncoeffssets_);</span>
<span class="lineNum">    1144 </span>            :   //
<span class="lineNum">    1145 </span><span class="lineNoCov">          0 :   for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">    1146 </span><span class="lineNoCov">          0 :     std::string is=&quot;&quot;; Tools::convert(i,is);</span>
<span class="lineNum">    1147 </span><span class="lineNoCov">          0 :     fnames[i] = FileBase::appendSuffix(fnames[i],&quot;.&quot;+coeffssetid_prefix_+is);</span>
<span class="lineNum">    1148 </span><span class="lineNoCov">          0 :   }</span>
<span class="lineNum">    1149 </span>            : }
<a name="1150"><span class="lineNum">    1150 </span>            : </a>
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span><span class="lineCov">         54 : void Optimizer::setAllCoeffsSetIterationCounters(){</span>
<span class="lineNum">    1153 </span><span class="lineCov">        108 :   for(unsigned int i=0; i&lt;ncoeffssets_; i++){</span>
<span class="lineNum">    1154 </span><span class="lineCov">         54 :     coeffs_pntrs_[i]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">    1155 </span><span class="lineCov">         54 :     aux_coeffs_pntrs_[i]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">    1156 </span><span class="lineCov">         54 :     gradient_pntrs_[i]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">    1157 </span><span class="lineCov">         54 :     targetdist_averages_pntrs_[i]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">    1158 </span><span class="lineCov">         54 :     if(use_hessian_){</span>
<span class="lineNum">    1159 </span><span class="lineNoCov">          0 :       hessian_pntrs_[i]-&gt;setIterationCounterAndTime(getIterationCounter(),getTime());</span>
<span class="lineNum">    1160 </span>            :     }
<span class="lineNum">    1161 </span>            :   }
<span class="lineNum">    1162 </span><span class="lineCov">         54 : }</span>
<a name="1163"><span class="lineNum">    1163 </span>            : </a>
<span class="lineNum">    1164 </span>            : 
<span class="lineNum">    1165 </span><span class="lineCov">         50 : void Optimizer::writeBiasOutputFiles() const {</span>
<span class="lineNum">    1166 </span><span class="lineCov">        100 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">    1167 </span><span class="lineCov">         50 :     bias_pntrs_[i]-&gt;writeBiasToFile();</span>
<span class="lineNum">    1168 </span>            :   }
<span class="lineNum">    1169 </span><span class="lineCov">         50 : }</span>
<a name="1170"><span class="lineNum">    1170 </span>            : </a>
<span class="lineNum">    1171 </span>            : 
<span class="lineNum">    1172 </span><span class="lineCov">         50 : void Optimizer::writeFesOutputFiles() const {</span>
<span class="lineNum">    1173 </span><span class="lineCov">        100 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">    1174 </span><span class="lineCov">         50 :     bias_pntrs_[i]-&gt;writeFesToFile();</span>
<span class="lineNum">    1175 </span>            :   }
<span class="lineNum">    1176 </span><span class="lineCov">         50 : }</span>
<a name="1177"><span class="lineNum">    1177 </span>            : </a>
<span class="lineNum">    1178 </span>            : 
<span class="lineNum">    1179 </span><span class="lineCov">          8 : void Optimizer::writeFesProjOutputFiles() const {</span>
<span class="lineNum">    1180 </span><span class="lineCov">         16 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">    1181 </span><span class="lineCov">          8 :     bias_pntrs_[i]-&gt;writeFesProjToFile();</span>
<span class="lineNum">    1182 </span>            :   }
<span class="lineNum">    1183 </span><span class="lineCov">          8 : }</span>
<a name="1184"><span class="lineNum">    1184 </span>            : </a>
<span class="lineNum">    1185 </span>            : 
<span class="lineNum">    1186 </span><span class="lineCov">         26 : void Optimizer::writeTargetDistOutputFiles() const {</span>
<span class="lineNum">    1187 </span><span class="lineCov">         52 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">    1188 </span><span class="lineCov">         26 :     if(dynamic_targetdists_[i]){</span>
<span class="lineNum">    1189 </span><span class="lineCov">         26 :       bias_pntrs_[i]-&gt;writeTargetDistToFile();</span>
<span class="lineNum">    1190 </span>            :     }
<span class="lineNum">    1191 </span>            :   }
<span class="lineNum">    1192 </span><span class="lineCov">         26 : }</span>
<a name="1193"><span class="lineNum">    1193 </span>            : </a>
<span class="lineNum">    1194 </span>            : 
<span class="lineNum">    1195 </span><span class="lineCov">          2 : void Optimizer::writeTargetDistProjOutputFiles() const {</span>
<span class="lineNum">    1196 </span><span class="lineCov">          4 :   for(unsigned int i=0; i&lt;nbiases_; i++){</span>
<span class="lineNum">    1197 </span><span class="lineCov">          2 :     if(dynamic_targetdists_[i]){</span>
<span class="lineNum">    1198 </span><span class="lineCov">          2 :       bias_pntrs_[i]-&gt;writeTargetDistProjToFile();</span>
<span class="lineNum">    1199 </span>            :     }
<span class="lineNum">    1200 </span>            :   }
<span class="lineNum">    1201 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    1202 </span>            : 
<span class="lineNum">    1203 </span>            : 
<a name="1204"><span class="lineNum">    1204 </span>            : </a>
<span class="lineNum">    1205 </span>            : }
<span class="lineNum">    1206 </span><span class="lineCov">       4014 : }</span>
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.10</a></td></tr>
  </table>
  <br>

</body>
</html>
